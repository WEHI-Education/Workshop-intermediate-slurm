<!DOCTYPE html>
<!-- START: inst/pkgdown/templates/layout.html --><!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<title>Intermediate Slurm: All in One View</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" type="text/css" href="assets/styles.css">
<script src="assets/scripts.js" type="text/javascript"></script><!-- mathjax --><script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      config: ["MMLorHTML.js"],
      jax: ["input/TeX","input/MathML","output/HTML-CSS","output/NativeMML", "output/PreviewHTML"],
      extensions: ["tex2jax.js","mml2jax.js","MathMenu.js","MathZoom.js", "fast-preview.js", "AssistiveMML.js", "a11y/accessibility-menu.js"],
      TeX: {
        extensions: ["AMSmath.js","AMSsymbols.js","noErrors.js","noUndefined.js"]
      },
      tex2jax: {
        inlineMath: [ ['$','$'], ['\\(', '\\)']],
        displayMath: [ ['$$','$$'], ['\\[', '\\]'] ],
        processEscapes: true
      }
    });
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><!-- Responsive Favicon for The Carpentries --><link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
<link rel="manifest" href="site.webmanifest">
<link rel="mask-icon" href="safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">
</head>
<body>
    <header id="top" class="navbar navbar-expand-md navbar-light bg-white top-nav incubator"><a class="visually-hidden-focusable skip-link" href="#main-content">Skip to main content</a>
  <div class="container-fluid top-nav-container">
    <div class="col-md-6">
      <div class="large-logo">
        <img alt="Carpentries Incubator" src="assets/images/incubator-logo.svg"><abbr class="icon" title="This lesson is in the pre-alpha phase, which means that it is in early development, but has not yet been taught." style="text-decoration: unset">
           
          <a href="https://cdh.carpentries.org/the-lesson-life-cycle.html#early-development-pre-alpha-through-alpha" class="external-link alert-link" style="color: #383838">Pre-Alpha
            <i aria-hidden="true" class="icon" data-feather="alert-octagon" style="color: #FF4955; border-radius: 5px"></i>
          </a>
          <span class="visually-hidden">This lesson is in the pre-alpha phase, which means that it is in early development, but has not yet been taught.</span>
        </abbr>
        
      </div>
    </div>
    <div class="selector-container ">
      
      
      <div class="dropdown">
        <button class="btn btn-secondary dropdown-toggle bordered-button" type="button" id="dropdownMenu1" data-bs-toggle="dropdown" aria-expanded="false">
          <i aria-hidden="true" class="icon" data-feather="eye"></i> Learner View <i data-feather="chevron-down"></i>
        </button>
        <ul class="dropdown-menu" aria-labelledby="dropdownMenu1">
<li><button class="dropdown-item" type="button" onclick="window.location.href='instructor/aio.html';">Instructor View</button></li>
        </ul>
</div>
    </div>
  </div>
  <hr></header><nav class="navbar navbar-expand-xl navbar-light bg-white bottom-nav incubator" aria-label="Main Navigation"><div class="container-fluid nav-container">
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
      <span class="menu-title">Menu</span>
    </button>
    <div class="nav-logo">
      <img class="small-logo" alt="Carpentries Incubator" src="assets/images/incubator-logo-sm.svg">
</div>
    <div class="lesson-title-md">
      Intermediate Slurm
    </div>
    <div class="search-icon-sm">
      <!-- TODO: do not show until we have search
      <i role="img" aria-label="search button" data-feather="search"></i>
      -->
    </div>
    <div class="desktop-nav">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
<li class="nav-item">
          <span class="lesson-title">
            Intermediate Slurm
          </span>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="key-points.html">Key Points</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="reference.html#glossary">Glossary</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="profiles.html">Learner Profiles</a>
        </li>
        <li class="nav-item dropdown">
          <button class="nav-link dropdown-toggle" id="navbarDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            More <i data-feather="chevron-down"></i>
          </button>
          <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
<li><a class="dropdown-item" href="reference.html">Reference</a></li>
          </ul>
</li>
      </ul>
</div>
    <form class="d-flex col-md-2 search-form">
      <fieldset disabled>
<input class="form-control me-2 searchbox" type="search" placeholder="Search" aria-label="Search"><button class="btn btn-outline-success tablet-search-button" type="submit">
          <i class="search-icon" data-feather="search" role="img" aria-label="search button"></i>
        </button>
      </fieldset>
</form>
  </div>
<!--/div.container-fluid -->
</nav><div class="col-md-12 mobile-title">
  Intermediate Slurm
</div>

<aside class="col-md-12 lesson-progress"><div style="width: %" class="percentage">
    %
  </div>
  <div class="progress incubator">
    <div class="progress-bar incubator" role="progressbar" style="width: %" aria-valuenow="" aria-label="Lesson Progress" aria-valuemin="0" aria-valuemax="100">
    </div>
  </div>
</aside><div class="container">
      <div class="row">
        <!-- START: inst/pkgdown/templates/navbar.html -->
  <div id="sidebar-col" class="col-lg-4">
    <div id="sidebar" class="sidebar">
      <nav aria-labelledby="flush-headingEleven"><button role="button" aria-label="close menu" alt="close menu" aria-expanded="true" aria-controls="sidebar" class="collapse-toggle"><i class="search-icon" data-feather="x" role="img"></i></button>
        <div class="sidebar-inner">
          <div class="row mobile-row">
            <div class="col">
              <div class="sidenav-view-selector">
                <div class="accordion accordion-flush" id="accordionFlush9">
                  <div class="accordion-item">
                    <h2 class="accordion-header" id="flush-headingNine">
                      <button class="accordion-button collapsed" id="instructor" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseNine" aria-expanded="false" aria-controls="flush-collapseNine">
                        <i id="eye" aria-hidden="true" class="icon" data-feather="eye"></i> Learner View
                      </button>
                    </h2>
                    <div id="flush-collapseNine" class="accordion-collapse collapse" aria-labelledby="flush-headingNine" data-bs-parent="#accordionFlush2">
                      <div class="accordion-body">
                        <a href="instructor/aio.html">Instructor View</a>
                      </div>
                    </div>
                  </div>
<!--/div.accordion-item-->
                </div>
<!--/div.accordion-flush-->
              </div>
<!--div.sidenav-view-selector -->
            </div>
<!--/div.col -->
      
            <hr>
</div>
<!--/div.mobile-row -->

          <div class="accordion accordion-flush" id="accordionFlush11">
            <div class="accordion-item">

              <button id="chapters" class="accordion-button show" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseEleven" aria-expanded="false" aria-controls="flush-collapseEleven">
                <h2 class="accordion-header chapters" id="flush-headingEleven">
                  EPISODES
                </h2>
              </button>
              <div id="flush-collapseEleven" class="accordion-collapse show collapse" aria-labelledby="flush-headingEleven" data-bs-parent="#accordionFlush11">

                <div class="accordion-body">
                  <div class="accordion accordion-flush" id="accordionFlush1">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading1">
        <a href="index.html">Summary and Setup</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush2">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading2">
        <a href="01-introduction.html">1. Introduction</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush3">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading3">
        <a href="02-cpumonitoring.html">2. Monitoring a Jobs performance</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush4">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading4">
        <a href="03-moremonitoring.html">3. Memory and GPU utilization</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush5">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading5">
        <a href="04-jobarrays.html">4. Job Arrays</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush6">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading6">
        <a href="05-jobdependencies.html">5. Organising dependent Slurm jobs</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush7">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading7">
        <a href="06-rpython.html">6. R and Python Slurm scripts</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

                </div>
              </div>
            </div>

            <hr class="half-width">
<div class="accordion accordion-flush resources" id="accordionFlush12">
              <div class="accordion-item">
                <h2 class="accordion-header" id="flush-headingTwelve">
                  <button class="accordion-button collapsed" id="resources" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseTwelve" aria-expanded="false" aria-controls="flush-collapseTwelve">
                    RESOURCES
                  </button>
                </h2>
                <div id="flush-collapseTwelve" class="accordion-collapse collapse" aria-labelledby="flush-headingTwelve" data-bs-parent="#accordionFlush12">
                  <div class="accordion-body">
                    <ul>
<li>
                        <a href="key-points.html">Key Points</a>
                      </li>
                      <li>
                        <a href="reference.html#glossary">Glossary</a>
                      </li>
                      <li>
                        <a href="profiles.html">Learner Profiles</a>
                      </li>
                      <li><a href="reference.html">Reference</a></li>
                    </ul>
</div>
                </div>
              </div>
            </div>
            <hr class="half-width resources">
<a href="aio.html">See all in one page</a>

            <hr class="d-none d-sm-block d-md-none">
<div class="d-grid gap-1">
            
            </div>
          </div>
<!-- /div.accordion -->
        </div>
<!-- /div.sidebar-inner -->
      </nav>
</div>
<!-- /div.sidebar -->
  </div>
<!-- /div.sidebar-col -->
<!-- END:   inst/pkgdown/templates/navbar.html-->

        <!-- START: inst/pkgdown/templates/content-extra.html -->
  <div class="col-xl-8 col-lg-12 primary-content">
    <main id="main-content" class="main-content"><div class="container lesson-content">
        
        
<section id="aio-01-introduction"><p>Content from <a href="01-introduction.html">Introduction</a></p>
<hr>
<p> Last updated on 2023-07-11 | 
        
        <a href="https://github.com/WEHI-ResearchComputing/intermediate-slurm/edit/main/episodes/01-introduction.Rmd" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right"> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>Why should I learn to monitor performance of my Slurm jobs?</li>
<li>What other features of Slurm can I use to help with my
workflows?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Understand why jobs should be monitored carefully.</li>
<li>Understand how Slurm’s additional features can alleviate pain
points.</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<section id="a-common-story"><h2 class="section-heading">A Common Story<a class="anchor" aria-label="anchor" href="#a-common-story"></a>
</h2>
<hr class="half-width">
<p>Imagine you’re a researcher who has spent a good chunk of their time
in research in the lab, or you’re a researcher who <em>does</em> do a
fair amount of computational research, but you’ve only been using laptop
so far. And one day, you join a new project that suddenly has a HUGE
amount of data to process - an amount that would take your laptop
<em>years</em> to get through!</p>
<p>Your PI has suggested that you give WEHI’s Milton HPC facility a go.
Milton has thousands of CPU cores, petabytes of storage, and terrabytes
of RAM to use! That would make processing this huge dataset a
breeze!</p>
<p>Since that suggestion, you’ve attended some introductory courses and
maybe you’ve found other researchers who know a bit about using Milton,
and you’ve managed to get started with using the Slurm scheduler and
submitting jobs.</p>
<p>But up until now, you’ve just been doing things in ways that
<em>works</em>, but you might be wondering whether yours jobs are setup
to run optimally. Maybe you’ve received emails from grumpy sysadmins
about inappropriately using resources. Or maybe you want to know how to
make it easier to more easily submit many similar jobs or jobs that
depend on each other.</p>
<div id="how-would-you-do-it" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div id="how-would-you-do-it" class="callout-inner">
<h3 class="callout-title">How would you do it?<a class="anchor" aria-label="anchor" href="#how-would-you-do-it"></a>
</h3>
<div class="callout-content">
<p>Let’s imagine you have hundreds of files that you need to run the
same command on. You know that Slurm can process that all in parallel,
so how would you go about submitting those jobs at first?</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1">
  Show me the solution
  </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" aria-labelledby="headingSolution1" data-bs-parent="#accordionSolution1">
<div class="accordion-body">
<p>If you’re new to Linux, you might’ve thought about submitting these
jobs manually! If you’ve done a bit of scripting, you might’ve thought
to use script arguments and a for loop to submit all the jobs. This
<em>works</em>, but Slurm also has <strong>job arrays</strong>! As we’ll
see in a later episode, job arrays are a Slurm feature that can help you
submit many similar jobs in one go!</p>
</div>
</div>
</div>
</div>
<div id="how-would-you-do-it-1" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div id="how-would-you-do-it-1" class="callout-inner">
<h3 class="callout-title">How would you do it?<a class="anchor" aria-label="anchor" href="#how-would-you-do-it-1"></a>
</h3>
<div class="callout-content">
<p>What about workflows that happen in steps and where these steps have
different resource requirements? Like for example, one step is
multi-threaded, so the job should request many CPUs; but the next step
is single-threaded only?</p>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2">
  Show me the solution
  </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" aria-labelledby="headingSolution2" data-bs-parent="#accordionSolution2">
<div class="accordion-body">
<p>If the second step is short, you might put the two steps into a
single Slurm job. But what if the second step takes a large amount of
time? Putting these two steps in the same job, could unfairly occupy
resources others could use!</p>
<p>You might also do this manually i.e., wait for the first step to
finish, and then submit the second job afterward.</p>
<p>Slurm also has job dependency features that you can take advantage of
to help with pipelines. We’ll cover this in a future episode!</p>
</div>
</div>
</div>
</div>

<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Keypoints<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul>
<li>Slurm, together with Linux system tools, can help you ensure jobs
are utilizing resources effectively.</li>
<li>Slurm job arrays is a neater solution to submitting many similar
jobs.</li>
<li>Slurm job dependencies can help you organise pipelines.</li>
</ul>
</div>
</div>
</div>
<!-- 
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use. 
 -->
</section></section><section id="aio-02-cpumonitoring"><p>Content from <a href="02-cpumonitoring.html">Monitoring a Jobs performance</a></p>
<hr>
<p> Last updated on 2023-07-11 | 
        
        <a href="https://github.com/WEHI-ResearchComputing/intermediate-slurm/edit/main/episodes/02-cpumonitoring.Rmd" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right"> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>Why should I learn to monitor performance of my Slurm jobs?</li>
<li>Which tools can I use to monitor my jobs’ activity?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Understand why jobs should be monitored carefully.</li>
<li>Show common tools to use to monitor jobs’ activity and
performance.</li>
<li>Demonstrate a general procedure to investigate why a job may not be
performing as expected.</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<section id="calculating-pi"><h2 class="section-heading">Calculating <span class="math inline">\(\pi\)</span><a class="anchor" aria-label="anchor" href="#calculating-pi"></a>
</h2>
<hr class="half-width">
<p>You’re an honours student and your project is looking at ways of
calculating <span class="math inline">\(\pi\)</span>. Your PI has
recommended using an existing piece of software he saw someone talk
about at a conference recently. A useful feature is that it works in
parallel, and is consequently quite fast! You try running the program on
your laptop, and it takes about 1.2 seconds for each calculation of
<span class="math inline">\(\pi\)</span>. This is a little slow, so you
try running it on Milton</p>
<div id="running-the-program" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div id="running-the-program" class="callout-inner">
<h3 class="callout-title">Running the Program<a class="anchor" aria-label="anchor" href="#running-the-program"></a>
</h3>
<div class="callout-content">
<p>In the example-programs.zip file, is the <code>pi-cpu</code>
executable. This is the program your supervisor has recommended.
<strong>Try running it with <code>srun</code> on Milton!</strong> Does
it perform each calculation of <span class="math inline">\(\pi\)</span>
in less time than 1.2s?</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1">
  Show me the solution
  </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" aria-labelledby="headingSolution1" data-bs-parent="#accordionSolution1">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">srun</span> pi-cpu</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>srun: job 11087600 queued and waiting for resources
srun: job 11087600 has been allocated resources
Result: 3.1414796637875 Error: -0.0001130772251 Time: 3.0970s
Result: 3.1417489401899 Error:  0.0001561991773 Time: 3.0912s
Result: 3.1415377569880 Error: -0.0000549840246 Time: 3.1001s
...</code></pre>
</div>
<p>Each calculation of <span class="math inline">\(\pi\)</span> takes
about 3 seconds - <em>slower</em> than your laptop! This is something to
remember about HPC: The main reason why HPC is “faster” is because it
has <em>many</em> CPU cores, but the cores working individually are
probably slower than your PC’s CPU cores. HPC’s usefulness comes from
hundreds or thousands of CPU cores working in parallel!</p>
</div>
</div>
</div>
</div>
<p>You tell your supervisor that HPC isn’t helping! But they assure you
that it should be really fast - the presenter at the conference
demonstrated times way less than 3 seconds!</p>
<p>Your job now is to figure out why <code>pi-cpu</code> isn’t
performing fast for you.</p>
</section><section id="check-1-is-it-really-working-in-parallel"><h2 class="section-heading">Check 1: Is it really working in parallel?<a class="anchor" aria-label="anchor" href="#check-1-is-it-really-working-in-parallel"></a>
</h2>
<hr class="half-width">
<p>So far, we’ve only <em>heard</em> that the software works by
performing computations in parallel with multiple CPUs. One way we can
verify this is with the <code>htop</code> tool.</p>
<p><code>htop</code> is an interactive “process” viewer that lets you
monitor processes across the entire node. It’s very similar to Task
Manager on Windows or Activity Monitor on Macs, but it works from the
command line!</p>
<div class="section level3">
<h3 id="interpreting-htops-output">Interpreting <code>htop</code>’s output<a class="anchor" aria-label="anchor" href="#interpreting-htops-output"></a>
</h3>
<p>Try running <code>htop</code> on the login node. You should get
something similar to below:</p>
<figure><img src="fig/htop-screenshot.png" alt="" class="figure mx-auto d-block"><figcaption>Screenshot of <code>htop</code> output</figcaption></figure><p><code>htop</code> gives a lot of information, so here is a quick
explainer on what is being shown.</p>
<p>At the top of the <code>htop</code> output, you’ll see multiple bars
and each bar tells you the activity level of a single CPU core. If a bar
is at 100%, then that means that that CPU core is completely busy.</p>
<figure><img src="fig/htop-screenshot-cpubars.png" alt="" class="figure mx-auto d-block"><figcaption>CPU utilization bars from <code>htop</code></figcaption></figure><p>Below the bar, on the left side, is another bar which tells you how
much of the node’s memory is occupied. Next to the bar is information
about how much load the node is under.</p>
<figure><img src="fig/htop-screenshot-memload.png" alt="" class="figure mx-auto d-block"><figcaption>Memory utilization bars and load from
<code>htop</code></figcaption></figure><p>Everything below that is most important to monitoring your jobs. That
table is a dynamic list of “processes” running on the node. And each
column tells you a bit of different information about the process.</p>
<figure><img src="fig/htop-screenshot-procs.png" alt="" class="figure mx-auto d-block"><figcaption>Process list and fields from <code>htop</code></figcaption></figure><ol style="list-style-type: decimal">
<li>
<code>RES</code> tells you the “resident” memory of the process,
i.e., the memory (in bytes) being used by the process.</li>
<li>
<code>CPU%</code> is the percentage of a CPU core the process is
using.</li>
<li>
<code>Command</code> is telling you the command the process is
running. This can be used to help you figure out which processes are
related to your job.</li>
</ol>
<p>By default, <code>htop</code> will show you <em>everyone’s</em>
processes, which is not relevant to us. To get only your processes, quit
<code>htop</code> by pressing <code>q</code>, and run it again with</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">htop</span> <span class="at">-u</span> <span class="va">$USER</span></span></code></pre>
</div>
<p>You should see a list of processes that belong to you only!</p>
</div>
<div class="section level3">
<h3 id="monitoring-pi-cpu-with-htop">Monitoring <code>pi-cpu</code> with <code>htop</code>
<a class="anchor" aria-label="anchor" href="#monitoring-pi-cpu-with-htop"></a>
</h3>
<p>This time, we’re going to submit the <code>pi-cpu</code> command as a
job with <code>sbatch</code>. We’re also going to add the
<code>-r -1</code> flag and value, so that the program will run
indefinitely. We can do so by</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ex">sbatch</span> <span class="at">--wrap</span><span class="op">=</span><span class="st">"srun ./pi-cpu -r -1"</span></span></code></pre>
</div>

<div id="sbatch---wrap" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div id="sbatch---wrap" class="callout-inner">
<h3 class="callout-title">
<code>sbatch --wrap</code><a class="anchor" aria-label="anchor" href="#sbatch---wrap"></a>
</h3>
<div class="callout-content">
<p>the <code>--wrap</code> option lets us pass a singular command to
<code>sbatch</code> without having to write an entire script! This is
useful for debugging and when you run <code>sbatch</code> inside
scripts.</p>
</div>
</div>
</div>
<p>Once you’ve confirmed the job has started with <code>squeue</code>,
and determined which node it’s running on, <code>ssh</code> to that node
and run <code>htop -u $USER</code>.</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ex">sbatch</span> <span class="at">--wrap</span><span class="op">=</span><span class="st">"srun ./pi-cpu -r -1"</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Submitted batch job 11088927</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ex">squeue</span> <span class="at">-u</span> <span class="va">$USER</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>     JOBID PARTITION     NAME     USER ST       TIME  NODES NODELIST(REASON)
  11088927   regular     wrap   yang.e  R       0:12      1 sml-n15</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ssh</span> sml-n15</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>yang.e@sml-n15s password: # enter your password
Last login: Fri Apr 14 14:40:38 2023 from slurm-login.hpc.wehi.edu.au</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="ex">htop</span> <span class="at">-u</span> <span class="va">$USER</span></span></code></pre>
</div>
<figure><img src="fig/htop-picpu-1.png" alt="" class="figure mx-auto d-block"><figcaption>processes associated with <code>pi-cpu</code></figcaption></figure><p>From the <code>Command</code> column, you can find the relevant data
for your job.</p>
<p>Hint: You can click on <code>CPU%</code> to sort processes by their
CPU usage.</p>

<p>If we look at the <code>CPU%</code> column, we can see that the
<code>pi-cpu</code> process is using 100%! That might sound good, but
the percentage is the percentage of a CPU <em>core</em> being used,
i.e., 100% means that 100% of a single CPU core is being used, or 200%
means 100% of two CPU core are being used. So, the <code>pi-cpu</code>
process is only using 1 CPU core i.e., not parallel! This is not what
your PI promised!</p>
<p>But maybe it’s because we didn’t request more CPUs? We didn’t ask for
any specific number of CPUs in our command after all. Let’s try request
4 CPUs instead. But first, let’s cancel the already running job.</p>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="ex">scancel</span> 11088927</span></code></pre>
</div>
<p>And then we can try again, but with more CPUs:</p>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="ex">sbatch</span> <span class="at">--cpus-per-task</span><span class="op">=</span>4 <span class="at">--wrap</span><span class="op">=</span><span class="st">"srun ./pi-cpu -r -1"</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Submitted batch job 11089020</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="ex">squeue</span> <span class="at">-u</span> <span class="va">$USER</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>   JOBID PARTITION     NAME     USER ST       TIME  NODES NODELIST(REASON)
11089020   regular     wrap   yang.e  R       0:12      1 sml-n15</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb17">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ssh</span> sml-n15</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>yang.e@sml-n15s password: # enter your password
Last login: Fri Apr 14 14:40:38 2023 from slurm-login.hpc.wehi.edu.au</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb19">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="ex">htop</span> <span class="at">-u</span> <span class="va">$USER</span></span></code></pre>
</div>
<figure><img src="fig/htop-picpu-2.png" alt="" class="figure mx-auto d-block"><figcaption>processes associated with <code>pi-cpu</code> after
requesting more CPUs from Slurm</figcaption></figure><p>Unfortunately, the <code>pi-cpu</code> program is still only using
100% - requesting more CPUs from Slurm didn’t help your job work in
parallel.</p>
<p>Now, this job runs forever, so we should cancel it and move on.</p>
<div class="codewrapper sourceCode" id="cb20">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="ex">scancel</span> 11089020</span></code></pre>
</div>
<div id="job-summary-with-seff" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div id="job-summary-with-seff" class="callout-inner">
<h3 class="callout-title">Job summary with <code>seff</code><a class="anchor" aria-label="anchor" href="#job-summary-with-seff"></a>
</h3>
<div class="callout-content">
<p>Now that the job is over, try verifying the efficiency of the job
with <code>seff</code>. What is the CPU Efficiency (%) that the
<code>pi-cpu</code> program achieved?</p>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2">
  Show me the solution
  </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" aria-labelledby="headingSolution2" data-bs-parent="#accordionSolution2">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb21">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="ex">seff</span> 11089020</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Job ID: 11089020
Cluster: milton
User/Group: yang.e/allstaff
State: CANCELLED (exit code 0)
Nodes: 1
Cores per node: 4
CPU Utilized: 00:02:11
CPU Efficiency: 25.00% of 00:08:44 core-walltime
Job Wall-clock time: 00:02:11
Memory Utilized: 4.44 MB
Memory Efficiency: 11.10% of 40.00 MB</code></pre>
</div>
<p>In this scenario, you’re interested in the
<code>CPU Efficiency</code> field, which gives a rough indication of the
total CPU cores requested being used. This is different from
<code>htop</code>, where the percentage represents the utilization of a
single CPU core.</p>
<p>But as well as CPUs, jobs need to select an amount of memory to
request. <code>seff</code> can help tune this value with the
<code>Memory Utilized</code> field, which will tell you the maximum
memory used of your job. The <code>Memoy Efficiency</code> percentage is
also useful to help you choose an appropriate memory to request.</p>
<p><code>pi-cpu</code> turns out to be very lightweight, so doesn’t use
much memory at all! When we run it inside a Slurm job without any
options, it comfortably fits within the default memory (for Milton, this
is 10MB).</p>
</div>
</div>
</div>
</div>
</div>
</section><section id="looking-through-help-and-documentation"><h2 class="section-heading">Looking through help and documentation<a class="anchor" aria-label="anchor" href="#looking-through-help-and-documentation"></a>
</h2>
<hr class="half-width">
<div id="discussion4" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge<a class="anchor" aria-label="anchor" href="#discussion4"></a>
</h3>
<div class="callout-content">
<p>Try running <code>pi-cpu</code> with the <code>--help</code> option.
Do you find any clues? See if you can run the <code>pi-cpu</code> in
parallel with 4 cores on Slurm!</p>
</div>
</div>
</div>
<div id="accordionSolution3" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution3" aria-expanded="false" aria-controls="collapseSolution3">
  <h4 class="accordion-header" id="headingSolution3">
  Show me the solution
  </h4>
</button>
<div id="collapseSolution3" class="accordion-collapse collapse" aria-labelledby="headingSolution3" data-bs-parent="#accordionSolution3">
<div class="accordion-body">
<p>Both the documentation and <code>--help</code> output would’ve shown
that the <code>-p &lt;N&gt;</code> option is needed to execute the code
with <code>N</code> number of cores.</p>
<p>So, to execute <code>pi-cpu</code> with 4 cores on Slurm, we can
issue the command</p>
<div class="codewrapper sourceCode" id="cb23">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="ex">srun</span> <span class="at">--cpus-per-task</span><span class="op">=</span>4 pi-cpu <span class="at">-p</span> 4 </span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>srun: job 11250525 queued and waiting for resources
srun: job 11250525 has been allocated resources
Result: 3.1418360637907 Error:  0.0002433227781 Time: 1.4548s
Result: 3.1416882225894 Error:  0.0000954815768 Time: 1.4527s
Result: 3.1415296893879 Error: -0.0000630516247 Time: 1.4512s
...</code></pre>
</div>
<p>which will send the output straight to the terminal. You will notice
that the reported times to calculate <code>pi-cpu</code> has more than
halved! We can confirm the utilization of the 4 CPUs we requested with
<code>seff</code>:</p>
<div class="codewrapper sourceCode" id="cb25">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="ex">seff</span> 11250525</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Job ID: 11250525
Cluster: milton
User/Group: yang.e/allstaff
State: CANCELLED (exit code 0)
Nodes: 2
Cores per node: 2
CPU Utilized: 00:02:47
CPU Efficiency: 97.09% of 00:02:52 core-walltime
Job Wall-clock time: 00:00:43
Memory Utilized: 9.56 MB (estimated maximum)
Memory Efficiency: 23.91% of 40.00 MB (10.00 MB/core)</code></pre>
</div>
<p>The CPU Efficiency is now pretty close to 100%!</p>
<p>Many programs behave like this: they will have parallel capability
built in, but will need to be switched on perhaps with a flag/option
like with <code>pi-cpu</code>. Sometimes it can also be switched on via
an environment variable.</p>
<p>Parallel programs are generally designed to run in this way so that
the parallel program doesn’t unintentionally use up all the resources on
the machine you’re running on.</p>
</div>
</div>
</div>
</div>

<div id="using-more-cpu-cores" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div id="using-more-cpu-cores" class="callout-inner">
<h3 class="callout-title">Using more CPU cores<a class="anchor" aria-label="anchor" href="#using-more-cpu-cores"></a>
</h3>
<div class="callout-content">
<p>You’re really determined to get the run-time down on this calculation
of <span class="math inline">\(\pi\)</span>! So, try request different
number of CPUs and see what happens with the time it takes to calculate
<span class="math inline">\(\pi\)</span>!</p>
<p>Hint: try 4, 8, and then 16 CPUs. Hint 2: You may wish to run with
<code>--constraint=Icelake</code> to ensure results are consistent!</p>
</div>
</div>
</div>
<div id="accordionSolution4" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution4" aria-expanded="false" aria-controls="collapseSolution4">
  <h4 class="accordion-header" id="headingSolution4">
  Show me the solution
  </h4>
</button>
<div id="collapseSolution4" class="accordion-collapse collapse" aria-labelledby="headingSolution4" data-bs-parent="#accordionSolution4">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb27">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="ex">srun</span> <span class="at">--cpus-per-task</span><span class="op">=</span>4 <span class="at">--constraint</span><span class="op">=</span>Icelake pi-cpu <span class="at">-p</span> 4</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>srun: job 11250526 queued and waiting for resources
srun: job 11250526 has been allocated resources
Result: 3.1414069905868 Error: -0.0001857504258 Time: 1.1907s
Result: 3.1416068013886 Error:  0.0000140603760 Time: 1.1880s
Result: 3.1415671113883 Error: -0.0000256296243 Time: 1.1880s
...</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb29">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="ex">srun</span> <span class="at">--cpus-per-task</span><span class="op">=</span>8 <span class="at">--constraint</span><span class="op">=</span>Icelake pi-cpu <span class="at">-p</span> 8</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>srun: job 11250527 queued and waiting for resources
srun: job 11250527 has been allocated resources
Result: 3.1416164241887 Error:  0.0000236831761 Time: 0.5980s
Result: 3.1414225749869 Error: -0.0001701660256 Time: 0.5975s
Result: 3.1417783593902 Error:  0.0001856183776 Time: 0.5978s   
...</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb31">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="ex">srun</span> <span class="at">--cpus-per-task</span><span class="op">=</span>16 <span class="at">--constraint</span><span class="op">=</span>Icelake pi-cpu <span class="at">-p</span> 16</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>srun: job 11250528 queued and waiting for resources
srun: job 11250528 has been allocated resources
Result: 3.1419777489920 Error:  0.0003850079794 Time: 0.3507s
Result: 3.1415083701877 Error: -0.0000843708248 Time: 0.3018s
Result: 3.1418214513906 Error:  0.0002287103780 Time: 0.3016s 
...</code></pre>
</div>
<p>If you’re running on Milton, you should see that 4 CPUs brings down
the time to 2 seconds, down from the original 6 seconds. Running with 8
CPUs brings the time down to approx. 1 second (approx 2 times speedup,
relative to 4 cores), and bringing it up to 16 speeds things up almost
twice again!</p>
<p>However, this isn’t always true of all programs. Often, adding twice
the number of cores doesn’t add twice the speed.</p>
<p>In many cases, the program’s documentation will offer some
suggestions on how to choose the right number of cores. You might even
find some advice from others e.g., blog posts or in forums. But if this
isn’t the case, you may need to perform some tests yourself!</p>
<p>For example, I run a program with two cores and I discover it’s 1.8
times faster than one core. I then run the same program but with 4 cores
and find that it’s only 2.5 times as fast compared to one core. We could
say that with two cores, the program has a “scaling efficiency” of 1.8/2
= 90% efficient. But, the four core case is 2.5/4 = 62.5% efficient.
This would tell us that running with two cores is <em>more
efficient</em>, and running with four cores is <em>less efficient</em>,
but <em>faster</em>.</p>
</div>
</div>
</div>
</div>
<div id="hyperthreading" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div id="hyperthreading" class="callout-inner">
<h3 class="callout-title">Hyperthreading<a class="anchor" aria-label="anchor" href="#hyperthreading"></a>
</h3>
<div class="callout-content">
<p>Do a rough calculation of the speedup efficiency of
<code>pi-cpu</code> from one core to two.</p>
<p>i.e.,</p>
<p><code>srun --constraint=Icelake pi-cpu -p 1</code></p>
<p>and then</p>
<p><code>srun --cpus-per-task=2 --constraint=Icelake pi-cpu -p 2</code></p>
<p>What do you get?</p>
<p>What happens if you run the two-core case again, but this time
requesting 4 cores from Slurm, but still using <code>-p 2</code>?</p>
</div>
</div>
</div>
<div id="accordionSolution5" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution5" aria-expanded="false" aria-controls="collapseSolution5">
  <h4 class="accordion-header" id="headingSolution5">
  Show me the solution
  </h4>
</button>
<div id="collapseSolution5" class="accordion-collapse collapse" aria-labelledby="headingSolution5" data-bs-parent="#accordionSolution5">
<div class="accordion-body">
<p>Comparing 1 CPU with 2 CPUs:</p>
<div class="codewrapper sourceCode" id="cb33">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="ex">srun</span> <span class="at">--constraint</span><span class="op">=</span>Icelake pi-cpu <span class="at">-p</span> 1</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>srun: job 11783722 queued and waiting for resources
srun: job 11783722 has been allocated resources
Result: 3.1419098061914 Error:  0.0003170651788 Time: 3.6352s
Result: 3.1415063289877 Error: -0.0000864120249 Time: 3.6363s
Result: 3.1416112401887 Error:  0.0000184991761 Time: 3.6349s
...</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb35">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="ex">srun</span> <span class="at">--cpus-per-task</span><span class="op">=</span>2 <span class="at">--constraint</span><span class="op">=</span>Icelake pi-cpu <span class="at">-p</span> 2</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>srun: job 11783726 queued and waiting for resources
srun: job 11783726 has been allocated resources
Result: 3.1416992061895 Error:  0.0001064651769 Time: 2.3672s
Result: 3.1415531793881 Error: -0.0000395616244 Time: 2.3669s
Result: 3.1416117585887 Error:  0.0000190175761 Time: 2.3668s
...</code></pre>
</div>
<p>This is approximately 3.64/(2.37*2) = 77% (the times you get may
vary). Unfortunately not as close to 100% as one might hope!</p>
<p>Requesting 4 CPUs from Slurm, but running
<code>pi-cpu -p 2</code>:</p>
<div class="codewrapper sourceCode" id="cb37">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="ex">srun</span> <span class="at">--cpus-per-task</span><span class="op">=</span>4 <span class="at">--constraint</span><span class="op">=</span>Icelake pi-cpu <span class="at">-p</span> 2</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>srun: job 11783729 queued and waiting for resources
srun: job 11783729 has been allocated resources
Result: 3.1413841485866 Error: -0.0002085924260 Time: 1.7224s
Result: 3.1414291845870 Error: -0.0001635564256 Time: 1.7210s
Result: 3.1414952805876 Error: -0.0000974604250 Time: 1.7257s 
...</code></pre>
</div>
<p>Which is now roughly 2.1 times faster than the one-core case! But why
the difference? In both cases, we requested <code>pi-cpu</code> to run
in parallel with 2 cores, right (through the <code>-p 2</code>
flag)?</p>
<p>This is because on Milton, hyperthreading is turned on, which is
often the case for modern CPUs. Milton’s Slurm is configured such that
when you request 1 CPU, you’re actually getting a hyperthread. For every
two hyperthreads, you get one physical CPU core.</p>
<p>So, when you execute <code>srun --cpus-per-task=2 pi-cpu -p 2</code>,
<code>pi-cpu -p 2</code> is actually executed on a single physical core.
But thanks to hyperthreading, you manage to get some speedup almost for
free! When you execute <code>srun --cpus-per-task=4 pi-cpu 2</code>,
<code>pi-cpu</code> is now running on two separate physical cores, hence
we see a speedup!</p>
<p>This is important to remember because if you forget about how Slurm
CPUs are equivalent to hyperthreads, rather than physical CPU cores,
programs that run in parallel might appear less efficient (like in the
case of <code>pi-cpu</code>!).</p>
<p>NOTE: this configuration is unique to Milton. Most other HPC
facilities equate Slurm CPUs to physical CPU cores, not
hyperthreads.</p>
</div>
</div>
</div>
</div>
<div id="using-multiple-nodes" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div id="using-multiple-nodes" class="callout-inner">
<h3 class="callout-title">Using multiple nodes<a class="anchor" aria-label="anchor" href="#using-multiple-nodes"></a>
</h3>
<div class="callout-content">
<p>You may already be aware of the fact that you can request
<em>multiple nodes</em> from Slurm. Maybe we can use multiple nodes to
speed up the calculation of <span class="math inline">\(\pi\)</span>
more! Let’s try and run <code>pi-cpu</code> on 2 nodes, with 2 CPUs per
node, which gives our job a total request of 4 CPUs. Remember to add the
constraint so we can compare the times to the previous tests!</p>
<p>We will submit this job using <code>srun</code>:</p>
<div class="codewrapper sourceCode" id="cb39">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="ex">srun</span> <span class="at">--nodes</span><span class="op">=</span>2 <span class="at">--cpus-per-task</span><span class="op">=</span>2 <span class="at">--constraint</span><span class="op">=</span>Icelake pi-cpu <span class="at">-p</span> 4 </span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>srun: job 11250605 queued and waiting for resources
srun: job 11250605 has been allocated resources
Result: 3.1414471989872 Error: -0.0001455420254 Time: 2.3712s
Result: 3.1417839645902 Error:  0.0001912235777 Time: 2.3745s
Result: 3.1416039501886 Error:  0.0000112091760 Time: 2.3709s
Result: 3.1415633529882 Error: -0.0000293880243 Time: 2.3729s
Result: 3.1415167617878 Error: -0.0000759792248 Time: 2.3712s
Result: 3.1415245053879 Error: -0.0000682356247 Time: 2.3709s
...</code></pre>
</div>
<p>So our job has started, but wait… The run times are <em>slower</em>
than our previous tests with 4 cores! You might also notice that two
lines with identical results are printed together every iteration.</p>
<p>Try and have a look in the <a href="https://github.com/WEHI-ResearchComputing/Workshop-intermediate-slurm/blob/main/episodes/data/pi-cpu.md" class="external-link">documentation</a>
again and see why that might be!</p>
</div>
</div>
</div>
<div id="accordionSolution6" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution6" aria-expanded="false" aria-controls="collapseSolution6">
  <h4 class="accordion-header" id="headingSolution6">
  Show me the solution
  </h4>
</button>
<div id="collapseSolution6" class="accordion-collapse collapse" aria-labelledby="headingSolution6" data-bs-parent="#accordionSolution6">
<div class="accordion-body">
<p>in the <a href="https://github.com/WEHI-ResearchComputing/Workshop-intermediate-slurm/blob/main/episodes/data/pi-cpu.md#multi-node--multi-threading" class="external-link">multi-node</a>
section, you will find that to run the program across nodes, you
will</p>
<ol style="list-style-type: decimal">
<li>need to use the <code>pi-cpu-mpi</code> program</li>
<li>use <code>srun</code> or <code>mpiexec</code> to execute the
program</li>
<li>ensure the value passed to the <code>-p</code> flag is the number of
CPUs per node.</li>
</ol>
<p>We’ve been using <code>srun</code> so far, so we only need to change
the program. We also need to change the number after
<code>-p</code>:</p>
<div class="codewrapper sourceCode" id="cb41">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="ex">srun</span> <span class="at">--nodes</span><span class="op">=</span>2 <span class="at">--cpus-per-task</span><span class="op">=</span>2 <span class="at">--constraint</span><span class="op">=</span>Icelake pi-cpu-mpi <span class="at">-p</span> 2 </span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>srun: job 11250610 queued and waiting for resources
srun: job 11250610 has been allocated resources
Result: 3.1414385805871 Error: -0.0001541604255 Time: 1.2036s
Result: 3.1417610577900 Error:  0.0001683167775 Time: 1.2036s
Result: 3.1415069445877 Error: -0.0000857964249 Time: 1.2029s 
...</code></pre>
</div>
<p>And we can see that the program is now calculating <span class="math inline">\(\pi\)</span> in approximately the same time as the
single-node 4-core example before.</p>
<p>This is because <em>programs are generally unable to work across
nodes by default</em>. They typically require some other framework, with
special instructions on how to run the software. This will often be
explained in the documentation.</p>
<p>Message Passing Interface (MPI) is common in scientific computing -
particularly when it comes to simulation like for Molecular Dynamics and
<em>distributed</em> machine learning (e.g., PyTorch), but other
distributed computing frameworks exist, like Spark + Hadoop.</p>
</div>
</div>
</div>
</div>

<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Keypoints<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul>
<li>Requesting more resources from Slurm doesn’t mean your job knows how
to use them!
<ul>
<li>Many programs don’t work in parallel by default - either that
functionality doesn’t exist, or needs to be turned on!</li>
<li>Parallelism across nodes is different from parallelism within nodes.
You usually need to run them a little differently than a normal
program</li>
</ul>
</li>
<li>The <code>htop</code> system tool is a great way to get live
information about how effective your job is</li>
<li>
<code>seff</code> can be used to get summary stats about jobs</li>
<li>More CPUs doesn’t always mean an equivalent speedup!</li>
</ul>
</div>
</div>
</div>
<!-- 
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use. 
 -->
</section></section><section id="aio-03-moremonitoring"><p>Content from <a href="03-moremonitoring.html">Memory and GPU utilization</a></p>
<hr>
<p> Last updated on 2023-07-11 | 
        
        <a href="https://github.com/WEHI-ResearchComputing/intermediate-slurm/edit/main/episodes/03-moremonitoring.Rmd" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right"> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How do I track how much memory my jobs are using?</li>
<li>How do I select an appropriate memory value for my Slurm job?</li>
<li>How can I monitor performance of jobs that use GPUs?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Learn how to use <code>htop</code>, <code>seff</code>, and
<code>sacct</code> to view memory usage</li>
<li>Learn how to use <code>nvidia-smi</code>, <code>nvtop</code>, and
<code>dcgmstats</code> to query GPU activity</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<section id="investigating-other-implementations-of-the-pi-algorithm"><h2 class="section-heading">Investigating other implementations of the <span class="math inline">\(\pi\)</span> algorithm<a class="anchor" aria-label="anchor" href="#investigating-other-implementations-of-the-pi-algorithm"></a>
</h2>
<hr class="half-width">
<p>Some time after your initial investigation, your supervisor shares
that the authors of the previous <code>pi-cpu</code> program has now
released the <code>pi-cpu2</code> program, as well as the
<code>pi-gpu</code> program - both implementing the same algorithm for
calculating <span class="math inline">\(\pi\)</span>.
<code>pi-gpu</code> ports the <span class="math inline">\(\pi\)</span>
calculation algorithm to the GPU, and <code>pi-cpu2</code> changes the
algorithm to improve speed at the cost of memory usage.</p>
</section><section id="investigating-memory-usage-of-pi-cpu2"><h2 class="section-heading">Investigating memory usage of <code>pi-cpu2</code><a class="anchor" aria-label="anchor" href="#investigating-memory-usage-of-pi-cpu2"></a>
</h2>
<hr class="half-width">
<p>In the example programs, there should be the <code>pi-cpu2</code>
executable. Lets verify the authors claims that it should be faster
using <code>srun</code>. Make sure to add the <code>--constraint</code>
option to ensure your times are consistent!</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">srun</span> <span class="at">--constraint</span><span class="op">=</span>Icelake pi-cpu2</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">ERROR<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="error" tabindex="0"><code>srun: job 12064697 queued and waiting for resources
srun: job 12064697 has been allocated resources
slurmstepd: error: Detected 1 oom_kill event in StepId=12064697.0. Some of the step tasks have been OOM Killed.
srun: error: il-n01: task 0: Out Of Memory</code></pre>
</div>
<p>Ok, that wasn’t what we expected! The error message says that our job
was <code>OOM Killed</code> and that <code>task 0: Out Of Memory</code>.
Here, <code>OOM</code> is an abbreviation for Out Of Memory. The overall
error message is indicating that your job exceeded the memory allocation
of your job, which caused Slurm to cancel it. If we use
<code>seff</code> on that job:</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">seff</span> 12064697</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Job ID: 12064697
Cluster: milton
User/Group: yang.e/allstaff
State: OUT_OF_MEMORY (exit code 0)
Nodes: 1
Cores per node: 2
CPU Utilized: 00:00:00
CPU Efficiency: 0.00% of 00:00:00 core-walltime
Job Wall-clock time: 00:00:00
Memory Utilized: 0.00 MB (estimated maximum)
Memory Efficiency: 0.00% of 20.00 MB (10.00 MB/core)</code></pre>
</div>
<p>You will find that it produces only the requested resources and the
<code>OUT_OF_MEMORY</code> state and no utilization information is
found. Similarly, if we execute <code>sacct</code>, we should see
<code>OUT_OF_ME+</code> and <code>0:125</code> under the
<code>STATE</code> and <code>ExitCode</code> columns, respectively:</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ex">sacct</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>JobID           JobName  Partition    Account  AllocCPUS      State ExitCode 
------------ ---------- ---------- ---------- ---------- ---------- --------
... skipped output...
12064697        pi-cpu2    regular       wehi          2 OUT_OF_ME+    0:125 
12064697.ex+     extern                  wehi          2 OUT_OF_ME+    0:125 
12064697.0      pi-cpu2                  wehi          2 OUT_OF_ME+    0:125</code></pre>
</div>
<div id="discussion1" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Discussion<a class="anchor" aria-label="anchor" href="#discussion1"></a>
</h3>
<div class="callout-content">
<p>This job failed because it started and then ran out of memory almost
immediately. Some jobs may only request large amounts of memory after
the program has been running awhile. In those cases, <code>seff</code>
and <code>sacct</code> may still produce meaningful output.</p>
</div>
</div>
</div>
<p>Unfortunately, Slurm hasn’t given you a lot of information about how
much memory you <em>should</em> request. When you’re first testing out a
program, a good test is to run the program on your laptop or on the
login node (for a short amount of time) and monitor the process using
<code>htop</code>.</p>
<div id="revising-htop" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div id="revising-htop" class="callout-inner">
<h3 class="callout-title">Revising <code>htop</code><a class="anchor" aria-label="anchor" href="#revising-htop"></a>
</h3>
<div class="callout-content">
<p>You learnt how to use <code>htop</code> in the previous lesson, but
for when your job is running on a compute node. So you can find out how
much memory to request from Slurm, try run <code>pi-cpu2</code> on one
of the login nodes to see how much memory it needs. Remember: you’re
interested in the <code>RES</code> column!</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1">
  Show me the solution
  </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" aria-labelledby="headingSolution1" data-bs-parent="#accordionSolution1">
<div class="accordion-body">
<p>On one of the login nodes, execute the <code>pi-cpu2</code> program.
You will want to ensure it runs indefinitely, so you have time to run
<code>htop</code>:</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ex">./pi-cpu2</span> <span class="at">-r</span> <span class="at">-1</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Result: 3.1418780541911 Error:  0.0002853131785 Time: 6.2856s
Result: 3.1416545913891 Error:  0.0000618503765 Time: 4.6628s
Result: 3.1414653105873 Error: -0.0001274304252 Time: 4.1556s
... It will continue on...</code></pre>
</div>
<p>In another terminal, you can ssh to the same login node you ran
<code>pi-cpu2</code> on and then run <code>htop</code>:</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ssh</span> slurm-login01</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="ex">htop</span> <span class="at">-u</span> <span class="va">$USER</span></span></code></pre>
</div>
<figure><img src="fig/htop-screenshot-pi2.png" alt="" class="figure mx-auto d-block"><figcaption><code>htop</code> screenshot with
<code>pi-cpu2</code> running</figcaption></figure><p>The RES column should show a <em>peak</em> usage of roughly 1900MB,
but that number will fluctuate while the program runs.</p>
</div>
</div>
</div>
</div>
<p>You now know that requesting 2GB of memory from Slurm should be
sufficient. The default memory on Milton is 10MB per CPU, and that
definitely wouldn’t be enough! Try running <code>pi-cpu2</code> with the
appropriate amount of memory:</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="ex">srun</span> <span class="at">--mem</span><span class="op">=</span>2G <span class="at">--constraint</span><span class="op">=</span>Icelake pi-cpu2</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>srun: job 12066042 queued and waiting for resources
srun: job 12066042 has been allocated resources
Result: 3.1416610065891 Error:  0.0000682655765 Time: 2.9627s
Result: 3.1416797985893 Error:  0.0000870575767 Time: 2.9501s
Result: 3.1418230713906 Error:  0.0002303303780 Time: 2.9519s</code></pre>
</div>
<p>And it’s now running successfully! We can also see that the program
is indeed faster, as the old version took roughly 3.6s for each
calculation of <span class="math inline">\(\pi\)</span> on one core.</p>
<div id="discussion3" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Discussion<a class="anchor" aria-label="anchor" href="#discussion3"></a>
</h3>
<div class="callout-content">
<p>Determining how much memory to request from Slurm is not
straightforward. Sometimes, the documentation may provide some
indication of how much resources the software will use. However if this
isn’t the case, testing the program on your laptop or the login node can
be used to give an indication.</p>
<p>If your program uses too much memory, see if you can find smaller
test cases, and study how the memory usage changes with the size or
types of these inputs. You can use this to infer how much memory your
program might use with your real inputs.</p>
<p>But if neither of those options are available, the easiest way to go
about it is to over-allocate and to use the tools discussed so far to
refine your future jobs’ resource request.</p>
</div>
</div>
</div>
</section><section id="comparing-htop-and-seff-memory-values"><h2 class="section-heading">Comparing <code>htop</code> and <code>seff</code> memory values<a class="anchor" aria-label="anchor" href="#comparing-htop-and-seff-memory-values"></a>
</h2>
<hr class="half-width">
<p>You might be wondering how <code>htop</code> and <code>seff</code>
may be used differently, since they both provide information about your
job. Mainly, <code>htop</code> gives a more detailed view into your job,
whereas <code>seff</code> provides only a single summary stat.
Furthermore, <code>seff</code> results are only available at the end of
the job. Another important distinction between <code>htop</code> and
<code>seff</code>, is the accuracy of the statistics.</p>
<p>We now know that the maximum memory used by the <code>pi-cpu2</code>
program is approximately 1900MB. We can check this by trying to run the
program in Slurm, but requesting only 1800MB.</p>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="ex">srun</span> <span class="at">--mem</span><span class="op">=</span>1800M <span class="at">--constraint</span><span class="op">=</span>Icelake pi-cpu2</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">ERROR<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="error" tabindex="0"><code>srun: job 12066092 queued and waiting for resources
srun: job 12066092 has been allocated resources
slurmstepd: error: Detected 1 oom_kill event in StepId=12066092.0. Some of the step tasks have been OOM Killed.
srun: error: il-n02: task 0: Out Of Memory</code></pre>
</div>
<p>This confirms our job’s maximum memory is somewhere between 1800MB
and 2GB (based on our runs so far). Now try running running
<code>pi-cpu2</code> on Slurm again with the right amount of memory.
Make the <code>pi-cpu2</code> program calculate <span class="math inline">\(\pi\)</span> 15 times with <code>-r 15</code>, so
it runs for long enough for memory usage stats to be collected by
Slurm.</p>
<div class="codewrapper sourceCode" id="cb14">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="ex">srun</span> <span class="at">--mem</span><span class="op">=</span>2G <span class="at">--constraint</span><span class="op">=</span>Icelake pi-cpu2 <span class="at">-r</span> 15</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>srun: job 12066094 queued and waiting for resources
srun: job 12066094 has been allocated resources
Result: 3.1415999649886 Error:  0.0000072239760 Time: 2.9642s
... skipped output...</code></pre>
</div>
<p>And now let’s execute <code>seff</code> on the job and look at the
<code>Memory Utilized</code> field:</p>
<div class="codewrapper sourceCode" id="cb16">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="ex">seff</span> 12066094</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>... skipped output...
Memory Utilized: 377.43 MB
Memory Efficiency: 18.43% of 2.00 GB</code></pre>
</div>
<p>We know that <code>pi-cpu2</code> will need at least 1800MB of memory
to even calculate <span class="math inline">\(\pi\)</span> once, but the
value shown by <code>seff</code> will be <em>far lower</em> than
that!</p>
<div id="slurm-job-resource-utilization-accuracy" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div id="slurm-job-resource-utilization-accuracy" class="callout-inner">
<h3 class="callout-title">Slurm job resource utilization accuracy<a class="anchor" aria-label="anchor" href="#slurm-job-resource-utilization-accuracy"></a>
</h3>
<div class="callout-content">
<p>Slurm collects job information by occasionally asking the system how
much resources the job is using. This is not a problem for jobs whose
memory usage stays steady throughout the lifetime of the job. However,
this is insufficient for jobs whose memory usage changes suddenly or
frequently.</p>
</div>
</div>
</div>
</section><section id="monitoring-gpu-activity"><h2 class="section-heading">Monitoring GPU activity<a class="anchor" aria-label="anchor" href="#monitoring-gpu-activity"></a>
</h2>
<hr class="half-width">
<p>You’re consumed by the need-for-speed, and you’re ready to try the
<code>pi-gpu</code> program published by the same authors! When running
the program, you will need:</p>
<ul>
<li>1GB memory</li>
<li>1 GPU (of any kind)</li>
<li>the <code>cuda/11.7.1</code> and <code>gcc/11.2.0</code> modules
loaded</li>
</ul>
<div class="codewrapper sourceCode" id="cb18">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="ex">module</span> load cuda/11.7.1 gcc/11.2.0</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="ex">srun</span> <span class="at">--gres</span><span class="op">=</span>gpu:1 <span class="at">--mem</span><span class="op">=</span>1G <span class="at">--partition</span><span class="op">=</span>gpuq pi-gpu</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>srun: job 12066158 queued and waiting for resources
srun: job 12066158 has been allocated resources
Result: 3.1415535681881 Error: -0.0000390854017 Time: 0.2894s
Result: 3.1416463617890 Error:  0.0000537081992 Time: 0.2065s
Result: 3.1415584281882 Error: -0.0000342254016 Time: 0.2060s
...</code></pre>
</div>
<p>The job ran on a P100 GPU and it it’s about <code>3.0/0.2 = 15</code>
times faster than <code>pi-cpu2</code>! You find out from the
<code>--help</code> option, that <code>pi-gpu</code> also has a
<code>-p</code> option which can help you with running the program on
more GPUs on the same node. Try it out with <code>-p 2</code> and see if
you get a 2x speedup.</p>
<div class="codewrapper sourceCode" id="cb20">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="ex">srun</span> <span class="at">--gres</span><span class="op">=</span>gpu:2 <span class="at">--mem</span><span class="op">=</span>1G <span class="at">--partition</span><span class="op">=</span>gpuq pi-gpu <span class="at">-p</span> 2</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>srun: job 12066179 queued and waiting for resources
srun: job 12066179 has been allocated resources
Result: 3.1415107353877 Error: -0.0000819182020 Time: 0.4006s
Result: 3.1417724625901 Error:  0.0001798090003 Time: 0.1990s
Result: 3.1413390477862 Error: -0.0002536058036 Time: 0.1988s
...</code></pre>
</div>
<p>The speedup seems to be minimal!</p>
<div class="section level3">
<h3 id="introducing-nvtop">Introducing <code>nvtop</code>
<a class="anchor" aria-label="anchor" href="#introducing-nvtop"></a>
</h3>
<p>Let’s investigate the program’s behavior on the GPUs. We’ll do this
inside a <code>salloc</code> session instead of via <code>srun</code>
like we have so far:</p>
<div class="codewrapper sourceCode" id="cb22">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="ex">salloc</span> <span class="at">--partition</span><span class="op">=</span>gpuq <span class="at">--gres</span><span class="op">=</span>gpu:2 <span class="at">--mem</span><span class="op">=</span>1G</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>salloc: Pending job allocation 12066180
salloc: job 12066180 queued and waiting for resources
salloc: job 12066180 has been allocated resources
salloc: Granted job allocation 12066180
salloc: Waiting for resource configuration
salloc: Nodes gpu-p100-n02 are ready for job</code></pre>
</div>
<p>Now on a seperate terminal, ssh to the node you’ve been allocated and
execute the <code>nvtop</code> command:</p>
<div class="codewrapper sourceCode" id="cb24">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ssh</span> gpu-p100-n02</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="ex">nvtop</span></span></code></pre>
</div>
<p>A terminal user interface should open that looks similar to:</p>
<p><img src="fig/nvtop-screenshot-empty.png" alt="screenshot of nvtop output" class="figure"> Your output may differ if other
people’s jobs are running on the same node. The interface will be
reminiscent of <code>htop</code> but with differences:</p>
<ul>
<li>The top section doesn’t show the CPU utilization bars. Instead, they
show information about the device (we won’t be covering this
section).</li>
<li>The middle section shows a time-series chart of each GPU’s compute
(cyan) and memory (olive) utilization percentage over time.</li>
<li>The bottom section shows process information in a format similar to
<code>htop</code>:
<ul>
<li>
<code>PID</code>: process ID, which will correspond to a process on
<code>htop</code>
</li>
<li>
<code>USER</code>: The user the process is owned by</li>
<li>
<code>DEV</code>: the GPU ID the process is running on</li>
<li>
<code>GPU</code>: the “compute” utilization of the GPU (in
percentage)</li>
<li>
<code>GPU MEM</code>: the memory utilization of the GPU (in MB)</li>
<li>
<code>CPU</code>: the CPU utilization of the process</li>
<li>
<code>HOST MEM</code>: the CPU memory utilization of the
process</li>
<li>
<code>Command</code>: the command that the GPU is running</li>
</ul>
</li>
</ul>
<p><code>nvtop</code> is a useful tool in evaluating utilization of the
GPU while your job is running. This tool can be used as a way to check
that</p>
<ol style="list-style-type: lower-alpha">
<li>the GPUs you requested are actually being used, and</li>
<li>that they are being fully utilized</li>
</ol>
<p>Back in your <code>salloc</code> session, try running
<code>pi-gpu -p 2 -r -1</code> again. The <code>-r -1</code> option is
added to ensure it continues running. Once it’s running, return to your
<code>nvtop</code> window.</p>
<div class="codewrapper sourceCode" id="cb25">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="ex">srun</span> pi-gpu <span class="at">-p</span> 2 <span class="at">-r</span> <span class="at">-1</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Result: 3.1415107353877 Error: -0.0000819182020 Time: 0.4045s
Result: 3.1417724625901 Error:  0.0001798090003 Time: 0.1996s
Result: 3.1413390477862 Error: -0.0002536058036 Time: 0.1987s
...</code></pre>
</div>
<figure><img src="fig/nvtop-screenshot-m1.png" alt="" class="figure mx-auto d-block"><figcaption><code>nvtop</code> interface with
<code>pi-gpu -p 2 -r -1</code> running</figcaption></figure><p>Two new processes would’ve popped up in the process list with your
<code>pi-gpu</code> command. You will also see that utilization charts
will start to move.</p>
<p>In the process list, you will see two entries corresponding to the
two GPUs that <code>pi-gpu</code> is using. Under <code>DEV</code> you
will see the device IDs which <code>pi-gpu</code> is using. In the
example screenshot above, they are GPU 0 and GPU 1. But,
<code>nvtop</code> shows the information for all the GPUs on the node by
default. To see the GPUs assigned to <code>pi-gpu</code>, quit
<code>nvtop</code> by pressing <code>q</code> on your keyboard, and then
execute <code>nvtop</code> again, but with the
<code>--gpu-select &lt;GPUs&gt;</code> where <code>&lt;GPUs</code> is a
colon (<code>:</code>) seperated list of GPU IDs. As per the example
above, the command would be:</p>
<div class="codewrapper sourceCode" id="cb27">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="ex">nvtop</span> <span class="at">--gpu-select</span> 0:1</span></code></pre>
</div>
<p>Change the ID’s based on the GPUs you see <code>pi-gpu</code> running
on. You should now see information only for the GPUs you specified:</p>
<figure><img src="fig/nvtop-screenshot-myjob.png" alt="" class="figure mx-auto d-block"><figcaption><code>nvtop</code> with only our job’s GPUs</figcaption></figure>
</div>
<div class="section level3">
<h3 id="interpreting-nvtop-output">Interpreting <code>nvtop</code> output<a class="anchor" aria-label="anchor" href="#interpreting-nvtop-output"></a>
</h3>
<p>A good place to start when determining if your program is using the
GPU well is looking at the utilization. Many programs have parameters
which can affect this utilization - especially programs that process
data.</p>
<p>Many programs process data on the GPU in chunks as the GPU memory is
typically too small to handle the entire data set at once. These are
often controlled through chunk size or number of chunks parameters (you
might also see the word “block” being used instead). Typically, you want
to tune the parameters such that utilization is high.</p>
<p>In our case, the GPU utilization of each GPU that <code>pi-gpu</code>
is using, is approximately 78%. Which is not necessarily ideal.</p>
<div id="seeing-chunk-size-in-action" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div id="seeing-chunk-size-in-action" class="callout-inner">
<h3 class="callout-title">Seeing chunk-size in action!<a class="anchor" aria-label="anchor" href="#seeing-chunk-size-in-action"></a>
</h3>
<div class="callout-content">
<p><code>pi-gpu</code> doesn’t process data, but it does have a
parameter which is similar to a data set chunk: the number of trials
parameter! In your <code>salloc</code> session, try changing the number
of trials <code>pi-gpu</code> uses using the <code>-n</code> flag
e.g.</p>
<div class="codewrapper sourceCode" id="cb28">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="ex">srun</span> pi-gpu <span class="at">-p</span> 2 <span class="at">-r</span> <span class="at">-1</span> <span class="at">-n</span> <span class="op">&lt;</span>numtrials<span class="op">&gt;</span></span></code></pre>
</div>
<p>Note that the default is 123,456,789</p>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2">
  Show me the solution
  </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" aria-labelledby="headingSolution2" data-bs-parent="#accordionSolution2">
<div class="accordion-body">
<p>Trying 12,345,678 (about 10x fewer trials than default):</p>
<div class="codewrapper sourceCode" id="cb29">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="ex">srun</span> pi-gpu <span class="at">-p</span> 2 <span class="at">-r</span> <span class="at">-1</span> <span class="at">-n</span> 12345678</span></code></pre>
</div>
<figure><img src="fig/nvtop-screenshot-1e7.png" alt="" class="figure mx-auto d-block"><figcaption><code>nvtop</code> shows <code>pi-gpu</code> GPU
utilization at around 57% when number of trials is 10x less than
default</figcaption></figure><p>Trying 1,234,567 (about 100x fewer trials than default):</p>
<div class="codewrapper sourceCode" id="cb30">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="ex">srun</span> pi-gpu <span class="at">-p</span> 2 <span class="at">-r</span> <span class="at">-1</span> <span class="at">-n</span> 1234567</span></code></pre>
</div>
<figure><img src="fig/nvtop-screenshot-1e6.png" alt="" class="figure mx-auto d-block"><figcaption><code>nvtop</code> shows <code>pi-gpu</code> GPU
utilization at around 40% when number of trials is 100x less than
default</figcaption></figure><p>Trying 500,000,000 (about 4x as many trials than default):</p>
<div class="codewrapper sourceCode" id="cb31">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="ex">srun</span> pi-gpu <span class="at">-p</span> 2 <span class="at">-r</span> <span class="at">-1</span> <span class="at">-n</span> 500000000</span></code></pre>
</div>
<figure><img src="fig/nvtop-screenshot-5e8.png" alt="" class="figure mx-auto d-block"><figcaption><code>nvtop</code> shows <code>pi-gpu</code> “spiky”
GPU utilization when number of trials is 4x more than default</figcaption></figure><p>Importantly, you should’ve seen that the utilization of the GPU grows
as you increase the number of trials for <code>pi-gpu</code> to use to
estimate <span class="math inline">\(\pi\)</span>! And the opposite
should also be observed when you lower the number of trials.</p>
<p>In this case, increasing the number of trials can be roughly
interpreted as giving the GPUs enough work to keep them busy, whereas if
too few trials are being used, then there may not be enough work to keep
the GPU’s “compute units” busy.</p>
<p>When tuning your GPU programs, it’s important to keep the GPU
utilized. Note that if you are <em>writing</em> a program that uses the
GPU, utilization is not the only consideration!</p>
</div>
</div>
</div>
</div>

<p>So far, we’ve highlighted GPU utilization as a key indicator of
performance, but we can see that on two P100 GPUs, <code>pi-gpu</code>
the utilization of both GPUs is at about 78% - not quite fully
utilized.</p>
<p>If you look at the output of <code>pi-gpu --help</code>, you’ll see
that the “mode” flag is available, which can be used to enable an
experimental, higher-performance, algorithm. Trying that “experimental
mode” with the default number of trials:</p>
<div class="codewrapper sourceCode" id="cb32">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="ex">srun</span> pi-gpu <span class="at">-p</span> <span class="at">-2</span> <span class="at">-r</span> <span class="at">-1</span> <span class="at">-m</span> 2</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Result: 3.1416099117887 Error:  0.0000172581989 Time: 0.2929s
Result: 3.1415823393884 Error: -0.0000103142014 Time: 0.0546s
Result: 3.1418233305906 Error:  0.0002306770008 Time: 0.0567s
...</code></pre>
</div>
<p>You should be able to see that the time to calculate <span class="math inline">\(\pi\)</span> is almost 4 times faster than the
default algorithm. If you look at the output of <code>nvtop</code>, you
should be able to see the difference in utilization:</p>
<figure><img src="fig/nvtop-screenshot-m2.png" alt="" class="figure mx-auto d-block"><figcaption><code>nvtop</code> with the experimental algorithm
enabled showing higher utilization</figcaption></figure><p>In this case, the utilization has shot up to about 98%! GPU memory
utilization has also increased, which is a reflection of the algorithm
used in this new mode.</p>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Keypoints<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul>
<li>Choosing the right memory for you Slurm jobs takes a bit of trial
and error, but it helps to know a bit about how your program
behaves!</li>
<li>
<code>htop</code> should be used to observe memory usage when memory
usage varies frequently throughout the lifespan of the program.
<code>sacct</code> and <code>seff</code> are good for programs that
maintain steady memory usage.</li>
<li>
<code>nvtop</code> is a <code>htop</code>-like tool for monitoring
GPU activity</li>
<li>When optimizing GPU programs’ parameters, try to aim for full
utilization!</li>
</ul>
</div>
</div>
</div>
<!-- 
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use. 
 -->
</div>
</section></section><section id="aio-04-jobarrays"><p>Content from <a href="04-jobarrays.html">Job Arrays</a></p>
<hr>
<p> Last updated on 2023-07-11 | 
        
        <a href="https://github.com/WEHI-ResearchComputing/intermediate-slurm/edit/main/episodes/04-jobarrays.Rmd" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right"> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How can I run a lot of similar jobs?</li>
<li>How can I use job arrays in conjunction with a CSV file?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Understand the job array syntax</li>
<li>Understand how to make use of array indices</li>
<li>Know how to use <code>sed</code> and <code>read</code> to parse</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<section id="processing-multiple-cases"><h2 class="section-heading">Processing Multiple Cases<a class="anchor" aria-label="anchor" href="#processing-multiple-cases"></a>
</h2>
<hr class="half-width">
<p>Now that you feel pretty comfortable with the <code>pi-cpu</code>
program, your supervisor wants you to investigate how the error value of
the tool changes with the number of iterations. This is controlled with
the <code>-n</code> flag.</p>
<p>He’s noted that the tool uses 123,456,789 iterations (approx. 1.2E8),
but he would like to know what the accuracy is like for lower number of
iterations. He would like you to see how the error value behaves for
1E2, 1E3, 1E4, …, up to 1E8 iterations.</p>
<p>You know that running 7 tests manually is not a big deal, but you
decide that you might want to make this easier to use in case the number
of tests increase in the future.</p>
<p>You’ve heard about Slurm job arrays which is good at breaking up
these “parameter scans”, so you decide to give them a go.</p>
<div class="section level3">
<h3 id="what-does-a-job-array-do">What does a job array do?<a class="anchor" aria-label="anchor" href="#what-does-a-job-array-do"></a>
</h3>
<p>The job array functionality is a lightweight mechanism that Slurm
provides to allow users to submit many similar Slurm scripts with a
single <code>sbatch</code> command.</p>
<figure><img src="fig/job-array-diagram.png" alt="" class="figure mx-auto d-block"><figcaption>Job arrays submit multiple copies of the same script,
each with the same job ID, but unique “task IDs”, which can be used to
control each task’s behaviour.</figcaption></figure><p>Something similar could be achieved with a <code>for</code> loop
like:</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ID <span class="kw">in</span> <span class="dt">{</span><span class="dv">1</span><span class="dt">..</span><span class="dv">6</span><span class="dt">}</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="cf">do</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    <span class="ex">sbatch</span> my-script.sh <span class="va">$ID</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="cf">done</span></span></code></pre>
</div>
<p>which submits <code>my-script.sh</code> 6 times, and passing the
numbers 1 to 6 to each submission. However, job arrays have some
advantages over this approach:</p>
<ul>
<li>job arrays are more self-contained i.e., they do not need additional
wrapper scripts or code to submit to Slurm.</li>
<li>each job array “task” is linked to the same job ID, and can be more
easily queried with <code>sacct</code> and <code>squeue</code>.</li>
</ul>
<p>Why you might prefer the “for loop” approach over job arrays:</p>
<ul>
<li>each task in the job array has the same resources - seperate
<code>sbatch</code> commands allow you to change the resource
request.</li>
<li>when the work being done differs significantly between tasks -
making it difficult to control the behaviour solely through a “task
ID”.</li>
</ul>
</div>
<div class="section level3">
<h3 id="job-array-syntax">Job Array Syntax<a class="anchor" aria-label="anchor" href="#job-array-syntax"></a>
</h3>
<p>A Slurm script is turned into a job array with the
<code>--array=&lt;range&gt;</code> sbatch option. On Milton,
<code>&lt;range&gt;</code> can be any integer from 0 up to 1000. To
specify a sequential range of values, you can use the
<code>min-max</code> syntax, where <code>min</code> and <code>max</code>
are the minimum and maximum values of the range.</p>
<p>For example, your Slurm script may look like</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --job-name=myjob</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --array=1-3</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"hello world"</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="fu">sleep</span> 3600</span></code></pre>
</div>
<p>This script will execute 10 jobs which request the default CPUs and
memory. The job will print “hello world” to the job’s output file, and
then wait for an hour. When you submit this job, and your job waits in
the queue, this array job will look similar to:</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">sbatch</span> myjob.sh</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Submitted batch job 11784178</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ex">squeue</span> <span class="at">-u</span> <span class="va">$USER</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>          JOBID PARTITION     NAME     USER ST       TIME  NODES NODELIST(REASON)
11784178_[1-3]   regular    myjob   yang.e PD       0:00      1 (None)</code></pre>
</div>
<p>where the <code>[1-3]</code> correspond to the indices passed to
<code>--array</code>. Once they start running, the output from
<code>squeue</code> will look similar to:</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ex">squeue</span> <span class="at">-u</span> <span class="va">$USER</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>      JOBID PARTITION     NAME     USER ST       TIME  NODES NODELIST(REASON)
 11784178_1   regular    myjob   yang.e  R       0:00      1 sml-n02
 11784178_2   regular    myjob   yang.e  R       0:00      1 sml-n02
 11784178_3   regular    myjob   yang.e  R       0:00      1 sml-n02</code></pre>
</div>
<p>Each job is referred to as a “task” of a single job, each associated
with their own index. In the above example, each array task will have a
task ID of 1-10.</p>
<p>The <code>--array</code> option can also accept lists of integers and
ranges, seperated by commas. For example, <code>--array=1-3,7</code> is
acceptable too! This is useful for testing or rerunning only specific
indices.</p>
<p>Each array task will have its own output file. The default naming is
<code>slurm-&lt;jobID&gt;-&lt;taskID&gt;.out</code>. For example, the
above job submission produced:</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span> slurm-11784178<span class="pp">*</span>.out</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>slurm-11784178_1.out  slurm-11784178_2.out  slurm-11784178_3.out</code></pre>
</div>
<div id="cancelling-array-jobs" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div id="cancelling-array-jobs" class="callout-inner">
<h3 class="callout-title">Cancelling array jobs<a class="anchor" aria-label="anchor" href="#cancelling-array-jobs"></a>
</h3>
<div class="callout-content">
<p>When cancelling jobs, you can reference individual array tasks, a
range, or a list similar to specifying the jobs to run. For example,</p>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="ex">scancel</span> 1174178_[1-3,7]</span></code></pre>
</div>
<p>will cancel only array tasks 1, 2, and 3. If you want to cancel all
the job tasks at once, you can pass only the job ID.</p>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="ex">scancel</span> 1174178</span></code></pre>
</div>
<p>This will cancel any unfinished or pending array tasks in the
queue.</p>
<p>Note that this only works for <code>scancel</code>! No other Slurm
command will accept this format.</p>
</div>
</div>
</div>
</div>
<div class="section level3">
<h3 id="environment-variables-in-slurm-jobs">Environment Variables in Slurm Jobs<a class="anchor" aria-label="anchor" href="#environment-variables-in-slurm-jobs"></a>
</h3>
<p>Before you learn more about making use of job arrays, it’s important
to know about Slurm job environment variables!</p>
<p>Every time Slurm runs a job for you, Slurm makes a number of
environment variables available to you. These environment variables
contain information about the job, like the job ID, the job name, or the
job’s resources.</p>
<p>A full list of the available environment variables in a job can be
found with <code>man sbatch</code> and scrolling down to
<code>OUTPUT ENVIRONMENT VARIABLES</code>. You can jump to this section
by typing <code>/output environment variables</code> after you’ve opened
the manual page.</p>
<div id="discussion2" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge<a class="anchor" aria-label="anchor" href="#discussion2"></a>
</h3>
<div class="callout-content">
<p>Try crafting a Slurm script that requests 4 CPUs and 4GB of memory
that says hello, and then prints the node it’s running on, the number of
CPUs requested, and then the memory requested. An example output would
be:</p>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Hello. I am running on sml-n01
These are the resources I requested:
CPUs: 4
Memory: 4096MB</code></pre>
</div>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1">
  Show me the solution
  </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" aria-labelledby="headingSolution1" data-bs-parent="#accordionSolution1">
<div class="accordion-body">
<p>The Slurm environment variables needed here are
<code>SLURM_CPUS_PER_TASK</code>, <code>SLURM_JOB_NODELIST</code>, and
<code>SLURM_MEM_PER_NODE</code>.</p>
<p>To produce the output in the challenge, your script needs to look
similar to:</p>
<div class="codewrapper sourceCode" id="cb14">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --cpus-per-task=4</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --mem=4G</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"Hello. I am running on </span><span class="va">${SLURM_JOB_NODELIST}</span><span class="st">"</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"These are the resources I requested:"</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"CPUs: </span><span class="va">${SLURM_CPUS_PER_TASK}</span><span class="st">"</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"Memory: </span><span class="va">${SLURM_MEM_PER_NODE}</span><span class="st">MB"</span></span></code></pre>
</div>
<p>These parameters can be useful when you would like to automatically
pass the Slurm resource request to a command in your script. For
example, I can make <code>pi-cpu</code> use however many CPUs I’ve
requested automatically by using the `SLURM_CPUS_PER_TASK environment
variable inside a job script:</p>
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --cpus-per-task=4</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="ex">srun</span> pi-cpu <span class="at">-p</span> <span class="va">${SLURM_CPUS_PER_TASK}</span></span></code></pre>
</div>
<p>But be careful: some Slurm environment variables only have a value if
you’ve set it as a flag. For example, in the above example script,
<code>SLURM_CPUS_PER_TASK</code> has a value because we supplied
<code>--cpus-per-task</code>. But if you didn’t set
<code>--cpus-per-task</code>, the corresponding environment variable
would be empty!</p>
</div>
</div>
</div>
</div>

</div>
<div class="section level3">
<h3 id="the-slurm_array_task_id-environment-variable">The <code>SLURM_ARRAY_TASK_ID</code> Environment Variable<a class="anchor" aria-label="anchor" href="#the-slurm_array_task_id-environment-variable"></a>
</h3>
<p>Now back to Slurm job arrays!</p>
<p>While skimming through the manual pages, you might’ve noticed that
one of the environment variables listed is
<code>SLURM_ARRAY_TASK_ID</code>. This variable will store the ID of
each task in a job array, which can be used to control what each task
does.</p>
<p>As practice, we can take the Slurm script we wrote at the beginning
and modify it a little:</p>
<div class="codewrapper sourceCode" id="cb16">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --job-name=myjob</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --array=1-3</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"hello world from task </span><span class="va">${SLURM_ARRAY_TASK_ID}</span><span class="st">"</span></span></code></pre>
</div>
<p>This script should now print
<code>hello world from task &lt;N&gt;</code> where <code>N</code> is
1-3.</p>
<div class="codewrapper sourceCode" id="cb17">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="ex">sbatch</span> myjob-array.sh</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Submitted batch job 11784442</code></pre>
</div>
<p>And once all the job tasks have completed, we should be able to check
the output of each task:</p>
<div class="codewrapper sourceCode" id="cb19">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> slurm-11784442-<span class="pp">*</span>.out</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>hello world from task 1
hello world from task 2
hello world from task 3</code></pre>
</div>
<p>Which is great! Now we just have to figure out how to make use of
these task IDs. Remember: our goal is to execute
<code>pi-cpu -n &lt;iter&gt;</code> where <code>iter</code> is 1E2, 1E3,
…, 1E8.</p>
<p>One might think of using the IDs directly, for example, instead of
<code>#SBATCH --array=1-3</code>, maybe we could try something like</p>
<div class="codewrapper sourceCode" id="cb21">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --array=100,1000,10000,100000,1000000,10000000,1000000000</span></span></code></pre>
</div>
<p>But if we add this to our example array script and try to submit it,
we get the error:</p>
<div class="codewrapper">
<h3 class="code-label">ERROR<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="error" tabindex="0"><code>sbatch: error: Batch job submission failed: Invalid job array specification</code></pre>
</div>
<p>And unfortunately this is because Slurm on Milton has been configured
to accept a <a href="https://slurm.schedmd.com/job_array.html" class="external-link">max job
array index of 1000</a>.</p>
<p>So, we have to figure out another way! A common alternative is to use
a file to store the values we want the job array to scan over. In our
case, we can put together a file with a line for each number of
iterations we want the job array to scan over. Let’s call it
<code>iterations.txt</code>, which contains:</p>
<pre><code><span><span class="fl">100</span></span>
<span><span class="fl">1000</span></span>
<span><span class="fl">10000</span></span>
<span><span class="fl">100000</span></span>
<span><span class="fl">1000000</span></span>
<span><span class="fl">10000000</span></span>
<span><span class="fl">100000000</span></span></code></pre>
<p>But how do we use the job array index to retrieve each of these
lines? We can use the <code>readarray</code> command line utility.</p>
<p><code>readarray</code> is a neat tool that can split text into a Bash
array. Executing the command will start an interactive prompt. To exit,
press Ctrl+D.</p>
<div class="codewrapper sourceCode" id="cb24">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="ex">readarray</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="co"># start typing</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="ex">this</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="ex">is</span> an</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="ex">example</span> <span class="co"># press Ctrl+D to exit</span></span></code></pre>
</div>
<p>Your text gets saved into the <code>MAPFILE</code> array variable
(each index corresponds to a line):</p>
<div class="codewrapper sourceCode" id="cb25">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"line1: </span><span class="va">${MAPFILE</span><span class="op">[</span><span class="dv">0</span><span class="op">]</span><span class="va">}</span><span class="st">, line2: </span><span class="va">${MAPFILE</span><span class="op">[</span><span class="dv">1</span><span class="op">]</span><span class="va">}</span><span class="st">, line3: </span><span class="va">${MAPFILE</span><span class="op">[</span><span class="dv">2</span><span class="op">]</span><span class="va">}</span><span class="st">"</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>line1: this, line2: is an, line3: example</code></pre>
</div>
<p>A couple things to note about referencing elements in bash arrays: *
Array indices start at 0 * <code>${}</code> are on the outside of
<code>array[index]</code>.</p>
<p>Instead of supplying it input manually, we can pass it a file using
redirection:</p>
<div class="codewrapper sourceCode" id="cb27">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="ex">readarray</span> <span class="op">&lt;</span> iterations.txt</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="va">${MAPFILE</span><span class="op">[@]</span><span class="va">}</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>100 1000 10000 100000 1000000 10000000 100000000</code></pre>
</div>
<p>The <code>@</code> symbol means “all the elements in the array”.
Instead of saving the array into <code>MAPFILE</code>, we can pass a
variable name to <code>readarray</code> and it will save the array into
that variable instead e.g.:</p>
<div class="codewrapper sourceCode" id="cb29">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="ex">readarray</span> niterations <span class="op">&lt;</span> iterations.txt</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="va">${niterations</span><span class="op">[@]</span><span class="va">}</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>100 1000 10000 100000 1000000 10000000 100000000</code></pre>
</div>
<p>Can you start to see how we might combine the Slurm array index and
our bash array to pass different iteration values to
<code>pi-cpu</code>?</p>
<div id="tests" class="callout callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="tests" class="callout-inner">
<h3 class="callout-title">Tests<a class="anchor" aria-label="anchor" href="#tests"></a>
</h3>
<div class="callout-content">
<p>It’s generally good practice to <em>test</em> your array job before
you run it for real. This is especially true if you plan to run a large
number of tasks!</p>
</div>
</div>
</div>
<p>Let’s first test that we know how to properly combine the
<code>SLURM_ARRAY_TASK_ID</code> environment variable together with
<code>readarray</code>. Take your script and modify it:</p>
<div class="codewrapper sourceCode" id="cb31">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --job-name=myjob</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --array=0-2</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"hello world from task </span><span class="va">${SLURM_ARRAY_TASK_ID}</span><span class="st">"</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="ex">readarray</span> niterations <span class="op">&lt;</span> iterations.txt</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"I will run </span><span class="va">${niterations</span><span class="op">[</span><span class="va">$SLURM_ARRAY_TASK_ID</span><span class="op">]</span><span class="va">}</span><span class="st">!"</span></span></code></pre>
</div>
<p>Note that we’ve changed the array task range from 1-3 to 0-2 since
the bash array is 0-indexed.</p>
<p>Let’s submit this script to confirm that we’ve used `readarray``
correctly.</p>
<div class="codewrapper sourceCode" id="cb32">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="ex">sbatch</span> myjob-array.sh</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Submitted batch job 11784737</code></pre>
</div>
<p>Because we’ve only passed the range <code>0-1</code> to the
<code>--array</code> option, we should expect to only see outputs for
the first 3 rows in <code>iterations.txt</code>:</p>
<div class="codewrapper sourceCode" id="cb34">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> slurm-11784737_<span class="pp">*</span>.out</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>hello world from task 0
I will run 100
!
hello world from task 1
I will run 1000
!
hello world from task 2
I will run 10000
!</code></pre>
</div>
<p>Which demonstrates that we’ve taken the first 3 lines of
<code>iterations.txt</code> correctly! But there’s something wrong… the
exclamation marks on the next line instead of at the end of the number!
This is because <code>readarray</code> keeps newline characters when
parsing the file. To turn off this behavior we need to add the
<code>-t</code> option, so our <code>readarray</code> command
becomes:</p>
<div class="codewrapper sourceCode" id="cb36">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="ex">readarray</span> <span class="at">-t</span> niterations <span class="op">&lt;</span> iteration.txt</span></code></pre>
</div>
<p>We can now make use of these values by passing the number of
iterations to the <code>pi-cpu</code> command. We also need to change
the array range to pull all the lines of the <code>iterations.txt</code>
file. Change the array range and add the <code>pi-cpu</code> command to
your script:</p>
<div class="codewrapper sourceCode" id="cb37">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --job-name=myjob</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --array=0-6</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --cpus-per-task=4</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"hello world from task </span><span class="va">${SLURM_ARRAY_TASK_ID}</span><span class="st">"</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a><span class="ex">readarray</span> <span class="at">-t</span> niterations <span class="op">&lt;</span> iterations.txt</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"I will run </span><span class="va">${niterations</span><span class="op">[</span><span class="va">$SLURM_ARRAY_TASK_ID</span><span class="op">]</span><span class="va">}</span><span class="st">!"</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a><span class="ex">srun</span> ./pi-cpu <span class="at">-p</span> <span class="va">${SLURM_CPUS_PER_TASK}</span> <span class="at">-n</span> <span class="va">${niterations</span><span class="op">[</span><span class="va">$SLURM_ARRAY_TASK_ID</span><span class="op">]</span><span class="va">}</span></span></code></pre>
</div>
<p>You will also need to ensure that <code>--cpus-per-task</code> is
provided here, as without that option, <code>SLURM_CPUS_PER_TASK</code>
doesn’t get set either.</p>
<p>We can then submit the script:</p>
<div class="codewrapper sourceCode" id="cb38">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="ex">sbatch</span> myjob-array.sh</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="co"># wait for the job tasks to finish...</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> slurm-<span class="pp">*</span>.out</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>$ cat slurm-11913780_*.out
hello world from task 0
I will run 100!
Result: 3.1600000000000 Error:  0.0184072589874 Time: 0.0003s
... skipped output

hello world from task 1
I will run 1000!
Result: 3.0480000000000 Error: -0.0935927410126 Time: 0.0004s
... skipped output

hello world from task 2
I will run 10000!
Result: 3.1344000000000 Error: -0.0071927410126 Time: 0.0056s
... skipped output

hello world from task 3
I will run 100000!
Result: 3.1431600000000 Error:  0.0015672589874 Time: 0.0013s
... skipped output

hello world from task 4
I will run 1000000!
Result: 3.1421880000000 Error:  0.0005952589874 Time: 0.0100s
... skipped output

hello world from task 5
I will run 10000000!
Result: 3.1419520000000 Error:  0.0003592589874 Time: 0.0936s
... skipped output

hello world from task 6
I will run 100000000!
Result: 3.1414855200000 Error: -0.0001072210126 Time: 0.9331s
... skipped output</code></pre>
</div>
<p>And now you can see the magnitude of the error, and the speed
decreasing as we increase the number of iterations.</p>
</div>
<div class="section level3">
<h3 id="multi-column-data">Multi-column data<a class="anchor" aria-label="anchor" href="#multi-column-data"></a>
</h3>
<p>So far you’ve only needed one column of data (the number of
iterations) to investigate accuracy with number of iterations. But, in
many cases you might be interested in varying multiple variables with
each array task.</p>
<p>We can do this by adding another column to our data. Create a new
file called iter-cpu.txt with the content:</p>
<pre><code>iters cpus
100 2
100 4
1000 2
1000 4
10000 2
10000 4</code></pre>
<p>The first row is now a header and rows 2-7 contains the data we’ll
use in our job arrays. Here, we’re going to vary the value passed to
<code>-p</code>.</p>
<p>We can still execute <code>readarray</code> on this file:</p>
<div class="codewrapper sourceCode" id="cb41">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="ex">readarray</span> filedata <span class="op">&lt;</span> iter-cpu.txt</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="va">${filedata</span><span class="op">[</span><span class="dv">0</span><span class="op">]</span><span class="va">}</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>iters cpus</code></pre>
</div>
<p>But the columns don’t get split!</p>
<p>So how do we split the columns? <code>cut</code> is a tool you might
be aware of (for example from an <a href="https://monashdatafluency.github.io/shell-novice/" class="external-link">introductory
course</a>). But, this time, lets split the lines of text using the
<code>read</code> utility.</p>
<p>We can use the “heredoc” operator <code>&lt;&lt;&lt;</code> to pass
text to the <code>read</code> command:</p>
<div class="codewrapper sourceCode" id="cb43">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="bu">read</span> <span class="op">&lt;&lt;&lt;</span> <span class="st">"hello world"</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="va">$REPLY</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>hello world</code></pre>
</div>
<p>By default, <code>read</code> saves what we send it to the variable
<code>REPLY</code>. Note that unlike <code>readarray</code>,
<code>REPLY</code> is not an array. We can choose the variable to save
our input to by giving <code>read</code> a variable name:</p>
<div class="codewrapper sourceCode" id="cb45">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="bu">read</span> <span class="va">myvar</span> <span class="op">&lt;&lt;&lt;</span> <span class="st">"hello world"</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="va">$myvar</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>hello world</code></pre>
</div>
<p><code>read</code> is also useful because if we pass it more variable
names, it will split the words into each of thoses variables. So, if we
add another variable name to our previous <code>read</code> command:</p>
<div class="codewrapper sourceCode" id="cb47">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="bu">read</span> <span class="va">myvar1</span> <span class="va">myvar2</span> <span class="op">&lt;&lt;&lt;</span> <span class="st">"hello world"</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"myvar1: </span><span class="va">$myvar1</span><span class="st">, myvar2: </span><span class="va">$myvar2</span><span class="st">"</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>myvar1: hello, myvar2: world</code></pre>
</div>
<div id="parsing-the-iter-cpu.txt-file" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div id="parsing-the-iter-cpu.txt-file" class="callout-inner">
<h3 class="callout-title">parsing the <code>iter-cpu.txt</code>
file<a class="anchor" aria-label="anchor" href="#parsing-the-iter-cpu.txt-file"></a>
</h3>
<div class="callout-content">
<p>We now know how to split lines of a file into an array using
<code>readarray</code>, as well as splitting strings with spaces into
individual words!</p>
<p>See if you can apply this to our current case: try and get
<strong>the first line</strong> from <code>iter-cpu.txt</code> and save
the first column into <code>niterations</code> and the second column
into <code>ncpus</code> bash variables</p>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2">
  Show me the solution
  </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" aria-labelledby="headingSolution2" data-bs-parent="#accordionSolution2">
<div class="accordion-body">
<p>As shown already we can save <code>iter-cpu.txt</code> into an array
using</p>
<div class="codewrapper sourceCode" id="cb49">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="ex">readarray</span> <span class="at">-t</span> rowdata <span class="op">&lt;</span> iter-cpu.txt</span></code></pre>
</div>
<p>This gives us an array, <code>rowdata</code>, where each element is a
line of text from <code>iter-cpu.txt</code>. To split the first line of
the file into variables <code>niterations</code> and
<code>ncpus</code>:</p>
<div class="codewrapper sourceCode" id="cb50">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="bu">read</span> <span class="va">niterations</span> <span class="va">ncpus</span> <span class="op">&lt;&lt;&lt;</span> <span class="st">"</span><span class="va">${rowdata</span><span class="op">[</span><span class="dv">0</span><span class="op">]</span><span class="va">}</span><span class="st">"</span></span></code></pre>
</div>
<p><code>${rowdata[0]}</code> is referencing the first element of
<code>rowdata</code>, and therefore the first line of text in
<code>iter-cpu.txt</code>. <code>read</code> will take this the row
data, and split the two words into <code>niterations</code> and
<code>ncpus</code> variables.</p>
</div>
</div>
</div>
</div>
<div id="which-array-indices" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div id="which-array-indices" class="callout-inner">
<h3 class="callout-title">Which array indices?<a class="anchor" aria-label="anchor" href="#which-array-indices"></a>
</h3>
<div class="callout-content">
<p>Our new text file not only has a new column, but we’ve also added
headers.</p>
<p>So, before we make use of <code>readarray</code> in our job array,
should we change the range passed to <code>--array</code> to make sure
our new Slurm array script works?</p>
</div>
</div>
</div>
<div id="accordionSolution3" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution3" aria-expanded="false" aria-controls="collapseSolution3">
  <h4 class="accordion-header" id="headingSolution3">
  Show me the solution
  </h4>
</button>
<div id="collapseSolution3" class="accordion-collapse collapse" aria-labelledby="headingSolution3" data-bs-parent="#accordionSolution3">
<div class="accordion-body">
<p>Yes we do! While we have the same number of rows in
<code>iter-cpu.txt</code>, the first row is headers. If we passed those
headers to <code>pi-cpu</code> instead of integer values, the program
would fail. We need to ensure only array tasks 1-6 are being run
(remember: the 0th index is the first row in the file i.e., the
headers).</p>
<p>Be aware of this when you write your own files and job array
scripts!</p>
</div>
</div>
</div>
</div>
<div id="use-the-second-columns-iter-cpu.txt" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div id="use-the-second-columns-iter-cpu.txt" class="callout-inner">
<h3 class="callout-title">Use the second columns
<code>iter-cpu.txt</code><a class="anchor" aria-label="anchor" href="#use-the-second-columns-iter-cpu.txt"></a>
</h3>
<div class="callout-content">
<p>Adapt your array job to use what we’ve learnt so far about
<code>readarray</code> and <code>read</code> to adapt your script to
make use of the 2 columns in <code>iter-cpu.txt</code>! The first column
should be passed to <code>-n</code> and the second should be passed to
<code>-p</code>.</p>
</div>
</div>
</div>
<div id="accordionSolution4" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution4" aria-expanded="false" aria-controls="collapseSolution4">
  <h4 class="accordion-header" id="headingSolution4">
  Show me the solution
  </h4>
</button>
<div id="collapseSolution4" class="accordion-collapse collapse" aria-labelledby="headingSolution4" data-bs-parent="#accordionSolution4">
<div class="accordion-body">
<p>We first need to modify the <code>readarray</code> line to read the
correct file, and to use an appropriately named array variable:</p>
<div class="codewrapper sourceCode" id="cb51">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="ex">readarray</span> <span class="at">-t</span> rowdata <span class="op">&lt;</span> iter-cpu.txt</span></code></pre>
</div>
<p>We then need to split <code>rowdata</code> further into
<code>niterations</code> and <code>ncpus</code>. To do this, we will
adapt what we wrote for “Parsing the <code>iter-cpu.txt</code> file”
challenge. Instead of reading the first “0th” element of
<code>rowdata</code>, we’ll use the <code>SLURM_ARRAY_TASK_ID</code>
environment variable:</p>
<div class="codewrapper sourceCode" id="cb52">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="bu">read</span> <span class="va">niterations</span> <span class="va">ncpus</span> <span class="op">&lt;&lt;&lt;</span> <span class="va">${rowdata</span><span class="op">[</span><span class="va">$SLURM_CPUS_PER_TASK</span><span class="op">]</span><span class="va">}</span></span></code></pre>
</div>
<p>And finally, we can add <code>niterations</code> and
<code>ncpus</code> to our echo and <code>pi-cpu</code> execution
command!</p>
<div class="codewrapper sourceCode" id="cb53">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"I will run </span><span class="va">$niterations</span><span class="st"> iterations and with </span><span class="va">$ncpus</span><span class="st"> CPUs!"</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="ex">srun</span> pi-cpu <span class="at">-p</span> <span class="va">$ncpus</span> <span class="at">-n</span> <span class="va">$niterations</span></span></code></pre>
</div>
<p>Our final script should look something like:</p>
<div class="codewrapper sourceCode" id="cb54">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --job-name=myjob</span></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --array=1-6</span></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --cpus-per-task=4</span></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"hello world from task </span><span class="va">${SLURM_ARRAY_TASK_ID}</span><span class="st">"</span></span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a><span class="ex">readarray</span> <span class="at">-t</span> rowdata <span class="op">&lt;</span> iter-cpu.txt</span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a><span class="bu">read</span> <span class="va">niterations</span> <span class="va">ncpus</span> <span class="op">&lt;&lt;&lt;</span> <span class="va">${rowdata</span><span class="op">[</span><span class="va">$SLURM_ARRAY_TASK_ID</span><span class="op">]</span><span class="va">}</span></span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"I will run </span><span class="va">$niterations</span><span class="st"> with </span><span class="va">$ncpus</span><span class="st"> CPUs!"</span></span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a><span class="ex">srun</span> pi-cpu <span class="at">-p</span> <span class="va">$ncpus</span> <span class="at">-n</span> <span class="va">$niterations</span></span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="section level3">
<h3 id="controlling-output">Controlling output<a class="anchor" aria-label="anchor" href="#controlling-output"></a>
</h3>
<p>When using <code>--output</code> and <code>--error</code> flags with
<code>sbatch</code>, you can make use of the <code>%A</code> variable
which refers to the parent job ID, and <code>%a</code>, which refers to
the job task. Using <code>%j</code> will use a different job ID for each
task.</p>
</div>
<div class="section level3">
<h3 id="exception-handling">Exception handling<a class="anchor" aria-label="anchor" href="#exception-handling"></a>
</h3>
<p>Sometimes, you might find that you want to execute your job script
from the command line, instead of submitting it to Slurm. In this case,
your job likely won’t have a <code>SLURM_ARRAY_TASK_ID</code>
environment variable set. In this case, you will want to make sure the
necessary check is present and for the script to exit appropriately OR
set a reasonable default.</p>
<div class="codewrapper sourceCode" id="cb55">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">[</span> <span class="ot">-z</span> <span class="va">$SLURM_ARRAY_TASK_ID</span> <span class="bu">]</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="cf">then</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">"This script needs to be submitted as a Slurm script!"</span></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">exit</span> 1</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a><span class="cf">fi</span></span></code></pre>
</div>
<p><code>[ -z $SLURM_ARRAY_TASK_ID ]</code> returns 0 if
<code>SLURM_ARRAY_TASK_ID</code> is NOT set. You can replace the
<code>echo</code> and <code>exit</code> statement with a reasonable
default instead e.g., <code>export SLURM_ARRAY_TASK_ID=1</code>.</p>

<div id="different-delimiters-optional" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div id="different-delimiters-optional" class="callout-inner">
<h3 class="callout-title">Different delimiters (optional)<a class="anchor" aria-label="anchor" href="#different-delimiters-optional"></a>
</h3>
<div class="callout-content">
<p>Here we showed how to split text that is seperated by spaces.
e.g.</p>
<div class="codewrapper sourceCode" id="cb56">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="va">string</span><span class="op">=</span><span class="st">"hello world"</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="bu">read</span> <span class="va">word1</span> <span class="va">word1</span> <span class="op">&lt;&lt;&lt;</span> <span class="st">"</span><span class="va">$string</span><span class="st">"</span></span></code></pre>
</div>
<p>But different delimiters can be used using the following syntax:</p>
<div class="codewrapper sourceCode" id="cb57">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="va">string</span><span class="op">=</span><span class="st">"hello world"</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="va">IFS</span><span class="op">=&lt;</span>delimiter<span class="op">&gt;</span> read <span class="ex">word1</span> word2 <span class="op">&lt;&lt;&lt;</span> <span class="st">"</span><span class="va">$string</span><span class="st">"</span></span></code></pre>
</div>
<p><code>IFS</code> is a special environment variable used by bash to
determine how to split strings. By setting it to a different
character(s), you can control how <code>read</code> splits your string.
What should you set <code>IFS</code> to to get the following output from
<code>echo "word1: $word1, word2: $word2"</code>?</p>
<ol style="list-style-type: decimal">
<li><code>word1: hello , word2: orld</code></li>
<li><code>word1: , word2: ello world</code></li>
</ol>
</div>
</div>
</div>
<div id="accordionSolution5" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution5" aria-expanded="false" aria-controls="collapseSolution5">
  <h4 class="accordion-header" id="headingSolution5">
  Show me the solution
  </h4>
</button>
<div id="collapseSolution5" class="accordion-collapse collapse" aria-labelledby="headingSolution5" data-bs-parent="#accordionSolution5">
<div class="accordion-body">
<ol style="list-style-type: decimal">
<li>
<code>IFS=w</code>:</li>
</ol>
<div class="codewrapper sourceCode" id="cb58">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="va">string</span><span class="op">=</span><span class="st">"hello world"</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="va">IFS</span><span class="op">=</span>w <span class="bu">read</span> <span class="va">word1</span> <span class="va">word2</span> <span class="op">&lt;&lt;&lt;</span> <span class="st">"</span><span class="va">$string</span><span class="st">"</span></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"word1: </span><span class="va">$word1</span><span class="st">, word2: </span><span class="va">$word2</span><span class="st">"</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>word1: hello , word2: orld</code></pre>
</div>
<ol start="2" style="list-style-type: decimal">
<li><code>IFS=h</code></li>
</ol>
<div class="codewrapper sourceCode" id="cb60">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="va">string</span><span class="op">=</span><span class="st">"hello world"</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a><span class="va">IFS</span><span class="op">=</span>h <span class="bu">read</span> <span class="va">word1</span> <span class="va">word2</span> <span class="op">&lt;&lt;&lt;</span> <span class="st">"</span><span class="va">$string</span><span class="st">"</span></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"word1: </span><span class="va">$word1</span><span class="st">, word2: </span><span class="va">$word2</span><span class="st">"</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>word1: , word2: ello world</code></pre>
</div>
</div>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Keypoints<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul>
<li>Slurm job arrays are a great way to parallelise similar jobs!</li>
<li>The <code>SLURM_ARRAY_TASK_ID</code> environment variable is used to
control individual array tasks’ work</li>
<li>A file with all the parameters can be used to control array task
parameters</li>
<li>
<code>readarray</code> and <code>read</code> are useful tools to
help you parse files. But it can also be done many other ways!</li>
</ul>
</div>
</div>
</div>
<!-- 
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use. 
 -->
</div>
</section></section><section id="aio-05-jobdependencies"><p>Content from <a href="05-jobdependencies.html">Organising dependent Slurm jobs</a></p>
<hr>
<p> Last updated on 2023-07-11 | 
        
        <a href="https://github.com/WEHI-ResearchComputing/intermediate-slurm/edit/main/episodes/05-jobdependencies.Rmd" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right"> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How can I organise jobs that depend on each other?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Know how to use the <code>--dependency</code> <code>sbatch</code>
option</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<section id="a-pipeline-to-visualize-pi-cpu-results"><h2 class="section-heading">A pipeline to visualize <code>pi-cpu</code> results<a class="anchor" aria-label="anchor" href="#a-pipeline-to-visualize-pi-cpu-results"></a>
</h2>
<hr class="half-width">
<p>Inside the example-programs, there is the folder
<code>job-depends</code> which contains files used in this episode.</p>
<p>In the previous episode, you learnt how to create job arrays to
investigate how the accuracy of <code>pi-cpu</code> changes with the
number of trials used. You now want to present these results to your
supervisor graphically, but you still need to aggregate and process the
results further to create something presentable. You decide that you
want to show a bar chart where the X-axis corresponds to the number of
trials, and the Y-axis is the average absolute error calculated
determined from multiple calculations of <span class="math inline">\(\pi\)</span>.</p>
<p>You want to test 7 different number of trials: 1E2 (100), 1E3
(1,000), … , up to 1E8 (100,000,000). These values are in
<code>pi-process-input.txt</code>. These values are used inside
<code>pi-submit.sh</code>, which is a script in
<code>example-programs</code> that is a Slurm job array script like in
the job array episode.</p>
<p>You know that you need to write a bit more code to complete the
pipeline:</p>
<ol style="list-style-type: decimal">
<li>For each number of trials, the results from <code>pi-cpu</code> need
to be averaged.</li>
<li>The individual averaged results need to be aggregated into a single
file.</li>
</ol>
<p>A diagram of the process looks like:</p>
<pre><code>n = 1E2    1E3    ...     1E7     1E8
     |      |              |       |
     |      |              |       |
  pi-cpu  pi-cpu         pi-cpu  pi-cpu
     |      |              |       |
     |      |              |       |
    avg    avg            avg     avg
     |      |              |       |
     |______|___combine____|_______|
                results
                   |
                   |
                 final
                results</code></pre>
<p>You decide that you want to do this with Slurm jobs because each step
requires different amounts of resources. But to set this up, you need to
make use of:</p>
</section><section id="slurm-job-dependencies"><h2 class="section-heading">Slurm job dependencies<a class="anchor" aria-label="anchor" href="#slurm-job-dependencies"></a>
</h2>
<hr class="half-width">
<p>To setup Slurm jobs that are dependent on each other, you can make
use of the Slurm <code>--dependency</code>, or <code>-d</code> option.
The syntax of the option is:</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --dependency=condition:jobid   # or</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH -d condition:jobid</span></span></code></pre>
</div>
<p>This will ask Slurm to ensure that the job that you’re submitting
doesn’t start until <code>condition</code> is satisfied for job
<code>jobid</code>. For example,</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --dependency=afterok:1234</span></span></code></pre>
</div>
<p>is requesting for the job you’re submitting to start, only if job
<code>1234</code> completes successfully. This allows you to chain a
series of jobs together, perhaps with different resource requirements,
without needing to monitor progress.</p>
<p>Other conditions include:</p>
<ul>
<li>
<code>after</code>: start this job after the specified job
<strong>starts</strong>
</li>
<li>
<code>afternotok</code>: start this job only if the specified job
<strong>fails</strong>
</li>
<li>
<code>afterany</code>: start this job after the specified job
<strong>fails, succeeds, or is cancelled</strong>
</li>
<li>
<code>singleton</code>: Start this job if there are <strong>no other
running jobs with the same name.</strong>
</li>
<li>
<code>aftercorr</code>: Start this <strong>array task</strong> when
the <strong>corresponding array task in the specified job completes
successfully</strong>.</li>
</ul>
<p>In your <span class="math inline">\(\pi\)</span> calculation
scenario, submitting the second lot of array jobs (i.e., the
<code>avg</code> jobs) can be submitted using
<code>--dependency=afterok:&lt;jobid&gt;</code>. However, this will mean
that <em>none</em> of the <code>avg</code> job array tasks will start
until <em>all</em> of the <code>pi-cpu</code> jobs finish. This results
in lower job throughput as tasks wait around.</p>
<p>We can achieve better job throughput by making use of the
<code>aftercorr</code> condition (short for “after corresponding”),
which tells Slurm that each task in the second job can start once the
same task in the first job completes successfully.</p>
</section><section id="setting-up-the-avg-array-job"><h2 class="section-heading">Setting up the <code>avg</code> array job<a class="anchor" aria-label="anchor" href="#setting-up-the-avg-array-job"></a>
</h2>
<hr class="half-width">
<p>Each <code>pi-cpu</code> job output will have multiple attempts to
calculate <span class="math inline">\(\pi\)</span>. So, the goal of each
<code>avg</code> job array task is to calculate the average error.
<code>pi-avg.py</code> in the <code>example-programs/job-depends</code>
directory, is a script made specifically for this purpose. For example,
if you execute <code>pi-cpu</code> and redirect the output to a
file:</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ex">./pi-cpu</span> <span class="op">&gt;</span> pis.txt</span></code></pre>
</div>
<p>and then run</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ex">python3</span> pi-avg.py pis.txt</span></code></pre>
</div>
<p>You should get output similar to:</p>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Average Absolute Error: 0.00016350984148000002</code></pre>
</div>
<p>This program can be placed into a Slurm script like so:</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="co"># pi-avg.sh</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --job-name=pi-avg</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --array=0-6</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --output=%x-%a.out</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --cpus-per-task=1</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="va">id</span><span class="op">=</span><span class="va">$SLURM_ARRAY_TASK_ID</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="ex">python3</span> pi-avg.py pi-submit-<span class="va">${id}</span>.out</span></code></pre>
</div>
<div class="section level3">
<h3 id="the-pi-avg-sh-script-line-by-line">The <code>pi-avg.sh</code> script line-by-line<a class="anchor" aria-label="anchor" href="#the-pi-avg-sh-script-line-by-line"></a>
</h3>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span></code></pre>
</div>
<p>is the hash-bang statement. Required by Slurm, but good practice to
include in any script.</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># pi-avg.sh</span></span></code></pre>
</div>
<p>is a comment with the name of the script.</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --job-name=pi-avg</span></span></code></pre>
</div>
<p>is a Slurm option specifying the job name. In this case, it is
<code>pi-avg</code>.</p>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --array=0-6</span></span></code></pre>
</div>
<p>is telling Slurm that this job is a job array with task IDs 0 to 6
(inclusive).</p>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --output=%x-%a.out</span></span></code></pre>
</div>
<p>is telling Slurm where to write the output of the script to.
<code>%x</code> is a placeholder for the job name, and <code>%a</code>
is a placeholder for the job task array. For example, the job task with
ID = 0, will have the output file: <code>pi-avg-0.out</code>.</p>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --cpus-per-task=1</span></span></code></pre>
</div>
<p>is specifying the number of CPUs each job array task needs.</p>
<div class="codewrapper sourceCode" id="cb14">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="va">id</span><span class="op">=</span><span class="va">$SLURM_ARRAY_TASK_ID</span></span></code></pre>
</div>
<p>sets the <code>id</code> variable to the value stored in the
<code>SLURM_ARRAY_TASK_ID</code> environment variable.</p>
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="ex">python3</span> pi-avg.py pi-submit-<span class="va">${id}</span>.out</span></code></pre>
</div>
<p>is running the <code>pi-avg.py</code> program on the file
<code>pi-submit-${id}.out</code>, which would be the output from the
<code>pi-submit.sh</code> job tasks.</p>
<p>Notably, this script doesn’t have the <code>--dependency</code>
option set, but this will be discussed later.</p>
</div>
<div class="section level3">
<h3 id="submitting-the-jobs">Submitting the jobs<a class="anchor" aria-label="anchor" href="#submitting-the-jobs"></a>
</h3>
<p>Before we submit <code>pi-submit.sh</code>, we need to make sure that
<code>pi-cpu</code> is in the correct place. <code>pi-submit.sh</code>
assumes that <code>pi-cpu</code> is in the working directory. So, if
you’re in the <code>job-depends</code> directory, you must first
<code>cp ../pi-cpu .</code>, which makes a copy of <code>pi-cpu</code>
in the <code>job-depends</code> directory.</p>
<p>Now that we have <code>pi-submit.sh</code> and <code>pi-avg.sh</code>
we can try submitting them such that <code>pi-avg.sh</code> job tasks
depend on <code>pi-submit.sh</code> job tasks. We can start this process
by</p>
<div class="codewrapper sourceCode" id="cb16">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="ex">sbatch</span> pi-submit.sh</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Submitted batch job 12271504</code></pre>
</div>
<p>And then submit the next job using the
<code>--dependency=aftercorr:&lt;jobid&gt;</code> flag:</p>
<div class="codewrapper sourceCode" id="cb18">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="ex">sbatch</span> <span class="at">-d</span> aftercorr:12271504</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Submitted batch job 12271511</code></pre>
</div>
<p>Reminder: <code>-d</code> is the short-form of
<code>--dependency</code>! Depending on how fast you were with
submitting the jobs and setting up the dependency, when you run
<code>squeue -u $USER</code>, you might see output similar to:</p>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>             JOBID PARTITION     NAME     USER ST       TIME  NODES NODELIST(REASON)
        12271511_6   regular   pi-avg   yang.e PD       0:00      1 (Dependency)
        12271511_5   regular   pi-avg   yang.e PD       0:00      1 (None)
        12271511_4   regular   pi-avg   yang.e PD       0:00      1 (None)
        12271511_3   regular   pi-avg   yang.e PD       0:00      1 (None)
        12271511_2   regular   pi-avg   yang.e PD       0:00      1 (None)
        12271511_1   regular   pi-avg   yang.e PD       0:00      1 (None)
        12271511_0   regular   pi-avg   yang.e PD       0:00      1 (None)
        12271504_6   regular pi-submi   yang.e  R       0:12      1 sml-n02</code></pre>
</div>
<p>The <code>pi-submit</code> job (job ID of 12271504) only has task ID
6 running and all the <code>pi-avg</code> jobs are waiting. To confirm
that the other <code>pi-submit</code> tasks have completed, you can use
the command <code>sacct -Xj &lt;pi-submit jobid&gt;</code> e.g.:</p>
<div class="codewrapper sourceCode" id="cb21">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="ex">sacct</span> <span class="at">-Xj</span> 12271504</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>JobID           JobName  Partition    Account  AllocCPUS      State ExitCode 
------------ ---------- ---------- ---------- ---------- ---------- -------- 
12271504_0    pi-submit    regular       wehi          2  COMPLETED      0:0 
12271504_1    pi-submit    regular       wehi          2  COMPLETED      0:0 
12271504_2    pi-submit    regular       wehi          2  COMPLETED      0:0 
12271504_3    pi-submit    regular       wehi          2  COMPLETED      0:0 
12271504_4    pi-submit    regular       wehi          2  COMPLETED      0:0 
12271504_5    pi-submit    regular       wehi          2  COMPLETED      0:0 
12271504_6    pi-submit    regular       wehi          2    RUNNING      0:0</code></pre>
</div>
<p>After a bit of time, you should see the <code>pi-avg</code> job tasks
begin to go through (should be quite quickly as the job is quite
short)</p>
<div class="codewrapper sourceCode" id="cb23">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="ex">squeue</span> <span class="at">-u</span> <span class="va">$USER</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>             JOBID PARTITION     NAME     USER ST       TIME  NODES NODELIST(REASON)
        12271511_3   regular   pi-avg   yang.e CG       0:00      1 sml-n02
        12271511_4   regular   pi-avg   yang.e CG       0:00      1 sml-n02
        12271511_5   regular   pi-avg   yang.e CG       0:00      1 sml-n02</code></pre>
</div>
<p>Depending on how fast you were submitting the jobs, you likely
weren’t able to see all the jobs wait in the queue. However, later we’ll
develop a “driver” script which will automate setting up the
dependencies.</p>

<div id="setting-up-the-final-combine-job" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div id="setting-up-the-final-combine-job" class="callout-inner">
<h3 class="callout-title">Setting up the final <code>combine</code>
job<a class="anchor" aria-label="anchor" href="#setting-up-the-final-combine-job"></a>
</h3>
<div class="callout-content">
<p>Now that you’ve learnt about how to use the
<code>--dependency/-d</code> option, try and setup the final job that
combines the results from <code>pi-avg.sh</code>! Call it
<code>pi-combine.sh</code></p>
<p>Reminder: this job should be a single job, that takes the results of
all the <code>pi-avg.sh</code> and organises the results into a single
file.</p>
<p>Your output should look something like</p>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>100 Average Absolute Error: 0.18431854820252003
1000 Average Absolute Error: 0.034800000000000005
10000 Average Absolute Error: 0.014562903594960003
100000 Average Absolute Error: 0.00271745179748
1000000 Average Absolute Error: 0.0009526517974799999
10000000 Average Absolute Error: 0.00037933179748
100000000 Average Absolute Error: 0.00014778020251999998</code></pre>
</div>
<p>HINT1: use <code>pi-process-input.txt</code> to get the data for the
first column.</p>
<p>HINT2: you will probably need to use: <code>readarray</code>, a
<code>for</code> loop, and <code>cat</code>.</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1">
  Show me the solution
  </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" data-bs-parent="#accordionSolution1" aria-labelledby="headingSolution1">
<div class="accordion-body">
<p>Script could look like:</p>
<div class="codewrapper sourceCode" id="cb28">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="co"># pi-combine.sh</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --job-name=pi-combine</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --output=%x.out</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="co"># read ntrial data into niterations bash array</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a><span class="ex">readarray</span> <span class="at">-t</span> niterations <span class="op">&lt;</span> pi-process-input.txt</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="dt">{</span><span class="dv">0</span><span class="dt">..</span><span class="dv">6</span><span class="dt">}</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a><span class="cf">do</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># get label from niterations array</span></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>    <span class="va">label</span><span class="op">=</span><span class="va">${niterations</span><span class="op">[</span><span class="va">$i</span><span class="op">]</span><span class="va">}</span></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># get average error from pi-avg-${i}.out</span></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>    <span class="va">data</span><span class="op">=</span><span class="va">$(</span><span class="fu">cat</span> pi-avg-<span class="va">${i}</span>.out<span class="va">)</span></span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># print labal with data</span></span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">"</span><span class="va">$label</span><span class="st"> </span><span class="va">$data</span><span class="st">"</span></span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a><span class="cf">done</span></span></code></pre>
</div>
</div>
</div>
</div>
</div>
<p>You should now have <code>pi-submit.sh</code>,
<code>pi-avg.sh</code>, and <code>pi-combine.sh</code> Slurm scripts
which you can now combine into a pipeline! We’ll do this with one more
script, which will be referred to as the “driver” script as it is
“driving” the pipeline. This driver script will submit all the jobs and
set the dependencies.</p>
<p>This script could look like:</p>
<div class="codewrapper sourceCode" id="cb29">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="co"># pi-driver.sh</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="co"># submit the first pi-submit job</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="co"># saves the job ID into the jobid1 variable</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="va">jobid1</span><span class="op">=</span><span class="va">$(</span><span class="ex">sbatch</span> <span class="at">--parsable</span> pi-submit.sh<span class="va">)</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a><span class="co"># submit the second pi-avg job.</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a><span class="co"># due to aftercorr condition, each task </span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a><span class="co"># depends on the same task from pi-submit.sh.</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a><span class="co"># saves the job ID into the jobid2 variable</span></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a><span class="va">jobid2</span><span class="op">=</span><span class="va">$(</span><span class="ex">sbatch</span> <span class="at">--parsable</span> <span class="at">--dependency</span><span class="op">=</span>aftercorr:<span class="va">$jobid1</span> pi-avg.sh<span class="va">)</span></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a><span class="co"># submit the last pi-combine job</span></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a><span class="co"># this job waits for all tasks from jobid2</span></span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a><span class="co"># to complete successfully (afterok).</span></span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a><span class="co"># job ID is not saved as it is not needed.</span></span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a><span class="ex">sbatch</span> <span class="at">--dependency</span><span class="op">=</span>afterok:<span class="va">$jobid2</span> pi-combine.sh</span></code></pre>
</div>
<p>The driver script makes use of the <code>--parsable</code> option
that can be used with <code>sbatch</code>. This makes
<code>sbatch</code> return the job ID <em>only</em>, instead of the
statement <code>Submitted batch job &lt;job ID&gt;</code>. This enables
“parsing” the job ID. In this case, the job IDs are saved into
<code>jobidN</code> bash variables.</p>
<p>The driver script does not need to be submitted, it can be run as a
normal script:</p>
<div class="codewrapper sourceCode" id="cb30">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">chmod</span> +x pi-driver.sh</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="ex">./pi-driver.sh</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Submitted batch job 12271538</code></pre>
</div>
<p>When exeucting the driver script, you should only see one
<code>Submitted batch job</code> statement printed to the terminal, as
the first two jobs are submitted with the <code>--parsable</code> option
and their Job IDs being saved to variables, instead of being printed to
the terminal.</p>
<p>If you run <code>squeue -u $USER</code> <em>immediately</em> after
the completion of the script, you should see your jobs pending in the
queue, similar to:</p>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>             JOBID PARTITION     NAME     USER ST       TIME  NODES NODELIST(REASON)
          12272749   regular pi-combi   yang.e PD       0:00      1 (Dependency)
    12272748_[0-6]   regular   pi-avg   yang.e PD       0:00      1 (None)
    12272747_[0-6]   regular pi-submi   yang.e PD       0:00      1 (None)</code></pre>
</div>
<p>and as you continue checking the queue, you should be able to see
Slurm processing your jobs:</p>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>             JOBID PARTITION     NAME     USER ST       TIME  NODES NODELIST(REASON)
        12272748_6   regular   pi-avg   yang.e PD       0:00      1 (Dependency)
        12272748_5   regular   pi-avg   yang.e PD       0:00      1 (Dependency)
        12272748_4   regular   pi-avg   yang.e PD       0:00      1 (Dependency)
        12272748_3   regular   pi-avg   yang.e PD       0:00      1 (Dependency)
        12272748_2   regular   pi-avg   yang.e PD       0:00      1 (Dependency)
        12272748_1   regular   pi-avg   yang.e PD       0:00      1 (Dependency)
          12272749   regular pi-combi   yang.e PD       0:00      1 (Dependency)
        12272748_0   regular   pi-avg   yang.e PD       0:00      1 (Dependency)
    12272747_[0-6]   regular pi-submi   yang.e PD       0:00      1 (None)</code></pre>
</div>
<p>This shows Slurm “unrolling” the <code>pi-avg</code> job tasks,
and</p>
<pre><code>             JOBID PARTITION     NAME     USER ST       TIME  NODES NODELIST(REASON)
        12272748_6   regular   pi-avg   yang.e PD       0:00      1 (Dependency)
        12272748_5   regular   pi-avg   yang.e PD       0:00      1 (Dependency)
        12272748_4   regular   pi-avg   yang.e PD       0:00      1 (Dependency)
        12272748_3   regular   pi-avg   yang.e PD       0:00      1 (Dependency)
        12272748_2   regular   pi-avg   yang.e PD       0:00      1 (Dependency)
        12272748_1   regular   pi-avg   yang.e PD       0:00      1 (Dependency)
          12272749   regular pi-combi   yang.e PD       0:00      1 (Dependency)
        12272748_0   regular   pi-avg   yang.e PD       0:00      1 (Dependency)
        12272747_0   regular pi-submi   yang.e  R       0:01      1 sml-n10
        12272747_1   regular pi-submi   yang.e  R       0:01      1 sml-n10
        12272747_2   regular pi-submi   yang.e  R       0:01      1 sml-n10
        12272747_3   regular pi-submi   yang.e  R       0:01      1 sml-n10
        12272747_4   regular pi-submi   yang.e  R       0:01      1 sml-n10
        12272747_5   regular pi-submi   yang.e  R       0:01      1 sml-n07
        12272747_6   regular pi-submi   yang.e  R       0:01      1 sml-n07</code></pre>
<p>shows the <code>pi-submit</code> jobs running and the
<code>pi-avg</code> jobs waiting.</p>
<p>If all goes well, you should have a <code>pi-combine.out</code> (or
similar) file with your outputs!</p>
<div class="codewrapper sourceCode" id="cb35">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> pi-combine.out</span></code></pre>
</div>
<pre><code>100 Average Absolute Error: 0.156
1000 Average Absolute Error: 0.05336290359496
10000 Average Absolute Error: 0.00736
100000 Average Absolute Error: 0.00457345179748
1000000 Average Absolute Error: 0.00152585179748
10000000 Average Absolute Error: 0.00048161179748
100000000 Average Absolute Error: 0.00013798799999999997</code></pre>
<p>You can then plot this in Excel or whichever tool you prefer!</p>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Keypoints<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul>
<li>Make a job depend on another with the <code>--dependency</code> or
<code>-d</code> flag for <code>sbatch</code>
<ul>
<li>dependency conditions can be used to control when the dependant job
starts</li>
<li>the full list of conditions can be better understood from
<code>man sbatch</code>.</li>
</ul>
</li>
<li>job dependencies can be combined with job arrays to create
pipelines!</li>
</ul>
</div>
</div>
</div>
<!-- 
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use. 
 -->
</div>
</section></section><section id="aio-06-rpython"><p>Content from <a href="06-rpython.html">R and Python Slurm scripts</a></p>
<hr>
<p> Last updated on 2023-07-11 | 
        
        <a href="https://github.com/WEHI-ResearchComputing/intermediate-slurm/edit/main/episodes/06-rpython.Rmd" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right"> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How do I write Slurm scripts in languages other than Bash?</li>
<li>How can I combine Slurm with other languages?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>How to use different interpreters to write Slurm scripts</li>
<li>How to write job arrays using other languages</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<section id="motivation"><h2 class="section-heading">Motivation<a class="anchor" aria-label="anchor" href="#motivation"></a>
</h2>
<hr class="half-width">
<p>The chances are, when you first started using Slurm, you probably
wasn’t all that familiar with Bash. But you begrudgingly learnt it so
you can make use of the computational capabilities of HPC. If you’re a
Python or R user, you probably wrote a script which performed a part of
your analysis, and you might use this script on HPC with a wrapper
submission script that looks like:</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --cpus-per-task=2</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --mem=4G</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="ex">Rscript</span> myRscript.R <span class="op">&lt;</span>arguments<span class="op">&gt;</span></span></code></pre>
</div>
<p>And that’s all it really does. But did you know you can bypass this
wrapper script by submitting the R/python script directly?</p>
</section><section id="a-python-script"><h2 class="section-heading">A Python script<a class="anchor" aria-label="anchor" href="#a-python-script"></a>
</h2>
<hr class="half-width">
<p>Let’s consider a Python script <code>pi.py</code> that calculates
<span class="math inline">\(\pi\)</span>:</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># pi.py</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys, random</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># function to calculate pi</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calc_pi(numtrials):</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(numtrials):</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>        r1 <span class="op">=</span> random.random()</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>        r2 <span class="op">=</span> random.random()</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (r1<span class="op">*</span>r1 <span class="op">+</span> r2<span class="op">*</span>r2 <span class="op">&lt;</span> <span class="fl">1.</span>):</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>            n <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fl">4.</span><span class="op">*</span>n<span class="op">/</span>numtrials</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># get number of trials from first command line argument</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># produce error if it doesn't work.</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>        numtrials <span class="op">=</span> <span class="bu">int</span>(sys.argv[<span class="dv">1</span>])</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span>:</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>        sys.exit(<span class="st">"There was a problem parsing the command-line arguments</span><span class="ch">\n</span><span class="st">Did you remember to pass an integer?"</span>)</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># calculate pi and error</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>    pi <span class="op">=</span> calc_pi(numtrials)</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>    err <span class="op">=</span> <span class="fl">3.141592653589793</span> <span class="op">-</span> pi</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># print to terminal</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Result: </span><span class="sc">{</span>pi<span class="sc">}</span><span class="ss">, Error: </span><span class="sc">{</span>err<span class="sc">}</span><span class="ss">"</span>)</span></code></pre>
</div>
<p>Which you can run by</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">python3</span> pi.py 123456789</span></code></pre>
</div>
<p>which calculates <span class="math inline">\(\pi\)</span> with
123,456,789 trials. The output should look similar to</p>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Result: 3.1416309393888415, Error: -3.8285799048409785e-05</code></pre>
</div>
<div id="submitting-this-script-to-slurm" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div id="submitting-this-script-to-slurm" class="callout-inner">
<h3 class="callout-title">Submitting this script to Slurm<a class="anchor" aria-label="anchor" href="#submitting-this-script-to-slurm"></a>
</h3>
<div class="callout-content">
<p>Instead of following the common pattern of writing a wrapper
submissions script, try submitting this Python script directly to
Slurm!</p>
<p>You will need to follow the Slurm error messages to convert this into
a working Slurm script.</p>
<p>Hint: you can use the system interpreter located in
<code>/usr/bin/python3</code>.</p>
<p>Once you have it working as a Slurm script, try adding
<code>#SBATCH</code> options like you would in a “normal” Slurm
script.</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1">
  Show me the solution
  </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" aria-labelledby="headingSolution1" data-bs-parent="#accordionSolution1">
<div class="accordion-body">
<p>When submitting this script as-is with <code>sbatch pi.py</code>,
you’ll get the error:</p>
<div class="codewrapper">
<h3 class="code-label">ERROR<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="error" tabindex="0"><code>sbatch: error: This does not look like a batch script.  The first
sbatch: error: line must start with #! followed by the path to an interpreter.
sbatch: error: For instance: #!/bin/sh</code></pre>
</div>
<p>This is a reminder that your script needs to have a hash-bang
statement which specifies which the interpreter to use!</p>
<p>In this lesson, we’ve used <code>/bin/bash</code> all throughout,
although <code>/bin/sh</code> is also common to see “out in the wild”.
But in this case, we need to use a Python interpreter instead. We can
add to the top of the script: <code>#!/usr/bin/python3</code> which is
installed on Milton. Once we do that, our script should work!</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="ex">sbatch</span> pi.py 123456789</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Submitted batch job 12261934</code></pre>
</div>
<p>After about 40 seconds of the job running the corresponding
<code>slurm-12261934.out</code> file should be ready:</p>
<pre><code>Result: 3.1417136565895944, Error: -0.000121002999801334</code></pre>
<p>Which shows that it now works as a Slurm script!</p>
<p>This particular program doesn’t need much resources, but we can still
check that <code>#SBATCH</code> options still work with
<code>squeue</code>, <code>sacct</code>, or <code>seff</code>. If you
add <code>#SBATCH --cpus-per-task=4</code> below the hash-bang statement
and submit the script, you should see through your preferred query
command that the job is now requesting 4 CPUs.</p>
</div>
</div>
</div>
</div>
</section><section id="which-interpreter"><h2 class="section-heading">Which interpreter?<a class="anchor" aria-label="anchor" href="#which-interpreter"></a>
</h2>
<hr class="half-width">
<p>In the above challenge, we used the system Python interpreter.
However, you often use Python from a virtual or conda environment; and R
from a module. Consequently, choosing the correct interpreter is
important so that your packages are picked up properly!</p>
<div class="section level3">
<h3 id="the-reproducible-way-but-less-portable">The reproducible way (but less portable)<a class="anchor" aria-label="anchor" href="#the-reproducible-way-but-less-portable"></a>
</h3>
<p>The <em>safest</em> way to ensure your preferred interpreter is used
is to hard-code the path into the hash-bang statement at the top of the
script.</p>
<p>For example, if you have an environment located at
<code>/vast/scratch/users/&lt;userid&gt;/mycondaenv</code>, the
corresponding interpreter is located in
<code>/vast/scratch/users/&lt;userid&gt;/mycondaenv/bin/python</code>,
which you can use in the hash-bang statement. Similarly, with
<code>Rscript</code>, you can find where your preferred
<code>Rscript</code> interepreter is by:</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="ex">module</span> show R/<span class="op">&lt;</span>preferred version<span class="op">&gt;</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>/stornext/System/data/apps/R/R-&lt;version&gt;/lib64/R/bin</code></pre>
</div>
<p>and you can add <code>Rscript</code> to the end of the path and place
it in the hash-bang statement e.g.,
<code>#!/stornext/System/data/apps/R/R-4.2.1/lib64/R/bin/Rscript</code>.
This way ensures the same interpreter are used every time</p>
</div>
<div class="section level3">
<h3 id="the-portable-way-but-less-reproducible">The portable way (but less reproducible)<a class="anchor" aria-label="anchor" href="#the-portable-way-but-less-reproducible"></a>
</h3>
<p>A common approach is to infer which interpreter to use based on your
environment. To do this, you can add the
<code>/usr/bin/env &lt;interpreter&gt;</code> command (note the space
between <code>/usr/bin/env</code> and <code>&lt;interpreter&gt;</code>).
For example, adding <code>#!/usr/bin/env python</code> as your hash-bang
statement will pickup whichever python interpreter is in your
environment.</p>
<p>This is more portable and often more convenient, but can be less
reproducible as you may forget which environment it was supposed to run
with, or which version of the interpreter was used.</p>
</div>
</section><section id="slurm-environment-variables"><h2 class="section-heading">Slurm Environment Variables<a class="anchor" aria-label="anchor" href="#slurm-environment-variables"></a>
</h2>
<hr class="half-width">
<p>Both R and Python have their own ways of accessing environment
variables. For example, in Bash, saving the
<code>SLURM_CPUS_PER_TASK</code> environment variable is done by</p>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="va">cpus</span><span class="op">=</span><span class="va">${SLURM_CPUS_PER_TASK}</span></span></code></pre>
</div>
<p>Whereas, for Python and R, respectively:</p>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>cpus <span class="op">=</span> os.getenv(<span class="st">"SLURM_CPUS_PER_TASK"</span>)</span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cpus</span> <span class="op">=</span> <span class="fu">Sys.getenv</span><span class="op">(</span><span class="st">"SLURM_CPUS_PER_TASK"</span><span class="op">)</span></span></code></pre>
</div>
</section><section id="setting-up-job-arrays"><h2 class="section-heading">Setting Up Job Arrays<a class="anchor" aria-label="anchor" href="#setting-up-job-arrays"></a>
</h2>
<hr class="half-width">
<p>But a major advantage Python and R have over Bash is their ability to
parse text either natively or through installable packages</p>
<p>For example, let’s take our <code>iter-cpu.txt</code> file that we
created back in episode 4 (job arrays):</p>
<pre><code>iters cpus
100 2
100 4
1000 2
1000 4
10000 2
10000 4</code></pre>
<p>To read this file in Python, we can use the pandas module:</p>
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> pd.read_csv(<span class="st">'iter-cpu.txt'</span>, delimiter<span class="op">=</span><span class="st">' '</span>)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(data)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>   iters  cpus
0    100     2
1    100     4
2   1000     2
3   1000     4
4  10000     2
5  10000     4</code></pre>
</div>
<p>For R, it’s even easier:</p>
<div class="codewrapper sourceCode" id="cb17">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data</span> <span class="op">=</span> <span class="fu">read.csv</span><span class="op">(</span><span class="st">'iter-cpu.txt'</span>, sep<span class="op">=</span><span class="st">' '</span><span class="op">)</span></span>
<span><span class="fu">str</span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>'data.frame':   6 obs. of  2 variables:
 $ iters: int  100 100 1000 1000 10000 10000
 $ cpus : int  2 4 2 4 2 4</code></pre>
</div>
<div id="discussion2" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge<a class="anchor" aria-label="anchor" href="#discussion2"></a>
</h3>
<div class="callout-content">
<p>Now that you know how to turn a Python or R script into a Slurm
script. Try to create a Slurm array script in Python or R where:</p>
<ul>
<li>each array task reads the <code>iter-cpu.txt</code> file and</li>
<li>each array task prints a statement like:
<code>CPUs: &lt;n&gt;, Iterations: &lt;n&gt;</code>, where
<code>&lt;n&gt;</code> is the corresponding column and row of
<code>iter-cpu.txt</code>.</li>
</ul>
<p>For example, array task 0 should print out:</p>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>CPUs: 2, Iterations: 100</code></pre>
</div>
<p>HINT: you can make use of the
<code>#!/usr/bin/env python3 (or Rscript)</code> hash-bang statement for
convenience.</p>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2">
  Show me the solution
  </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" aria-labelledby="headingSolution2" data-bs-parent="#accordionSolution2">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb20">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/usr/bin/env python3</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --array=0-5</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --mem=1G</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os, pandas <span class="im">as</span> pd</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> pd.read_csv(<span class="st">'iter-cpu.txt'</span>, delimiter<span class="op">=</span><span class="st">' '</span>)</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>taskid <span class="op">=</span> <span class="bu">int</span>(os.getenv(<span class="st">"SLURM_ARRAY_TASK_ID"</span>))</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>niter <span class="op">=</span> data[<span class="st">'iters'</span>].iloc[taskid]</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>ncpus <span class="op">=</span> data[<span class="st">'cpus'</span>].iloc[taskid]</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'CPUs: </span><span class="sc">{</span>ncpus<span class="sc">}</span><span class="ss">, Iterations: </span><span class="sc">{</span>niter<span class="sc">}</span><span class="ss">'</span>)</span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb21">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#!/usr/bin/env Rscript</span></span>
<span><span class="co">#SBATCH --array=1-6</span></span>
<span><span class="co">#SBATCH --mem=1G</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="fu">read.csv</span><span class="op">(</span><span class="st">'iter-cpu.txt'</span>, sep<span class="op">=</span><span class="st">' '</span><span class="op">)</span></span>
<span></span>
<span><span class="va">taskid</span> <span class="op">=</span> <span class="fu">as.integer</span><span class="op">(</span><span class="fu">Sys.getenv</span><span class="op">(</span><span class="st">"SLURM_ARRAY_TASK_ID"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ncpus</span> <span class="op">=</span> <span class="va">data</span><span class="op">[[</span><span class="st">"cpus"</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="va">taskid</span><span class="op">]</span></span>
<span><span class="va">niter</span> <span class="op">=</span> <span class="va">data</span><span class="op">[[</span><span class="st">"iters"</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="va">taskid</span><span class="op">]</span></span>
<span></span>
<span><span class="fu">paste0</span><span class="op">(</span><span class="st">"CPUs: "</span>, <span class="va">ncpus</span>,<span class="st">', Iterations: '</span>, <span class="va">niter</span><span class="op">)</span></span></code></pre>
</div>
<p>When using Slurm array jobs, remember to make use of appropriate
exception handling! With Python, you can make use of <code>try</code>,
<code>except</code>, and for R, you can check whether
<code>Sys.getenv("SLURM_ARRAY_TASK_ID")</code> returns
<code>NA</code>.</p>
</div>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Keypoints<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul>
<li>Besides the code itself, the only <em>real</em> difference between a
bash Slurm script and a Python or R Slurm script, is the hash-bang
statement!</li>
<li>You can change the hash-bang statement to the <code>python</code> or
<code>Rscript</code> interpreter you wish to use, or you can make use of
<code>/usr/bin/env python</code> to determine which interpreter to use
from your environment.</li>
<li>When using Slurm environment variables in a Python or R script, the
same environment variables are available to you, but you must access
them in the Python/R way.</li>
<li>Using Python or R Slurm scripts means you can
<ol style="list-style-type: lower-alpha">
<li>program in a language more familiar to you</li>
<li>make use of their broad functionality and packages</li>
<li>remove the need to have a wrapper Slurm script around your Python/R
scripts.</li>
</ol>
</li>
</ul>
</div>
</div>
</div>
<!-- 
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use. 
 -->
</section></section>
</div>
    </main>
</div>
<!-- END  : inst/pkgdown/templates/content-extra.html -->

      </div>
<!--/div.row-->
      		<footer class="row footer mx-md-3"><hr>
<div class="col-md-6">
				<p>This lesson is subject to the <a href="CODE_OF_CONDUCT.html">Code of Conduct</a></p>
        <p>
        
        <a href="https://github.com/WEHI-ResearchComputing/intermediate-slurm/edit/main/README.md" class="external-link">Edit on GitHub</a>
        
	
        | <a href="https://github.com/WEHI-ResearchComputing/intermediate-slurm/blob/main/CONTRIBUTING.md" class="external-link">Contributing</a> 
        | <a href="https://github.com/WEHI-ResearchComputing/intermediate-slurm/" class="external-link">Source</a></p>
				<p><a href="https://github.com/WEHI-ResearchComputing/intermediate-slurm/blob/main/CITATION" class="external-link">Cite</a> | <a href="mailto:research.computing@wehi.edu.au">Contact</a> | <a href="https://carpentries.org/about/" class="external-link">About</a></p>
			</div>
			<div class="col-md-6">
        
        <p>Materials licensed under <a href="LICENSE.html">CC-BY 4.0</a> by the authors</p>
        
        <p><a href="https://creativecommons.org/licenses/by-sa/4.0/" class="external-link">Template licensed under CC-BY 4.0</a> by <a href="https://carpentries.org" class="external-link">The Carpentries</a></p>
        <p>Built with <a href="https://github.com/carpentries/sandpaper" class="external-link">sandpaper (0.12.5)</a>,
        <a href="https://github.com/carpentries/pegboard" class="external-link">pegboard (0.5.3)</a>,
      and <a href="https://github.com/carpentries/varnish/tree/0.2.17" class="external-link">varnish (0.2.17)</a>.</p>
			</div>
		</footer>
</div> <!-- / div.container -->
	<div id="to-top">
		<a href="#top">
			<i class="search-icon" data-feather="arrow-up" role="img" aria-label="Back to top"></i><br><span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top
		</a>
	</div>
  <script type="application/ld+json">
    {
  "@context": "https://schema.org",
  "@type": "TrainingMaterial",
  "@id": "https://WEHI-ResearchComputing.github.io/intermediate-slurm/aio.html",
  "dct:conformsTo": "https://bioschemas.org/profiles/TrainingMaterial/1.0-RELEASE",
  "description": "A Carpentries Lesson teaching foundational data and coding skills to researchers worldwide",
  "keywords": "Slurm, HPC",
  "name": "All in One View",
  "creativeWorkStatus": "active",
  "url": "https://WEHI-ResearchComputing.github.io/intermediate-slurm/aio.html",
  "identifier": "https://WEHI-ResearchComputing.github.io/intermediate-slurm/aio.html",
  "dateCreated": "2023-04-13",
  "dateModified": "2023-08-08",
  "datePublished": "2023-08-08"
}

  </script><script>
		feather.replace();
	</script><!-- Matomo
    2022-11-07: we have gotten a notification that we have an overage for our
    tracking and I'm pretty sure this has to do with Workbench usage.
    Considering that I am not _currently_ using this tracking because I do not
    yet know how to access the data, I am turning this off for now.
  <script>
    var _paq = window._paq = window._paq || [];
    /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
    _paq.push(["setDocumentTitle", document.domain + "/" + document.title]);
    _paq.push(["setDomains", ["*.preview.carpentries.org","*.datacarpentry.github.io","*.datacarpentry.org","*.librarycarpentry.github.io","*.librarycarpentry.org","*.swcarpentry.github.io", "*.carpentries.github.io"]]);
    _paq.push(["setDoNotTrack", true]);
    _paq.push(["disableCookies"]);
    _paq.push(['trackPageView']);
    _paq.push(['enableLinkTracking']);
    (function() {
          var u="https://carpentries.matomo.cloud/";
          _paq.push(['setTrackerUrl', u+'matomo.php']);
          _paq.push(['setSiteId', '1']);
          var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
          g.async=true; g.src='https://cdn.matomo.cloud/carpentries.matomo.cloud/matomo.js'; s.parentNode.insertBefore(g,s);
        })();
  </script>
  End Matomo Code -->
</body>
</html><!-- END:   inst/pkgdown/templates/layout.html-->

