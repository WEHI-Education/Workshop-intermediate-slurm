<!DOCTYPE html>
<!-- START: inst/pkgdown/templates/layout.html --><!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><title>Intermediate Slurm: Monitoring a Jobs performance</title><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="stylesheet" type="text/css" href="assets/styles.css"><script src="assets/scripts.js" type="text/javascript"></script><!-- mathjax --><script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      config: ["MMLorHTML.js"],
      jax: ["input/TeX","input/MathML","output/HTML-CSS","output/NativeMML", "output/PreviewHTML"],
      extensions: ["tex2jax.js","mml2jax.js","MathMenu.js","MathZoom.js", "fast-preview.js", "AssistiveMML.js", "a11y/accessibility-menu.js"],
      TeX: {
        extensions: ["AMSmath.js","AMSsymbols.js","noErrors.js","noUndefined.js"]
      },
      tex2jax: {
        inlineMath: [['\\(', '\\)']],
        displayMath: [ ['$$','$$'], ['\\[', '\\]'] ],
        processEscapes: true
      }
    });
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><!-- Responsive Favicon for The Carpentries --><link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png"><link rel="manifest" href="site.webmanifest"><link rel="mask-icon" href="safari-pinned-tab.svg" color="#5bbad5"><meta name="msapplication-TileColor" content="#da532c"><meta name="theme-color" content="#ffffff"></head><body>
    <header id="top" class="navbar navbar-expand-md navbar-light bg-white top-nav incubator"><a class="visually-hidden-focusable skip-link" href="#main-content">Skip to main content</a>
  <div class="container-fluid top-nav-container">
    <div class="col-md-6">
      <div class="large-logo">
        <img alt="Carpentries Incubator" src="assets/images/incubator-logo.svg"><abbr class="badge badge-light" title="This lesson is in the pre-alpha phase, which means that it is in early development, but has not yet been taught." style="background-color: #FF4955; border-radius: 5px">
          <a href="https://cdh.carpentries.org/the-lesson-life-cycle.html#early-development-pre-alpha-through-alpha" class="external-link alert-link" style="color: #000">
            <i aria-hidden="true" class="icon" data-feather="alert-octagon" style="border-radius: 5px"></i>
            Pre-Alpha
          </a>
          <span class="visually-hidden">This lesson is in the pre-alpha phase, which means that it is in early development, but has not yet been taught.</span>
        </abbr>
        
      </div>
    </div>
    <div class="selector-container">
      
      
      <div class="dropdown">
        <button class="btn btn-secondary dropdown-toggle bordered-button" type="button" id="dropdownMenu1" data-bs-toggle="dropdown" aria-expanded="false">
          <i aria-hidden="true" class="icon" data-feather="eye"></i> Learner View <i data-feather="chevron-down"></i>
        </button>
        <ul class="dropdown-menu" aria-labelledby="dropdownMenu1"><li><button class="dropdown-item" type="button" onclick="window.location.href='instructor/02-cpumonitoring.html';">Instructor View</button></li>
        </ul></div>
    </div>
  </div>
  <hr></header><nav class="navbar navbar-expand-xl navbar-light bg-white bottom-nav incubator" aria-label="Main Navigation"><div class="container-fluid nav-container">
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle Navigation">
      <span class="navbar-toggler-icon"></span>
      <span class="menu-title">Menu</span>
    </button>
    <div class="nav-logo">
      <img class="small-logo" alt="Carpentries Incubator" src="assets/images/incubator-logo-sm.svg"></div>
    <div class="lesson-title-md">
      Intermediate Slurm
    </div>
    <div class="search-icon-sm">
      <!-- TODO: do not show until we have search
        <i role="img" aria-label="search button" data-feather="search"></i>
      -->
    </div>
    <div class="desktop-nav">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0"><li class="nav-item">
          <span class="lesson-title">
            Intermediate Slurm
          </span>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="key-points.html">Key Points</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="reference.html#glossary">Glossary</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="profiles.html">Learner Profiles</a>
        </li>
        <li class="nav-item dropdown">
          <button class="nav-link dropdown-toggle" id="navbarDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            More <i data-feather="chevron-down"></i>
          </button>
          <ul class="dropdown-menu" aria-labelledby="navbarDropdown"><li><a class="dropdown-item" href="reference.html">Reference</a></li>
          </ul></li>
      </ul></div>
    <form class="d-flex col-md-2 search-form">
      <fieldset disabled><input class="form-control me-2 searchbox" type="search" placeholder="Search" aria-label="Search"><button class="btn btn-outline-success tablet-search-button" type="submit">
          <i class="search-icon" data-feather="search" role="img" aria-label="search button"></i>
        </button>
      </fieldset></form>
  </div><!--/div.container-fluid -->
</nav><div class="col-md-12 mobile-title">
  Intermediate Slurm
</div>

<aside class="col-md-12 lesson-progress"><div style="width: 17%" class="percentage">
    17%
  </div>
  <div class="progress incubator">
    <div class="progress-bar incubator" role="progressbar" style="width: 17%" aria-valuenow="17" aria-label="Lesson Progress" aria-valuemin="0" aria-valuemax="100">
    </div>
  </div>
</aside><div class="container">
      <div class="row">
        <!-- START: inst/pkgdown/templates/navbar.html -->
<div id="sidebar-col" class="col-lg-4">
  <div id="sidebar" class="sidebar">
      <nav aria-labelledby="flush-headingEleven"><button role="button" aria-label="close menu" alt="close menu" aria-expanded="true" aria-controls="sidebar" class="collapse-toggle" data-collapse="Collapse " data-episodes="Episodes ">
          <i class="search-icon" data-feather="x" role="img"></i>
        </button>
        <div class="sidebar-inner">
          <div class="row mobile-row">
            <div class="col">
              <div class="sidenav-view-selector">
                <div class="accordion accordion-flush" id="accordionFlush9">
                  <div class="accordion-item">
                    <h2 class="accordion-header" id="flush-headingNine">
                      <button class="accordion-button collapsed" id="instructor" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseNine" aria-expanded="false" aria-controls="flush-collapseNine">
                        <i id="eye" aria-hidden="true" class="icon" data-feather="eye"></i> Learner View
                      </button>
                    </h2>
                    <div id="flush-collapseNine" class="accordion-collapse collapse" aria-labelledby="flush-headingNine" data-bs-parent="#accordionFlush2">
                      <div class="accordion-body">
                        <a href="instructor/02-cpumonitoring.html">Instructor View</a>
                      </div>
                    </div>
                  </div><!--/div.accordion-item-->
                </div><!--/div.accordion-flush-->
              </div><!--div.sidenav-view-selector -->
            </div><!--/div.col -->
      
            <hr></div><!--/div.mobile-row -->

          <div class="accordion accordion-flush" id="accordionFlush11">
            <div class="accordion-item">

              <button id="chapters" class="accordion-button show" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseEleven" aria-expanded="false" aria-controls="flush-collapseEleven">
                <h2 class="accordion-header chapters" id="flush-headingEleven">
                  EPISODES
                </h2>
              </button>
              <div id="flush-collapseEleven" class="accordion-collapse show collapse" aria-labelledby="flush-headingEleven" data-bs-parent="#accordionFlush11">

                <div class="accordion-body">
                  <div class="accordion accordion-flush" id="accordionFlush1">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading1">
        <a href="index.html">Summary and Setup</a>
    </div><!--/div.accordion-header-->
        
  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush2">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading2">
        <a href="01-introduction.html">1. Introduction</a>
    </div><!--/div.accordion-header-->
        
  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlushcurrent">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-headingcurrent">
      <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapsecurrent" aria-expanded="true" aria-controls="flush-collapsecurrent">
        <span class="visually-hidden">Current Chapter</span>
        <span class="current-chapter">
        2. Monitoring a Jobs performance
        </span>
      </button>
    </div><!--/div.accordion-header-->
        
    <div id="flush-collapsecurrent" class="accordion-collapse collapse show" aria-labelledby="flush-headingcurrent" data-bs-parent="#accordionFlushcurrent">
      <div class="accordion-body">
        <ul><li><a href="#calculating-pi">Calculating <span class="math inline">\(\pi\)</span></a></li>
<li><a href="#check-1-is-it-really-working-in-parallel">Check 1: Is it really working in parallel?</a></li>
<li><a href="#looking-through-help-and-documentation">Looking through help and documentation</a></li>
        </ul></div><!--/div.accordion-body-->
    </div><!--/div.accordion-collapse-->
        
  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush4">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading4">
        <a href="03-moremonitoring.html">3. Memory and GPU utilization</a>
    </div><!--/div.accordion-header-->
        
  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush5">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading5">
        <a href="04-jobarrays.html">4. Job Arrays</a>
    </div><!--/div.accordion-header-->
        
  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush6">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading6">
        <a href="05-jobdependencies.html">5. Organising dependent Slurm jobs</a>
    </div><!--/div.accordion-header-->
        
  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush7">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading7">
        <a href="06-rpython.html">6. R and Python Slurm scripts</a>
    </div><!--/div.accordion-header-->
        
  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

                </div>
              </div>
            </div>

            <hr class="half-width"><div class="accordion accordion-flush resources" id="accordionFlush12">
              <div class="accordion-item">
                <h2 class="accordion-header" id="flush-headingTwelve">
                  <button class="accordion-button collapsed" id="resources" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseTwelve" aria-expanded="false" aria-controls="flush-collapseTwelve">
                    RESOURCES
                  </button>
                </h2>
                <div id="flush-collapseTwelve" class="accordion-collapse collapse" aria-labelledby="flush-headingTwelve" data-bs-parent="#accordionFlush12">
                  <div class="accordion-body">
                    <ul><li>
                        <a href="key-points.html">Key Points</a>
                      </li>
                      <li>
                        <a href="reference.html#glossary">Glossary</a>
                      </li>
                      <li>
                        <a href="profiles.html">Learner Profiles</a>
                      </li>
                      <li><a href="reference.html">Reference</a></li>
                    </ul></div>
                </div>
              </div>
            </div>
            <hr class="half-width resources"><a href="aio.html">See all in one page</a>
            

            <hr class="d-none d-sm-block d-md-none"><div class="d-grid gap-1">
            
            </div>
          </div><!-- /div.accordion -->
        </div><!-- /div.sidebar-inner -->
      </nav></div><!-- /div.sidebar -->
  </div><!-- /div.sidebar-col -->
<!-- END:   inst/pkgdown/templates/navbar.html-->

        <!-- START: inst/pkgdown/templates/content-instructor.html -->
  <div class="col-xl-8 col-lg-12 primary-content">
    <nav class="lesson-content mx-md-4" aria-label="Previous and Next Chapter"><!-- content for small screens --><div class="d-block d-sm-block d-md-none">
        <a class="chapter-link" href="01-introduction.html"><i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>Previous</a>
        <a class="chapter-link float-end" href="03-moremonitoring.html">Next<i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i></a>
      </div>
      <!-- content for large screens -->
      <div class="d-none d-sm-none d-md-block">
        <a class="chapter-link" href="01-introduction.html" rel="prev">
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>
          Previous: Introduction
        </a>
        <a class="chapter-link float-end" href="03-moremonitoring.html" rel="next">
          Next: Memory and GPU... 
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i>
        </a>
      </div>
      <hr></nav><main id="main-content" class="main-content"><div class="container lesson-content">
        <h1>Monitoring a Jobs performance</h1>
        <p>Last updated on 2023-11-21 |
        
        <a href="https://github.com/WEHI-ResearchComputing/intermediate-slurm/edit/main/episodes/02-cpumonitoring.Rmd" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
        
        
        
        <div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>

        

<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul><li>Why should I learn to monitor performance of my Slurm jobs?</li>
<li>Which tools can I use to monitor my jobs’ activity?</li>
</ul></div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul><li>Understand why jobs should be monitored carefully.</li>
<li>Show common tools to use to monitor jobs’ activity and
performance.</li>
<li>Demonstrate a general procedure to investigate why a job may not be
performing as expected.</li>
</ul></div>
</div>
</div>
</div>
</div>
<section id="calculating-pi"><h2 class="section-heading">Calculating <span class="math inline">\(\pi\)</span><a class="anchor" aria-label="anchor" href="#calculating-pi"></a>
</h2>
<hr class="half-width"><p>You’re an honours student and your project is looking at ways of
calculating <span class="math inline">\(\pi\)</span>. Your PI has
recommended using an existing piece of software he saw someone talk
about at a conference recently. A useful feature is that it works in
parallel, and is consequently quite fast! You try running the program on
your laptop, and it takes about 1.2 seconds for each calculation of
<span class="math inline">\(\pi\)</span>. This is a little slow, so you
try running it on Milton</p>
<div id="running-the-program" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div id="running-the-program" class="callout-inner">
<h3 class="callout-title">Running the Program<a class="anchor" aria-label="anchor" href="#running-the-program"></a>
</h3>
<div class="callout-content">
<p>In the example-programs.zip file, is the <code>pi-cpu</code>
executable. This is the program your supervisor has recommended.
<strong>Try running it with <code>srun</code> on Milton!</strong> Does
it perform each calculation of <span class="math inline">\(\pi\)</span>
in less time than 1.2s?</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1">Show me the solution</h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" data-bs-parent="#accordionSolution1" aria-labelledby="headingSolution1">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">srun</span> pi-cpu</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>srun: job 11087600 queued and waiting for resources
srun: job 11087600 has been allocated resources
Result: 3.1414796637875 Error: -0.0001130772251 Time: 3.0970s
Result: 3.1417489401899 Error:  0.0001561991773 Time: 3.0912s
Result: 3.1415377569880 Error: -0.0000549840246 Time: 3.1001s
...</code></pre>
</div>
<p>Each calculation of <span class="math inline">\(\pi\)</span> takes
about 3 seconds - <em>slower</em> than your laptop! This is something to
remember about HPC: The main reason why HPC is “faster” is because it
has <em>many</em> CPU cores, but the cores working individually are
probably slower than your PC’s CPU cores. HPC’s usefulness comes from
hundreds or thousands of CPU cores working in parallel!</p>
</div>
</div>
</div>
</div>
<p>You tell your supervisor that HPC isn’t helping! But they assure you
that it should be really fast - the presenter at the conference
demonstrated times way less than 3 seconds!</p>
<p>Your job now is to figure out why <code>pi-cpu</code> isn’t
performing fast for you.</p>
</section><section id="check-1-is-it-really-working-in-parallel"><h2 class="section-heading">Check 1: Is it really working in parallel?<a class="anchor" aria-label="anchor" href="#check-1-is-it-really-working-in-parallel"></a>
</h2>
<hr class="half-width"><p>So far, we’ve only <em>heard</em> that the software works by
performing computations in parallel with multiple CPUs. One way we can
verify this is with the <code>htop</code> tool.</p>
<p><code>htop</code> is an interactive “process” viewer that lets you
monitor processes across the entire node. It’s very similar to Task
Manager on Windows or Activity Monitor on Macs, but it works from the
command line!</p>
<div class="section level3">
<h3 id="interpreting-htops-output">Interpreting <code>htop</code>’s output<a class="anchor" aria-label="anchor" href="#interpreting-htops-output"></a></h3>
<p>Try running <code>htop</code> on the login node. You should get
something similar to below:</p>
<figure><img src="fig/htop-screenshot.png" alt="" class="figure mx-auto d-block"><figcaption>Screenshot of <code>htop</code> output</figcaption></figure><p><code>htop</code> gives a lot of information, so here is a quick
explainer on what is being shown.</p>
<p>At the top of the <code>htop</code> output, you’ll see multiple bars
and each bar tells you the activity level of a single CPU core. If a bar
is at 100%, then that means that that CPU core is completely busy.</p>
<figure><img src="fig/htop-screenshot-cpubars.png" alt="" class="figure mx-auto d-block"><figcaption>CPU utilization bars from <code>htop</code></figcaption></figure><p>Below the bar, on the left side, is another bar which tells you how
much of the node’s memory is occupied. Next to the bar is information
about how much load the node is under.</p>
<figure><img src="fig/htop-screenshot-memload.png" alt="" class="figure mx-auto d-block"><figcaption>Memory utilization bars and load from
<code>htop</code></figcaption></figure><p>Everything below that is most important to monitoring your jobs. That
table is a dynamic list of “processes” running on the node. And each
column tells you a bit of different information about the process.</p>
<figure><img src="fig/htop-screenshot-procs.png" alt="" class="figure mx-auto d-block"><figcaption>Process list and fields from <code>htop</code></figcaption></figure><ol style="list-style-type: decimal"><li>
<code>RES</code> tells you the “resident” memory of the process,
i.e., the memory (in bytes) being used by the process.</li>
<li>
<code>CPU%</code> is the percentage of a CPU core the process is
using.</li>
<li>
<code>Command</code> is telling you the command the process is
running. This can be used to help you figure out which processes are
related to your job.</li>
</ol><p>By default, <code>htop</code> will show you <em>everyone’s</em>
processes, which is not relevant to us. To get only your processes, quit
<code>htop</code> by pressing <code>q</code>, and run it again with</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">htop</span> <span class="at">-u</span> <span class="va">$USER</span></span></code></pre>
</div>
<p>You should see a list of processes that belong to you only!</p>
</div>
<div class="section level3">
<h3 id="monitoring-pi-cpu-with-htop">Monitoring <code>pi-cpu</code> with <code>htop</code>
<a class="anchor" aria-label="anchor" href="#monitoring-pi-cpu-with-htop"></a></h3>
<p>This time, we’re going to submit the <code>pi-cpu</code> command as a
job with <code>sbatch</code>. We’re also going to add the
<code>-r -1</code> flag and value, so that the program will run
indefinitely. We can do so by</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ex">sbatch</span> <span class="at">--wrap</span><span class="op">=</span><span class="st">"srun ./pi-cpu -r -1"</span></span></code></pre>
</div>

<div id="sbatch---wrap" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div id="sbatch---wrap" class="callout-inner">
<h3 class="callout-title">
<code>sbatch --wrap</code><a class="anchor" aria-label="anchor" href="#sbatch---wrap"></a>
</h3>
<div class="callout-content">
<p>the <code>--wrap</code> option lets us pass a singular command to
<code>sbatch</code> without having to write an entire script! This is
useful for debugging and when you run <code>sbatch</code> inside
scripts.</p>
</div>
</div>
</div>
<p>Once you’ve confirmed the job has started with <code>squeue</code>,
and determined which node it’s running on, <code>ssh</code> to that node
and run <code>htop -u $USER</code>.</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ex">sbatch</span> <span class="at">--wrap</span><span class="op">=</span><span class="st">"srun ./pi-cpu -r -1"</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Submitted batch job 11088927</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ex">squeue</span> <span class="at">-u</span> <span class="va">$USER</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>     JOBID PARTITION     NAME     USER ST       TIME  NODES NODELIST(REASON)
  11088927   regular     wrap   yang.e  R       0:12      1 sml-n15</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ssh</span> sml-n15</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>yang.e@sml-n15s password: # enter your password
Last login: Fri Apr 14 14:40:38 2023 from slurm-login.hpc.wehi.edu.au</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="ex">htop</span> <span class="at">-u</span> <span class="va">$USER</span></span></code></pre>
</div>
<figure><img src="fig/htop-picpu-1.png" alt="" class="figure mx-auto d-block"><figcaption>processes associated with <code>pi-cpu</code></figcaption></figure><p>From the <code>Command</code> column, you can find the relevant data
for your job.</p>
<p>Hint: You can click on <code>CPU%</code> to sort processes by their
CPU usage.</p>

<p>If we look at the <code>CPU%</code> column, we can see that the
<code>pi-cpu</code> process is using 100%! That might sound good, but
the percentage is the percentage of a CPU <em>core</em> being used,
i.e., 100% means that 100% of a single CPU core is being used, or 200%
means 100% of two CPU core are being used. So, the <code>pi-cpu</code>
process is only using 1 CPU core i.e., not parallel! This is not what
your PI promised!</p>
<p>But maybe it’s because we didn’t request more CPUs? We didn’t ask for
any specific number of CPUs in our command after all. Let’s try request
4 CPUs instead. But first, let’s cancel the already running job.</p>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="ex">scancel</span> 11088927</span></code></pre>
</div>
<p>And then we can try again, but with more CPUs:</p>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="ex">sbatch</span> <span class="at">--cpus-per-task</span><span class="op">=</span>4 <span class="at">--wrap</span><span class="op">=</span><span class="st">"srun ./pi-cpu -r -1"</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Submitted batch job 11089020</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="ex">squeue</span> <span class="at">-u</span> <span class="va">$USER</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>   JOBID PARTITION     NAME     USER ST       TIME  NODES NODELIST(REASON)
11089020   regular     wrap   yang.e  R       0:12      1 sml-n15</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb17">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ssh</span> sml-n15</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>yang.e@sml-n15s password: # enter your password
Last login: Fri Apr 14 14:40:38 2023 from slurm-login.hpc.wehi.edu.au</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb19">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="ex">htop</span> <span class="at">-u</span> <span class="va">$USER</span></span></code></pre>
</div>
<figure><img src="fig/htop-picpu-2.png" alt="" class="figure mx-auto d-block"><figcaption>processes associated with <code>pi-cpu</code> after
requesting more CPUs from Slurm</figcaption></figure><p>Unfortunately, the <code>pi-cpu</code> program is still only using
100% - requesting more CPUs from Slurm didn’t help your job work in
parallel.</p>
<p>Now, this job runs forever, so we should cancel it and move on.</p>
<div class="codewrapper sourceCode" id="cb20">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="ex">scancel</span> 11089020</span></code></pre>
</div>
<div id="job-summary-with-seff" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div id="job-summary-with-seff" class="callout-inner">
<h3 class="callout-title">Job summary with<code>seff</code><a class="anchor" aria-label="anchor" href="#job-summary-with-seff"></a>
</h3>
<div class="callout-content">
<p>Now that the job is over, try verifying the efficiency of the job
with <code>seff</code>. What is the CPU Efficiency (%) that the
<code>pi-cpu</code> program achieved?</p>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2">Show me the solution</h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" data-bs-parent="#accordionSolution2" aria-labelledby="headingSolution2">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb21">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="ex">seff</span> 11089020</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Job ID: 11089020
Cluster: milton
User/Group: yang.e/allstaff
State: CANCELLED (exit code 0)
Nodes: 1
Cores per node: 4
CPU Utilized: 00:02:11
CPU Efficiency: 25.00% of 00:08:44 core-walltime
Job Wall-clock time: 00:02:11
Memory Utilized: 4.44 MB
Memory Efficiency: 11.10% of 40.00 MB</code></pre>
</div>
<p>In this scenario, you’re interested in the
<code>CPU Efficiency</code> field, which gives a rough indication of the
total CPU cores requested being used. This is different from
<code>htop</code>, where the percentage represents the utilization of a
single CPU core.</p>
<p>But as well as CPUs, jobs need to select an amount of memory to
request. <code>seff</code> can help tune this value with the
<code>Memory Utilized</code> field, which will tell you the maximum
memory used of your job. The <code>Memoy Efficiency</code> percentage is
also useful to help you choose an appropriate memory to request.</p>
<p><code>pi-cpu</code> turns out to be very lightweight, so doesn’t use
much memory at all! When we run it inside a Slurm job without any
options, it comfortably fits within the default memory (for Milton, this
is 10MB).</p>
</div>
</div>
</div>
</div>
</div>
</section><section id="looking-through-help-and-documentation"><h2 class="section-heading">Looking through help and documentation<a class="anchor" aria-label="anchor" href="#looking-through-help-and-documentation"></a>
</h2>
<hr class="half-width"><div id="discussion4" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge<a class="anchor" aria-label="anchor" href="#discussion4"></a>
</h3>
<div class="callout-content">
<p>Try running <code>pi-cpu</code> with the <code>--help</code> option.
Do you find any clues? See if you can run the <code>pi-cpu</code> in
parallel with 4 cores on Slurm!</p>
</div>
</div>
</div>
<div id="accordionSolution3" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution3" aria-expanded="false" aria-controls="collapseSolution3">
  <h4 class="accordion-header" id="headingSolution3">Show me the solution</h4>
</button>
<div id="collapseSolution3" class="accordion-collapse collapse" data-bs-parent="#accordionSolution3" aria-labelledby="headingSolution3">
<div class="accordion-body">
<p>Both the documentation and <code>--help</code> output would’ve shown
that the <code>-p &lt;N&gt;</code> option is needed to execute the code
with <code>N</code> number of cores.</p>
<p>So, to execute <code>pi-cpu</code> with 4 cores on Slurm, we can
issue the command</p>
<div class="codewrapper sourceCode" id="cb23">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="ex">srun</span> <span class="at">--cpus-per-task</span><span class="op">=</span>4 pi-cpu <span class="at">-p</span> 4 </span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>srun: job 11250525 queued and waiting for resources
srun: job 11250525 has been allocated resources
Result: 3.1418360637907 Error:  0.0002433227781 Time: 1.4548s
Result: 3.1416882225894 Error:  0.0000954815768 Time: 1.4527s
Result: 3.1415296893879 Error: -0.0000630516247 Time: 1.4512s
...</code></pre>
</div>
<p>which will send the output straight to the terminal. You will notice
that the reported times to calculate <code>pi-cpu</code> has more than
halved! We can confirm the utilization of the 4 CPUs we requested with
<code>seff</code>:</p>
<div class="codewrapper sourceCode" id="cb25">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="ex">seff</span> 11250525</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Job ID: 11250525
Cluster: milton
User/Group: yang.e/allstaff
State: CANCELLED (exit code 0)
Nodes: 2
Cores per node: 2
CPU Utilized: 00:02:47
CPU Efficiency: 97.09% of 00:02:52 core-walltime
Job Wall-clock time: 00:00:43
Memory Utilized: 9.56 MB (estimated maximum)
Memory Efficiency: 23.91% of 40.00 MB (10.00 MB/core)</code></pre>
</div>
<p>The CPU Efficiency is now pretty close to 100%!</p>
<p>Many programs behave like this: they will have parallel capability
built in, but will need to be switched on perhaps with a flag/option
like with <code>pi-cpu</code>. Sometimes it can also be switched on via
an environment variable.</p>
<p>Parallel programs are generally designed to run in this way so that
the parallel program doesn’t unintentionally use up all the resources on
the machine you’re running on.</p>
</div>
</div>
</div>
</div>

<div id="using-more-cpu-cores" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div id="using-more-cpu-cores" class="callout-inner">
<h3 class="callout-title">Using more CPU cores<a class="anchor" aria-label="anchor" href="#using-more-cpu-cores"></a>
</h3>
<div class="callout-content">
<p>You’re really determined to get the run-time down on this calculation
of <span class="math inline">\(\pi\)</span>! So, try request different
number of CPUs and see what happens with the time it takes to calculate
<span class="math inline">\(\pi\)</span>!</p>
<p>Hint: try 4, 8, and then 16 CPUs. Hint 2: You may wish to run with
<code>--constraint=Icelake</code> to ensure results are consistent!</p>
</div>
</div>
</div>
<div id="accordionSolution4" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution4" aria-expanded="false" aria-controls="collapseSolution4">
  <h4 class="accordion-header" id="headingSolution4">Show me the solution</h4>
</button>
<div id="collapseSolution4" class="accordion-collapse collapse" data-bs-parent="#accordionSolution4" aria-labelledby="headingSolution4">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb27">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="ex">srun</span> <span class="at">--cpus-per-task</span><span class="op">=</span>4 <span class="at">--constraint</span><span class="op">=</span>Icelake pi-cpu <span class="at">-p</span> 4</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>srun: job 11250526 queued and waiting for resources
srun: job 11250526 has been allocated resources
Result: 3.1414069905868 Error: -0.0001857504258 Time: 1.1907s
Result: 3.1416068013886 Error:  0.0000140603760 Time: 1.1880s
Result: 3.1415671113883 Error: -0.0000256296243 Time: 1.1880s
...</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb29">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="ex">srun</span> <span class="at">--cpus-per-task</span><span class="op">=</span>8 <span class="at">--constraint</span><span class="op">=</span>Icelake pi-cpu <span class="at">-p</span> 8</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>srun: job 11250527 queued and waiting for resources
srun: job 11250527 has been allocated resources
Result: 3.1416164241887 Error:  0.0000236831761 Time: 0.5980s
Result: 3.1414225749869 Error: -0.0001701660256 Time: 0.5975s
Result: 3.1417783593902 Error:  0.0001856183776 Time: 0.5978s   
...</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb31">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="ex">srun</span> <span class="at">--cpus-per-task</span><span class="op">=</span>16 <span class="at">--constraint</span><span class="op">=</span>Icelake pi-cpu <span class="at">-p</span> 16</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>srun: job 11250528 queued and waiting for resources
srun: job 11250528 has been allocated resources
Result: 3.1419777489920 Error:  0.0003850079794 Time: 0.3507s
Result: 3.1415083701877 Error: -0.0000843708248 Time: 0.3018s
Result: 3.1418214513906 Error:  0.0002287103780 Time: 0.3016s 
...</code></pre>
</div>
<p>If you’re running on Milton, you should see that 4 CPUs brings down
the time to 2 seconds, down from the original 6 seconds. Running with 8
CPUs brings the time down to approx. 1 second (approx 2 times speedup,
relative to 4 cores), and bringing it up to 16 speeds things up almost
twice again!</p>
<p>However, this isn’t always true of all programs. Often, adding twice
the number of cores doesn’t add twice the speed.</p>
<p>In many cases, the program’s documentation will offer some
suggestions on how to choose the right number of cores. You might even
find some advice from others e.g., blog posts or in forums. But if this
isn’t the case, you may need to perform some tests yourself!</p>
<p>For example, I run a program with two cores and I discover it’s 1.8
times faster than one core. I then run the same program but with 4 cores
and find that it’s only 2.5 times as fast compared to one core. We could
say that with two cores, the program has a “scaling efficiency” of 1.8/2
= 90% efficient. But, the four core case is 2.5/4 = 62.5% efficient.
This would tell us that running with two cores is <em>more
efficient</em>, and running with four cores is <em>less efficient</em>,
but <em>faster</em>.</p>
</div>
</div>
</div>
</div>
<div id="hyperthreading" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div id="hyperthreading" class="callout-inner">
<h3 class="callout-title">Hyperthreading<a class="anchor" aria-label="anchor" href="#hyperthreading"></a>
</h3>
<div class="callout-content">
<p>Do a rough calculation of the speedup efficiency of
<code>pi-cpu</code> from one core to two.</p>
<p>i.e.,</p>
<p><code>srun --constraint=Icelake pi-cpu -p 1</code></p>
<p>and then</p>
<p><code>srun --cpus-per-task=2 --constraint=Icelake pi-cpu -p 2</code></p>
<p>What do you get?</p>
<p>What happens if you run the two-core case again, but this time
requesting 4 cores from Slurm, but still using <code>-p 2</code>?</p>
</div>
</div>
</div>
<div id="accordionSolution5" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution5" aria-expanded="false" aria-controls="collapseSolution5">
  <h4 class="accordion-header" id="headingSolution5">Show me the solution</h4>
</button>
<div id="collapseSolution5" class="accordion-collapse collapse" data-bs-parent="#accordionSolution5" aria-labelledby="headingSolution5">
<div class="accordion-body">
<p>Comparing 1 CPU with 2 CPUs:</p>
<div class="codewrapper sourceCode" id="cb33">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="ex">srun</span> <span class="at">--constraint</span><span class="op">=</span>Icelake pi-cpu <span class="at">-p</span> 1</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>srun: job 11783722 queued and waiting for resources
srun: job 11783722 has been allocated resources
Result: 3.1419098061914 Error:  0.0003170651788 Time: 3.6352s
Result: 3.1415063289877 Error: -0.0000864120249 Time: 3.6363s
Result: 3.1416112401887 Error:  0.0000184991761 Time: 3.6349s
...</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb35">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="ex">srun</span> <span class="at">--cpus-per-task</span><span class="op">=</span>2 <span class="at">--constraint</span><span class="op">=</span>Icelake pi-cpu <span class="at">-p</span> 2</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>srun: job 11783726 queued and waiting for resources
srun: job 11783726 has been allocated resources
Result: 3.1416992061895 Error:  0.0001064651769 Time: 2.3672s
Result: 3.1415531793881 Error: -0.0000395616244 Time: 2.3669s
Result: 3.1416117585887 Error:  0.0000190175761 Time: 2.3668s
...</code></pre>
</div>
<p>This is approximately 3.64/(2.37*2) = 77% (the times you get may
vary). Unfortunately not as close to 100% as one might hope!</p>
<p>Requesting 4 CPUs from Slurm, but running
<code>pi-cpu -p 2</code>:</p>
<div class="codewrapper sourceCode" id="cb37">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="ex">srun</span> <span class="at">--cpus-per-task</span><span class="op">=</span>4 <span class="at">--constraint</span><span class="op">=</span>Icelake pi-cpu <span class="at">-p</span> 2</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>srun: job 11783729 queued and waiting for resources
srun: job 11783729 has been allocated resources
Result: 3.1413841485866 Error: -0.0002085924260 Time: 1.7224s
Result: 3.1414291845870 Error: -0.0001635564256 Time: 1.7210s
Result: 3.1414952805876 Error: -0.0000974604250 Time: 1.7257s 
...</code></pre>
</div>
<p>Which is now roughly 2.1 times faster than the one-core case! But why
the difference? In both cases, we requested <code>pi-cpu</code> to run
in parallel with 2 cores, right (through the <code>-p 2</code>
flag)?</p>
<p>This is because on Milton, hyperthreading is turned on, which is
often the case for modern CPUs. Milton’s Slurm is configured such that
when you request 1 CPU, you’re actually getting a hyperthread. For every
two hyperthreads, you get one physical CPU core.</p>
<p>So, when you execute <code>srun --cpus-per-task=2 pi-cpu -p 2</code>,
<code>pi-cpu -p 2</code> is actually executed on a single physical core.
But thanks to hyperthreading, you manage to get some speedup almost for
free! When you execute <code>srun --cpus-per-task=4 pi-cpu 2</code>,
<code>pi-cpu</code> is now running on two separate physical cores, hence
we see a speedup!</p>
<p>This is important to remember because if you forget about how Slurm
CPUs are equivalent to hyperthreads, rather than physical CPU cores,
programs that run in parallel might appear less efficient (like in the
case of <code>pi-cpu</code>!).</p>
<p>NOTE: this configuration is unique to Milton. Most other HPC
facilities equate Slurm CPUs to physical CPU cores, not
hyperthreads.</p>
</div>
</div>
</div>
</div>
<div id="using-multiple-nodes" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div id="using-multiple-nodes" class="callout-inner">
<h3 class="callout-title">Using multiple nodes<a class="anchor" aria-label="anchor" href="#using-multiple-nodes"></a>
</h3>
<div class="callout-content">
<p>You may already be aware of the fact that you can request
<em>multiple nodes</em> from Slurm. Maybe we can use multiple nodes to
speed up the calculation of <span class="math inline">\(\pi\)</span>
more! Let’s try and run <code>pi-cpu</code> on 2 nodes, with 2 CPUs per
node, which gives our job a total request of 4 CPUs. Remember to add the
constraint so we can compare the times to the previous tests!</p>
<p>We will submit this job using <code>srun</code>:</p>
<div class="codewrapper sourceCode" id="cb39">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="ex">srun</span> <span class="at">--nodes</span><span class="op">=</span>2 <span class="at">--cpus-per-task</span><span class="op">=</span>2 <span class="at">--constraint</span><span class="op">=</span>Icelake pi-cpu <span class="at">-p</span> 4 </span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>srun: job 11250605 queued and waiting for resources
srun: job 11250605 has been allocated resources
Result: 3.1414471989872 Error: -0.0001455420254 Time: 2.3712s
Result: 3.1417839645902 Error:  0.0001912235777 Time: 2.3745s
Result: 3.1416039501886 Error:  0.0000112091760 Time: 2.3709s
Result: 3.1415633529882 Error: -0.0000293880243 Time: 2.3729s
Result: 3.1415167617878 Error: -0.0000759792248 Time: 2.3712s
Result: 3.1415245053879 Error: -0.0000682356247 Time: 2.3709s
...</code></pre>
</div>
<p>So our job has started, but wait… The run times are <em>slower</em>
than our previous tests with 4 cores! You might also notice that two
lines with identical results are printed together every iteration.</p>
<p>Try and have a look in the <a href="https://github.com/WEHI-ResearchComputing/Workshop-intermediate-slurm/blob/main/episodes/data/pi-cpu.md" class="external-link">documentation</a>
again and see why that might be!</p>
</div>
</div>
</div>
<div id="accordionSolution6" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution6" aria-expanded="false" aria-controls="collapseSolution6">
  <h4 class="accordion-header" id="headingSolution6">Show me the solution</h4>
</button>
<div id="collapseSolution6" class="accordion-collapse collapse" data-bs-parent="#accordionSolution6" aria-labelledby="headingSolution6">
<div class="accordion-body">
<p>in the <a href="https://github.com/WEHI-ResearchComputing/Workshop-intermediate-slurm/blob/main/episodes/data/pi-cpu.md#multi-node--multi-threading" class="external-link">multi-node</a>
section, you will find that to run the program across nodes, you
will</p>
<ol style="list-style-type: decimal"><li>need to use the <code>pi-cpu-mpi</code> program</li>
<li>use <code>srun</code> or <code>mpiexec</code> to execute the
program</li>
<li>ensure the value passed to the <code>-p</code> flag is the number of
CPUs per node.</li>
</ol><p>We’ve been using <code>srun</code> so far, so we only need to change
the program. We also need to change the number after
<code>-p</code>:</p>
<div class="codewrapper sourceCode" id="cb41">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="ex">srun</span> <span class="at">--nodes</span><span class="op">=</span>2 <span class="at">--cpus-per-task</span><span class="op">=</span>2 <span class="at">--constraint</span><span class="op">=</span>Icelake pi-cpu-mpi <span class="at">-p</span> 2 </span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>srun: job 11250610 queued and waiting for resources
srun: job 11250610 has been allocated resources
Result: 3.1414385805871 Error: -0.0001541604255 Time: 1.2036s
Result: 3.1417610577900 Error:  0.0001683167775 Time: 1.2036s
Result: 3.1415069445877 Error: -0.0000857964249 Time: 1.2029s 
...</code></pre>
</div>
<p>And we can see that the program is now calculating <span class="math inline">\(\pi\)</span> in approximately the same time as the
single-node 4-core example before.</p>
<p>This is because <em>programs are generally unable to work across
nodes by default</em>. They typically require some other framework, with
special instructions on how to run the software. This will often be
explained in the documentation.</p>
<p>Message Passing Interface (MPI) is common in scientific computing -
particularly when it comes to simulation like for Molecular Dynamics and
<em>distributed</em> machine learning (e.g., PyTorch), but other
distributed computing frameworks exist, like Spark + Hadoop.</p>
</div>
</div>
</div>
</div>

<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul><li>Requesting more resources from Slurm doesn’t mean your job knows how
to use them!
<ul><li>Many programs don’t work in parallel by default - either that
functionality doesn’t exist, or needs to be turned on!</li>
<li>Parallelism across nodes is different from parallelism within nodes.
You usually need to run them a little differently than a normal
program</li>
</ul></li>
<li>The <code>htop</code> system tool is a great way to get live
information about how effective your job is</li>
<li>
<code>seff</code> can be used to get summary stats about jobs</li>
<li>More CPUs doesn’t always mean an equivalent speedup!</li>
</ul></div>
</div>
</div>
<!-- 
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use. 
 -->
</section></div> <!-- / div.lesson-content -->
    </main><!-- / main#main-content.main-content --><nav class="bottom-pagination mx-md-4" aria-label="Previous and Next Chapter"><div class="d-block d-sm-block d-md-none">
        <a class="chapter-link" href="01-introduction.html"><i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>Previous</a>
        <a class="chapter-link float-end" href="03-moremonitoring.html">Next<i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i></a>
      </div>
      <!-- content for large screens -->
      <div class="d-none d-sm-none d-md-block">
        <a class="chapter-link" href="01-introduction.html" rel="prev">
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>
          Previous: Introduction
        </a>
        <a class="chapter-link float-end" href="03-moremonitoring.html" rel="next">
          Next: Memory and GPU... 
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i>
        </a>
      </div>
    </nav></div> <!-- / div.primary-content.col-xs-12 -->
<!-- END:   inst/pkgdown/templates/content-instructor.html-->

      </div><!--/div.row-->
      		<footer class="row footer mx-md-3"><hr><div class="col-md-6">
        <p>This lesson is subject to the <a href="CODE_OF_CONDUCT.html">Code of Conduct</a></p>
        <p>
        
        <a href="https://github.com/WEHI-ResearchComputing/intermediate-slurm/edit/main/episodes/02-cpumonitoring.Rmd" class="external-link">Edit on GitHub</a>
        
	
        | <a href="https://github.com/WEHI-ResearchComputing/intermediate-slurm/blob/main/CONTRIBUTING.md" class="external-link">Contributing</a>
        | <a href="https://github.com/WEHI-ResearchComputing/intermediate-slurm/" class="external-link">Source</a></p>
				<p><a href="https://github.com/WEHI-ResearchComputing/intermediate-slurm/blob/main/CITATION" class="external-link">Cite</a> | <a href="mailto:research.computing@wehi.edu.au">Contact</a> | <a href="https://carpentries.org/about/" class="external-link">About</a></p>
			</div>
			<div class="col-md-6">
        
        <p>Materials licensed under <a href="LICENSE.html">CC-BY 4.0</a> by the authors</p>
        
        <p>Template licensed under <a href="https://creativecommons.org/licenses/by-sa/4.0/" class="external-link">CC-BY 4.0</a> by <a href="https://carpentries.org/" class="external-link">The Carpentries</a></p>
        <p>Built with <a href="https://github.com/carpentries/sandpaper/tree/0.16.2" class="external-link">sandpaper (0.16.2)</a>, <a href="https://github.com/carpentries/pegboard/tree/0.7.3" class="external-link">pegboard (0.7.3)</a>, and <a href="https://github.com/carpentries/varnish/tree/1.0.1" class="external-link">varnish (1.0.1)</a></p>
			</div>
		</footer></div> <!-- / div.container -->
	<div id="to-top">
		<a href="#top">
      <i class="search-icon" data-feather="arrow-up" role="img" aria-label="Back To Top"></i><br><!-- <span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top --><span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top
		</a>
	</div>
  <script type="application/ld+json">
    {
  "@context": "https://schema.org",
  "@type": "TrainingMaterial",
  "@id": "https://WEHI-ResearchComputing.github.io/intermediate-slurm/02-cpumonitoring.html",
  "inLanguage": "en",
  "dct:conformsTo": "https://bioschemas.org/profiles/TrainingMaterial/1.0-RELEASE",
  "description": "A Carpentries Lesson teaching foundational data and coding skills to researchers worldwide",
  "keywords": "Slurm, HPC",
  "name": "Monitoring a Jobs performance",
  "creativeWorkStatus": "active",
  "url": "https://WEHI-ResearchComputing.github.io/intermediate-slurm/02-cpumonitoring.html",
  "identifier": "https://WEHI-ResearchComputing.github.io/intermediate-slurm/02-cpumonitoring.html",
  "dateCreated": "2023-04-13",
  "dateModified": "2023-11-21",
  "datePublished": "2024-01-16"
}

  </script><script>
		feather.replace();
	</script><!-- Matomo
    2022-11-07: we have gotten a notification that we have an overage for our
    tracking and I'm pretty sure this has to do with Workbench usage.
    Considering that I am not _currently_ using this tracking because I do not
    yet know how to access the data, I am turning this off for now.
  <script>
    var _paq = window._paq = window._paq || [];
    /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
    _paq.push(["setDocumentTitle", document.domain + "/" + document.title]);
    _paq.push(["setDomains", ["*.preview.carpentries.org","*.datacarpentry.github.io","*.datacarpentry.org","*.librarycarpentry.github.io","*.librarycarpentry.org","*.swcarpentry.github.io", "*.carpentries.github.io"]]);
    _paq.push(["setDoNotTrack", true]);
    _paq.push(["disableCookies"]);
    _paq.push(['trackPageView']);
    _paq.push(['enableLinkTracking']);
    (function() {
          var u="https://carpentries.matomo.cloud/";
          _paq.push(['setTrackerUrl', u+'matomo.php']);
          _paq.push(['setSiteId', '1']);
          var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
          g.async=true; g.src='https://cdn.matomo.cloud/carpentries.matomo.cloud/matomo.js'; s.parentNode.insertBefore(g,s);
        })();
  </script>
  End Matomo Code --></body></html><!-- END:   inst/pkgdown/templates/layout.html-->

