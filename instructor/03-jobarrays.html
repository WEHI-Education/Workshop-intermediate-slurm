<!DOCTYPE html>
<!-- START: inst/pkgdown/templates/layout.html --><!-- Generated by pkgdown: do not edit by hand --><html lang="en" data-bs-theme="auto"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><title>Intermediate Slurm: Job Arrays</title><meta name="viewport" content="width=device-width, initial-scale=1"><script src="../assets/themetoggle.js"></script><link rel="stylesheet" type="text/css" href="../assets/styles.css"><script src="../assets/scripts.js" type="text/javascript"></script><!-- mathjax --><script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      config: ["MMLorHTML.js"],
      jax: ["input/TeX","input/MathML","output/HTML-CSS","output/NativeMML", "output/PreviewHTML"],
      extensions: ["tex2jax.js","mml2jax.js","MathMenu.js","MathZoom.js", "fast-preview.js", "AssistiveMML.js", "a11y/accessibility-menu.js"],
      TeX: {
        extensions: ["AMSmath.js","AMSsymbols.js","noErrors.js","noUndefined.js"]
      },
      tex2jax: {
        inlineMath: [['\\(', '\\)']],
        displayMath: [ ['$$','$$'], ['\\[', '\\]'] ],
        processEscapes: true
      }
    });
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><!-- Responsive Favicon for The Carpentries --><link rel="apple-touch-icon" sizes="180x180" href="../favicons/wehi/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="../favicons/wehi/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="../favicons/wehi/favicon-16x16.png"><link rel="manifest" href="../favicons/wehi/site.webmanifest"><link rel="mask-icon" href="../favicons/wehi/safari-pinned-tab.svg" color="#5bbad5"><meta name="msapplication-TileColor" content="#da532c"><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="black"></head><body>
    <header id="top" class="navbar navbar-expand-md top-nav wehi"><svg xmlns="http://www.w3.org/2000/svg" class="d-none"><symbol id="check2" viewbox="0 0 16 16"><path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"></path></symbol><symbol id="circle-half" viewbox="0 0 16 16"><path d="M8 15A7 7 0 1 0 8 1v14zm0 1A8 8 0 1 1 8 0a8 8 0 0 1 0 16z"></path></symbol><symbol id="moon-stars-fill" viewbox="0 0 16 16"><path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"></path><path d="M10.794 3.148a.217.217 0 0 1 .412 0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217 0 0 1 0 .412l-1.162.387a1.734 1.734 0 0 0-1.097 1.097l-.387 1.162a.217.217 0 0 1-.412 0l-.387-1.162A1.734 1.734 0 0 0 9.31 6.593l-1.162-.387a.217.217 0 0 1 0-.412l1.162-.387a1.734 1.734 0 0 0 1.097-1.097l.387-1.162zM13.863.099a.145.145 0 0 1 .274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 0 1 0 .274l-.774.258a1.156 1.156 0 0 0-.732.732l-.258.774a.145.145 0 0 1-.274 0l-.258-.774a1.156 1.156 0 0 0-.732-.732l-.774-.258a.145.145 0 0 1 0-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"></path></symbol><symbol id="sun-fill" viewbox="0 0 16 16"><path d="M8 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"></path></symbol></svg><a class="visually-hidden-focusable skip-link" href="#main-content">Skip to main content</a>
  <div class="container-fluid top-nav-container">
    <div class="col-md-8">
      <div class="large-logo">
        <img id="wehi-logo" alt="wehi" src="../assets/images/wehi-logo.svg"></div>
    </div>
    <div class="selector-container">
      <div id="theme-selector">
        <li class="nav-item dropdown" id="theme-button-list">
          <button class="btn btn-link nav-link px-0 px-lg-2 dropdown-toggle d-flex align-items-center" id="bd-theme" type="button" aria-expanded="false" data-bs-toggle="dropdown" data-bs-display="static" aria-label="Toggle theme (auto)">
            <svg class="bi my-1 theme-icon-active"><use href="#circle-half"></use></svg><i data-feather="chevron-down"></i>
          </button>
          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="bd-theme-text"><li>
              <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="false">
                <svg class="bi me-2 theme-icon"><use href="#sun-fill"></use></svg>
                Light
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
            <li>
              <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
                <svg class="bi me-2 theme-icon"><use href="#moon-stars-fill"></use></svg>
                Dark
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
            <li>
              <button type="button" class="btn dropdown-item d-flex align-items-center active" data-bs-theme-value="auto" aria-pressed="true">
                <svg class="bi me-2 theme-icon"><use href="#circle-half"></use></svg>
                Auto
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
          </ul></li>
      </div>

      <div class="dropdown" id="instructor-dropdown">
        <button class="btn btn-secondary dropdown-toggle bordered-button" type="button" id="dropdownMenu1" data-bs-toggle="dropdown" aria-expanded="false">
          <i aria-hidden="true" class="icon" data-feather="eye"></i> Instructor View <i data-feather="chevron-down"></i>
        </button>
        <ul class="dropdown-menu" aria-labelledby="dropdownMenu1"><li><button class="dropdown-item" type="button" onclick="window.location.href='../03-jobarrays.html';">Learner View</button></li>
        </ul></div>
    </div>
  </div>
  <hr></header><nav class="navbar navbar-expand-xl bottom-nav wehi" aria-label="Main Navigation"><div class="container-fluid nav-container">
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle Navigation">
      <span class="navbar-toggler-icon"></span>
      <span class="menu-title">Menu</span>
    </button>
    <div class="nav-logo">
      <img class="small-logo" alt="wehi" src="../assets/images/wehi-logo-sm.svg"></div>
    <div class="lesson-title-md">
      Intermediate Slurm
    </div>
    <div class="search-icon-sm">
      <!-- TODO: do not show until we have search
        <i role="img" aria-label="Search the All In One page" data-feather="search"></i>
      -->
    </div>
    <div class="desktop-nav">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0"><li class="nav-item">
          <span class="lesson-title">
            Intermediate Slurm
          </span>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../instructor/key-points.html">Key Points</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../instructor/instructor-notes.html">Instructor Notes</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../instructor/images.html">Extract All Images</a>
        </li>
        <li class="nav-item dropdown">
          <button class="nav-link dropdown-toggle" id="navbarDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            More <i data-feather="chevron-down"></i>
          </button>
          <ul class="dropdown-menu" aria-labelledby="navbarDropdown"><hr><li><a class="dropdown-item" href="reference.html">Reference</a></li>
          </ul></li>
      </ul></div>
    <!--
    <form class="d-flex col-md-2 search-form">
      <fieldset disabled>
      <input class="form-control me-2 searchbox" type="search" placeholder="" aria-label="">
        <button class="btn btn-outline-success tablet-search-button"  type="submit">
          <i class="search-icon" data-feather="search" role="img" aria-label="Search the All In One page"></i>
        </button>
      </fieldset>
    </form>
    -->
    <a id="search-button" class="btn btn-primary" href="../instructor/aio.html" role="button" aria-label="Search the All In One page">Search the All In One page</a>
  </div><!--/div.container-fluid -->
</nav><div class="col-md-12 mobile-title">
  Intermediate Slurm
</div>

<aside class="col-md-12 lesson-progress"><div style="width: 40%" class="percentage">
    40%
  </div>
  <div class="progress wehi">
    <div class="progress-bar wehi" role="progressbar" style="width: 40%" aria-valuenow="40" aria-label="Lesson Progress" aria-valuemin="0" aria-valuemax="100">
    </div>
  </div>
</aside><div class="container">
      <div class="row">
        <!-- START: inst/pkgdown/templates/navbar.html -->
<div id="sidebar-col" class="col-lg-4">
  <div id="sidebar" class="sidebar">
      <nav aria-labelledby="flush-headingEleven"><button role="button" aria-label="close menu" alt="close menu" aria-expanded="true" aria-controls="sidebar" class="collapse-toggle" data-collapse="Collapse " data-episodes="Episodes ">
          <i class="search-icon" data-feather="x" role="img"></i>
        </button>
        <div class="sidebar-inner">
          <div class="row mobile-row" id="theme-row-mobile">
            <div class="col" id="theme-selector">
              <li class="nav-item dropdown" id="theme-button-list">
                <button class="btn btn-link nav-link px-0 px-lg-2 dropdown-toggle d-flex align-items-center" id="bd-theme" type="button" aria-expanded="false" data-bs-toggle="dropdown" data-bs-display="static" aria-label="Toggle theme (auto)">
                  <svg class="bi my-1 theme-icon-active"><use href="#circle-half"></use></svg><span class="d-lg-none ms-1" id="bd-theme-text">Toggle Theme</span>
                </button>
                <ul class="dropdown-menu dropdown-menu-right" aria-labelledby="bd-theme-text"><li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="false">
                      <svg class="bi me-2 theme-icon"><use href="#sun-fill"></use></svg>
                      Light
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                  <li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
                      <svg class="bi me-2 theme-icon"><use href="#moon-stars-fill"></use></svg>
                      Dark
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                  <li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center active" data-bs-theme-value="auto" aria-pressed="true">
                      <svg class="bi me-2 theme-icon"><use href="#circle-half"></use></svg>
                      Auto
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                </ul></li>
            </div>
          </div>
          <div class="row mobile-row">
            <div class="col">
              <div class="sidenav-view-selector">
                <div class="accordion accordion-flush" id="accordionFlush9">
                  <div class="accordion-item">
                    <h2 class="accordion-header" id="flush-headingNine">
                      <button class="accordion-button collapsed" id="instructor" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseNine" aria-expanded="false" aria-controls="flush-collapseNine">
                        <i id="eye" aria-hidden="true" class="icon" data-feather="eye"></i> Instructor View
                      </button>
                    </h2>
                    <div id="flush-collapseNine" class="accordion-collapse collapse" aria-labelledby="flush-headingNine" data-bs-parent="#accordionFlush2">
                      <div class="accordion-body">
                        <a href="../03-jobarrays.html">Learner View</a>
                      </div>
                    </div>
                  </div><!--/div.accordion-item-->
                </div><!--/div.accordion-flush-->
              </div><!--div.sidenav-view-selector -->
            </div><!--/div.col -->

            <hr></div><!--/div.mobile-row -->

          <div class="accordion accordion-flush" id="accordionFlush11">
            <div class="accordion-item">

              <button id="chapters" class="accordion-button show" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseEleven" aria-expanded="false" aria-controls="flush-collapseEleven">
                <h2 class="accordion-header chapters" id="flush-headingEleven">
                  EPISODES
                </h2>
              </button>
              <div id="flush-collapseEleven" class="accordion-collapse show collapse" aria-labelledby="flush-headingEleven" data-bs-parent="#accordionFlush11">

                <div class="accordion-body">
                  <div class="accordion accordion-flush" id="accordionFlush1">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading1">
        <a href="index.html">Summary and Schedule</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush2">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading2">
        <a href="01-introduction.html">1. Introduction</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush3">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading3">
        <a href="02-cpumonitoring.html">2. Monitoring a Job's Performance</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlushcurrent">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-headingcurrent">
      <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapsecurrent" aria-expanded="true" aria-controls="flush-collapsecurrent">
        <span class="visually-hidden">Current Chapter</span>
        <span class="current-chapter">
        3. Job Arrays
        </span>
      </button>
    </div><!--/div.accordion-header-->

    <div id="flush-collapsecurrent" class="accordion-collapse collapse show" aria-labelledby="flush-headingcurrent" data-bs-parent="#accordionFlushcurrent">
      <div class="accordion-body">
        <ul><li><a href="#processing-multiple-cases">Processing Multiple Cases</a></li>
        </ul></div><!--/div.accordion-body-->
    </div><!--/div.accordion-collapse-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush5">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading5">
        <a href="04-jobdependencies.html">4. Organising Dependent Slurm Jobs</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush6">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading6">
        <a href="05-rpython.html">5. R and Python Slurm Scripts</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

                </div>
              </div>
            </div>

            <hr class="half-width"><div class="accordion accordion-flush lesson-resources" id="accordionFlush12">
              <div class="accordion-item">
                <h2 class="accordion-header" id="flush-headingTwelve">
                  <button class="accordion-button collapsed" id="lesson-resources" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseTwelve" aria-expanded="false" aria-controls="flush-collapseTwelve">
                    RESOURCES
                  </button>
                </h2>
                <div id="flush-collapseTwelve" class="accordion-collapse collapse" aria-labelledby="flush-headingTwelve" data-bs-parent="#accordionFlush12">
                  <div class="accordion-body">
                    <ul><li>
                        <a href="../instructor/key-points.html">Key Points</a>
                      </li>
                      <li>
                        <a href="../instructor/instructor-notes.html">Instructor Notes</a>
                      </li>
                      <li>
                        <a href="../instructor/images.html">Extract All Images</a>
                      </li>
                      <hr><li><a class="dropdown-item" href="reference.html">Reference</a></li>
                    </ul></div>
                </div>
              </div>
            </div>
            <hr class="half-width lesson-resources"><a href="../instructor/aio.html">See all in one page</a>


            <hr class="d-none d-sm-block d-md-none"><div class="d-grid gap-1">

            </div>
          </div><!-- /div.accordion -->
        </div><!-- /div.sidebar-inner -->
      </nav></div><!-- /div.sidebar -->
  </div><!-- /div.sidebar-col -->
<!-- END:   inst/pkgdown/templates/navbar.html-->

        <!-- START: inst/pkgdown/templates/content-instructor.html -->
  <div class="col-xl-8 col-lg-12 primary-content">
    <nav class="lesson-content mx-md-4" aria-label="Previous and Next Chapter"><!-- content for small screens --><div class="d-block d-sm-block d-md-none">
        <a class="chapter-link" href="../instructor/02-cpumonitoring.html"><i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>Previous</a>
        <a class="chapter-link float-end" href="../instructor/04-jobdependencies.html">Next<i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i></a>
      </div>
      <!-- content for large screens -->
      <div class="d-none d-sm-none d-md-block">
        <a class="chapter-link" href="../instructor/02-cpumonitoring.html" rel="prev">
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>
          Previous: Monitoring a Job's
        </a>
        <a class="chapter-link float-end" href="../instructor/04-jobdependencies.html" rel="next">
          Next: Organising Dependent...
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i>
        </a>
      </div>
      <hr></nav><main id="main-content" class="main-content"><div class="container lesson-content">
        <h1>Job Arrays</h1>
        <p>Last updated on 2025-07-08 |

        <a href="https://github.com/WEHI-Education/Workshop-intermediate-slurm/edit/main/episodes/03-jobarrays.Rmd" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>



        <p>Estimated time: <i aria-hidden="true" data-feather="clock"></i> 12 minutes</p>

        <div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>

        

<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul><li>How can I run a lot of similar jobs?</li>
<li>How can I use job arrays in conjunction with a CSV file?</li>
</ul></div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul><li>Understand the job array syntax</li>
<li>Understand how to make use of array indices</li>
<li>Know how to use <code>sed</code> and <code>read</code> to parse</li>
</ul></div>
</div>
</div>
</div>
</div>
<section><h2 class="section-heading" id="processing-multiple-cases">Processing Multiple Cases<a class="anchor" aria-label="anchor" href="#processing-multiple-cases"></a></h2>
<hr class="half-width"><p>Now that you feel pretty comfortable with the <code>pi-cpu</code>
program, your supervisor wants you to investigate how the error value of
the tool changes with the number of iterations. This is controlled with
the <code>-n</code> flag.</p>
<p>He’s noted that the tool uses 123,456,789 iterations (approx. 1.2E8),
but he would like to know what the accuracy is like for lower number of
iterations. He would like you to see how the error value behaves for
1E2, 1E3, 1E4, …, up to 1E8 iterations.</p>
<p>You know that running 7 tests manually is not a big deal, but you
decide that you might want to make this easier to use in case the number
of tests increase in the future.</p>
<p>You’ve heard about Slurm job arrays which is good at breaking up
these “parameter scans”, so you decide to give them a go.</p>
<div class="section level3">
<h3 id="what-does-a-job-array-do">What does a job array do?<a class="anchor" aria-label="anchor" href="#what-does-a-job-array-do"></a></h3>
<p>The job array functionality is a lightweight mechanism that Slurm
provides to allow users to submit many similar Slurm scripts with a
single <code>sbatch</code> command.</p>
<figure><img src="../fig/job-array-diagram.png" alt="Job arrays submit multiple copies of the same script, each with the same job ID, but unique “task IDs”, which can be used to control each task’s behaviour." class="figure mx-auto d-block"><div class="figcaption">Job arrays submit multiple copies of the same
script, each with the same job ID, but unique “task IDs”, which can be
used to control each task’s behaviour.</div>
</figure><p>Something similar could be achieved with a <code>for</code> loop
like:</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="cf">for</span> ID <span class="kw">in</span> <span class="dt">{</span><span class="dv">1</span><span class="dt">..</span><span class="dv">6</span><span class="dt">}</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="cf">do</span></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a>    <span class="ex">sbatch</span> my-script.sh <span class="va">$ID</span></span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a><span class="cf">done</span></span></code></pre>
</div>
<p>which submits <code>my-script.sh</code> 6 times, and passing the
numbers 1 to 6 to each submission. However, job arrays have some
advantages over this approach:</p>
<ul><li>job arrays are more self-contained i.e., they do not need additional
wrapper scripts or code to submit to Slurm.</li>
<li>each job array “task” is linked to the same job ID, and can be more
easily queried with <code>sacct</code> and <code>squeue</code>.</li>
<li>large array jobs <a href="https://groups.google.com/g/slurm-users/c/GvxcsUS1gs4/m/LWfBNSSEAAAJ" class="external-link">put
far less strain on the Slurm controller than individual jobs</a>
</li>
</ul><p>Why you might prefer the “for loop” approach over job arrays:</p>
<ul><li>each task in the job array has the same resources - separate
<code>sbatch</code> commands allow you to change the resource
request.</li>
<li>when the work being done differs significantly between tasks -
making it difficult to control the behaviour solely through a “task
ID”.</li>
</ul></div>
<div class="section level3">
<h3 id="job-array-syntax">Job Array Syntax<a class="anchor" aria-label="anchor" href="#job-array-syntax"></a></h3>
<p>A Slurm script is turned into a job array with the
<code>--array=&lt;range&gt;</code> sbatch option. On Milton,
<code>&lt;range&gt;</code> can be any integer from 0 up to 1000. To
specify a sequential range of values, you can use the
<code>min-max</code> syntax, where <code>min</code> and <code>max</code>
are the minimum and maximum values of the range.</p>
<p>For example, your Slurm script may look like</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a><span class="co">#SBATCH --job-name=myjob</span></span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a><span class="co">#SBATCH --array=1-3</span></span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"hello world"</span></span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a><span class="fu">sleep</span> 3600</span></code></pre>
</div>
<p>This script will execute 10 jobs which request the default CPUs and
memory. The job will print “hello world” to the job’s output file, and
then wait for an hour. When you submit this job, and your job waits in
the queue, this array job will look similar to:</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="ex">sbatch</span> myjob.sh</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Submitted batch job 11784178</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="ex">squeue</span> <span class="at">-u</span> <span class="va">$USER</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>          JOBID PARTITION     NAME     USER ST       TIME  NODES NODELIST(REASON)
11784178_[1-3]   regular    myjob   yang.e PD       0:00      1 (None)</code></pre>
</div>
<p>where the <code>[1-3]</code> correspond to the indices passed to
<code>--array</code>. Once they start running, the output from
<code>squeue</code> will look similar to:</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="ex">squeue</span> <span class="at">-u</span> <span class="va">$USER</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>      JOBID PARTITION     NAME     USER ST       TIME  NODES NODELIST(REASON)
 11784178_1   regular    myjob   yang.e  R       0:00      1 sml-n02
 11784178_2   regular    myjob   yang.e  R       0:00      1 sml-n02
 11784178_3   regular    myjob   yang.e  R       0:00      1 sml-n02</code></pre>
</div>
<p>Each job is referred to as a “task” of a single job, each associated
with their own index. In the above example, each array task will have a
task ID of 1-10.</p>
<p>The <code>--array</code> option can also accept lists of integers and
ranges, separated by commas. For example, <code>--array=1-3,7</code> is
acceptable too! This is useful for testing or rerunning only specific
indices.</p>
<p>Each array task will have its own output file. The default naming is
<code>slurm-&lt;jobID&gt;-&lt;taskID&gt;.out</code>. For example, the
above job submission produced:</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="fu">ls</span> slurm-11784178<span class="pp">*</span>.out</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>slurm-11784178_1.out  slurm-11784178_2.out  slurm-11784178_3.out</code></pre>
</div>
<div id="cancelling-array-jobs" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div id="cancelling-array-jobs" class="callout-inner">
<h3 class="callout-title">Cancelling array jobs</h3>
<div class="callout-content">
<p>When cancelling jobs, you can reference individual array tasks, a
range, or a list similar to specifying the jobs to run. For example,</p>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="ex">scancel</span> 1174178_<span class="pp">[</span><span class="ss">1</span><span class="pp">-</span><span class="ss">3,7</span><span class="pp">]</span></span></code></pre>
</div>
<p>will cancel only array tasks 1, 2, and 3. If you want to cancel all
the job tasks at once, you can pass only the job ID.</p>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="ex">scancel</span> 1174178</span></code></pre>
</div>
<p>This will cancel any unfinished or pending array tasks in the
queue.</p>
<p>Note that this only works for <code>scancel</code>! No other Slurm
command will accept this format.</p>
</div>
</div>
</div>
</div>
<div class="section level3">
<h3 id="environment-variables-in-slurm-jobs">Environment Variables in Slurm Jobs<a class="anchor" aria-label="anchor" href="#environment-variables-in-slurm-jobs"></a></h3>
<p>Before you learn more about making use of job arrays, it’s important
to know about Slurm job environment variables!</p>
<p>Every time Slurm runs a job for you, Slurm makes a number of
environment variables available to you. These environment variables
contain information about the job, like the job ID, the job name, or the
job’s resources.</p>
<p>A full list of the available environment variables in a job can be
found with <code>man sbatch</code> and scrolling down to
<code>OUTPUT ENVIRONMENT VARIABLES</code>. You can jump to this section
by typing <code>/output environment variables</code> after you’ve opened
the manual page.</p>
<div id="discussion2" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge</h3>
<div class="callout-content">
<p>Try crafting a Slurm script that requests 4 CPUs and 4GB of memory
that says hello, and then prints the node it’s running on, the number of
CPUs requested, and then the memory requested. An example output would
be:</p>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Hello. I am running on sml-n01
These are the resources I requested:
CPUs: 4
Memory: 4096MB</code></pre>
</div>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1"> Show me the solution </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" data-bs-parent="#accordionSolution1" aria-labelledby="headingSolution1">
<div class="accordion-body">
<p>The Slurm environment variables needed here are
<code>SLURM_CPUS_PER_TASK</code>, <code>SLURM_JOB_NODELIST</code>, and
<code>SLURM_MEM_PER_NODE</code>.</p>
<p>To produce the output in the challenge, your script needs to look
similar to:</p>
<div class="codewrapper sourceCode" id="cb14">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a><span class="co">#SBATCH --cpus-per-task=4</span></span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a><span class="co">#SBATCH --mem=4G</span></span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"Hello. I am running on </span><span class="va">${SLURM_JOB_NODELIST}</span><span class="st">"</span></span>
<span id="cb14-6"><a href="#cb14-6" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"These are the resources I requested:"</span></span>
<span id="cb14-7"><a href="#cb14-7" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"CPUs: </span><span class="va">${SLURM_CPUS_PER_TASK}</span><span class="st">"</span></span>
<span id="cb14-8"><a href="#cb14-8" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"Memory: </span><span class="va">${SLURM_MEM_PER_NODE}</span><span class="st">MB"</span></span></code></pre>
</div>
<p>These parameters can be useful when you would like to automatically
pass the Slurm resource request to a command in your script. For
example, I can make <code>pi-cpu</code> use however many CPUs I’ve
requested automatically by using the `SLURM_CPUS_PER_TASK environment
variable inside a job script:</p>
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a><span class="co">#SBATCH --cpus-per-task=4</span></span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a><span class="ex">srun</span> pi-cpu <span class="at">-p</span> <span class="va">${SLURM_CPUS_PER_TASK}</span></span></code></pre>
</div>
<p>But be careful: some Slurm environment variables only have a value if
you’ve set it as a flag. For example, in the above example script,
<code>SLURM_CPUS_PER_TASK</code> has a value because we supplied
<code>--cpus-per-task</code>. But if you didn’t set
<code>--cpus-per-task</code>, the corresponding environment variable
would be empty!</p>
</div>
</div>
</div>
</div>
<div id="accordionInstructor1" class="accordion instructor-note accordion-flush">
<div class="accordion-item">
<button class="accordion-button instructor-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseInstructor1" aria-expanded="false" aria-controls="collapseInstructor1">
  <h3 class="accordion-header" id="headingInstructor1">  <div class="note-square"><i aria-hidden="true" class="callout-icon" data-feather="edit-2"></i></div> Instructor Note </h3>
</button>
<div id="collapseInstructor1" class="accordion-collapse collapse" data-bs-parent="#accordionInstructor1" aria-labelledby="headingInstructor1">
<div class="accordion-body">
<p><a href="https://monashdatafluency.github.io/shell-novice/" class="external-link">Intro to
Linux Command Line</a> is specified as a prerequisite, so learners
should know how to work with. But due to the infrequency of these
workshops, this isn’t guaranteed, so you might want to remind people
what environment variables are.</p>
</div>
</div>
</div>
</div>
</div>
<div class="section level3">
<h3 id="the-slurm_array_task_id-environment-variable">The <code>SLURM_ARRAY_TASK_ID</code> Environment Variable<a class="anchor" aria-label="anchor" href="#the-slurm_array_task_id-environment-variable"></a></h3>
<p>Now back to Slurm job arrays!</p>
<p>While skimming through the manual pages, you might’ve noticed that
one of the environment variables listed is
<code>SLURM_ARRAY_TASK_ID</code>. This variable will store the ID of
each task in a job array, which can be used to control what each task
does.</p>
<p>As practice, we can take the Slurm script we wrote at the beginning
and modify it a little:</p>
<div class="codewrapper sourceCode" id="cb16">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a><span class="co">#SBATCH --job-name=myjob</span></span>
<span id="cb16-4"><a href="#cb16-4" tabindex="-1"></a><span class="co">#SBATCH --array=1-3</span></span>
<span id="cb16-5"><a href="#cb16-5" tabindex="-1"></a></span>
<span id="cb16-6"><a href="#cb16-6" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"hello world from task </span><span class="va">${SLURM_ARRAY_TASK_ID}</span><span class="st">"</span></span></code></pre>
</div>
<p>This script should now print
<code>hello world from task &lt;N&gt;</code> where <code>N</code> is
1-3.</p>
<div class="codewrapper sourceCode" id="cb17">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a><span class="ex">sbatch</span> myjob-array.sh</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Submitted batch job 11784442</code></pre>
</div>
<p>And once all the job tasks have completed, we should be able to check
the output of each task:</p>
<div class="codewrapper sourceCode" id="cb19">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a><span class="fu">cat</span> slurm-11784442-<span class="pp">*</span>.out</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>hello world from task 1
hello world from task 2
hello world from task 3</code></pre>
</div>
<p>Which is great! Now we just have to figure out how to make use of
these task IDs. Remember: our goal is to execute
<code>pi-cpu -n &lt;iter&gt;</code> where <code>iter</code> is 1E2, 1E3,
…, 1E8.</p>
<p>One might think of using the IDs directly, for example, instead of
<code>#SBATCH --array=1-3</code>, maybe we could try something like</p>
<div class="codewrapper sourceCode" id="cb21">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a><span class="co">#SBATCH --array=100,1000,10000,100000,1000000,10000000,1000000000</span></span></code></pre>
</div>
<p>But if we add this to our example array script and try to submit it,
we get the error:</p>
<div class="codewrapper">
<h3 class="code-label">ERROR<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="error" tabindex="0"><code>sbatch: error: Batch job submission failed: Invalid job array specification</code></pre>
</div>
<p>And unfortunately this is because Slurm on Milton has been configured
to accept a <a href="https://slurm.schedmd.com/job_array.html" class="external-link">max job
array index of 1000</a>.</p>
<p>So, we have to figure out another way! A common alternative is to use
a file to store the values we want the job array to scan over. In our
case, we can put together a file with a line for each number of
iterations we want the job array to scan over. Let’s call it
<code>iterations.txt</code>, which contains:</p>
<pre><code><span><span class="fl">100</span></span>
<span><span class="fl">1000</span></span>
<span><span class="fl">10000</span></span>
<span><span class="fl">100000</span></span>
<span><span class="fl">1000000</span></span>
<span><span class="fl">10000000</span></span>
<span><span class="fl">100000000</span></span></code></pre>
<p>But how do we use the job array index to retrieve each of these
lines? We can use the <code>readarray</code> command line utility.</p>
<p><code>readarray</code> is a neat tool that can split text into a Bash
array. Executing the command will start an interactive prompt. To exit,
press Ctrl+D.</p>
<div class="codewrapper sourceCode" id="cb24">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a><span class="ex">readarray</span></span>
<span id="cb24-2"><a href="#cb24-2" tabindex="-1"></a><span class="co"># start typing</span></span>
<span id="cb24-3"><a href="#cb24-3" tabindex="-1"></a><span class="ex">this</span></span>
<span id="cb24-4"><a href="#cb24-4" tabindex="-1"></a><span class="ex">is</span> an</span>
<span id="cb24-5"><a href="#cb24-5" tabindex="-1"></a><span class="ex">example</span> <span class="co"># press Ctrl+D to exit</span></span></code></pre>
</div>
<p>Your text gets saved into the <code>MAPFILE</code> array variable
(each index corresponds to a line):</p>
<div class="codewrapper sourceCode" id="cb25">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"line1: </span><span class="va">${MAPFILE</span><span class="op">[</span><span class="dv">0</span><span class="op">]</span><span class="va">}</span><span class="st">, line2: </span><span class="va">${MAPFILE</span><span class="op">[</span><span class="dv">1</span><span class="op">]</span><span class="va">}</span><span class="st">, line3: </span><span class="va">${MAPFILE</span><span class="op">[</span><span class="dv">2</span><span class="op">]</span><span class="va">}</span><span class="st">"</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>line1: this, line2: is an, line3: example</code></pre>
</div>
<p>A couple things to note about referencing elements in bash
arrays:</p>
<ul><li>Array indices start at 0</li>
<li>
<code>${}</code> are on the outside of
<code>array[index]</code>.</li>
</ul><p>Instead of supplying it input manually, we can pass it a file using
redirection:</p>
<div class="codewrapper sourceCode" id="cb27">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb27-1"><a href="#cb27-1" tabindex="-1"></a><span class="ex">readarray</span> <span class="op">&lt;</span> iterations.txt</span>
<span id="cb27-2"><a href="#cb27-2" tabindex="-1"></a><span class="bu">echo</span> <span class="va">${MAPFILE</span><span class="op">[@]</span><span class="va">}</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>100 1000 10000 100000 1000000 10000000 100000000</code></pre>
</div>
<p>The <code>@</code> symbol means “all the elements in the array”.
Instead of saving the array into <code>MAPFILE</code>, we can pass a
variable name to <code>readarray</code> and it will save the array into
that variable instead e.g.:</p>
<div class="codewrapper sourceCode" id="cb29">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb29-1"><a href="#cb29-1" tabindex="-1"></a><span class="ex">readarray</span> niterations <span class="op">&lt;</span> iterations.txt</span>
<span id="cb29-2"><a href="#cb29-2" tabindex="-1"></a><span class="bu">echo</span> <span class="va">${niterations</span><span class="op">[@]</span><span class="va">}</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>100 1000 10000 100000 1000000 10000000 100000000</code></pre>
</div>
<p>Can you start to see how we might combine the Slurm array index and
our bash array to pass different iteration values to
<code>pi-cpu</code>?</p>
<div id="tests" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="tests" class="callout-inner">
<h3 class="callout-title">Tests</h3>
<div class="callout-content">
<p>It’s generally good practice to <em>test</em> your array job before
you run it for real. This is especially true if you plan to run a large
number of tasks!</p>
</div>
</div>
</div>
<p>Let’s first test that we know how to properly combine the
<code>SLURM_ARRAY_TASK_ID</code> environment variable together with
<code>readarray</code>. Take your script and modify it:</p>
<div class="codewrapper sourceCode" id="cb31">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb31-1"><a href="#cb31-1" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb31-2"><a href="#cb31-2" tabindex="-1"></a></span>
<span id="cb31-3"><a href="#cb31-3" tabindex="-1"></a><span class="co">#SBATCH --job-name=myjob</span></span>
<span id="cb31-4"><a href="#cb31-4" tabindex="-1"></a><span class="co">#SBATCH --array=0-2</span></span>
<span id="cb31-5"><a href="#cb31-5" tabindex="-1"></a></span>
<span id="cb31-6"><a href="#cb31-6" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"hello world from task </span><span class="va">${SLURM_ARRAY_TASK_ID}</span><span class="st">"</span></span>
<span id="cb31-7"><a href="#cb31-7" tabindex="-1"></a><span class="ex">readarray</span> niterations <span class="op">&lt;</span> iterations.txt</span>
<span id="cb31-8"><a href="#cb31-8" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"I will run </span><span class="va">${niterations</span><span class="op">[</span><span class="va">$SLURM_ARRAY_TASK_ID</span><span class="op">]</span><span class="va">}</span><span class="st">!"</span></span></code></pre>
</div>
<p>Note that we’ve changed the array task range from 1-3 to 0-2 since
the bash array is 0-indexed.</p>
<p>Let’s submit this script to confirm that we’ve used `readarray``
correctly.</p>
<div class="codewrapper sourceCode" id="cb32">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb32-1"><a href="#cb32-1" tabindex="-1"></a><span class="ex">sbatch</span> myjob-array.sh</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Submitted batch job 11784737</code></pre>
</div>
<p>Because we’ve only passed the range <code>0-1</code> to the
<code>--array</code> option, we should expect to only see outputs for
the first 3 rows in <code>iterations.txt</code>:</p>
<div class="codewrapper sourceCode" id="cb34">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb34-1"><a href="#cb34-1" tabindex="-1"></a><span class="fu">cat</span> slurm-11784737_<span class="pp">*</span>.out</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>hello world from task 0
I will run 100
!
hello world from task 1
I will run 1000
!
hello world from task 2
I will run 10000
!</code></pre>
</div>
<p>Which demonstrates that we’ve taken the first 3 lines of
<code>iterations.txt</code> correctly! But there’s something wrong… the
exclamation marks on the next line instead of at the end of the number!
This is because <code>readarray</code> keeps newline characters when
parsing the file. To turn off this behavior we need to add the
<code>-t</code> option, so our <code>readarray</code> command
becomes:</p>
<div class="codewrapper sourceCode" id="cb36">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb36-1"><a href="#cb36-1" tabindex="-1"></a><span class="ex">readarray</span> <span class="at">-t</span> niterations <span class="op">&lt;</span> iteration.txt</span></code></pre>
</div>
<p>We can now make use of these values by passing the number of
iterations to the <code>pi-cpu</code> command. We also need to change
the array range to pull all the lines of the <code>iterations.txt</code>
file. Change the array range and add the <code>pi-cpu</code> command to
your script:</p>
<div class="codewrapper sourceCode" id="cb37">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb37-1"><a href="#cb37-1" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb37-2"><a href="#cb37-2" tabindex="-1"></a><span class="co">#SBATCH --job-name=myjob</span></span>
<span id="cb37-3"><a href="#cb37-3" tabindex="-1"></a><span class="co">#SBATCH --array=0-6</span></span>
<span id="cb37-4"><a href="#cb37-4" tabindex="-1"></a><span class="co">#SBATCH --cpus-per-task=4</span></span>
<span id="cb37-5"><a href="#cb37-5" tabindex="-1"></a></span>
<span id="cb37-6"><a href="#cb37-6" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"hello world from task </span><span class="va">${SLURM_ARRAY_TASK_ID}</span><span class="st">"</span></span>
<span id="cb37-7"><a href="#cb37-7" tabindex="-1"></a><span class="ex">readarray</span> <span class="at">-t</span> niterations <span class="op">&lt;</span> iterations.txt</span>
<span id="cb37-8"><a href="#cb37-8" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"I will run </span><span class="va">${niterations</span><span class="op">[</span><span class="va">$SLURM_ARRAY_TASK_ID</span><span class="op">]</span><span class="va">}</span><span class="st">!"</span></span>
<span id="cb37-9"><a href="#cb37-9" tabindex="-1"></a></span>
<span id="cb37-10"><a href="#cb37-10" tabindex="-1"></a><span class="ex">srun</span> ./pi-cpu <span class="at">-p</span> <span class="va">${SLURM_CPUS_PER_TASK}</span> <span class="at">-n</span> <span class="va">${niterations</span><span class="op">[</span><span class="va">$SLURM_ARRAY_TASK_ID</span><span class="op">]</span><span class="va">}</span></span></code></pre>
</div>
<p>You will also need to ensure that <code>--cpus-per-task</code> is
provided here, as without that option, <code>SLURM_CPUS_PER_TASK</code>
doesn’t get set either.</p>
<p>We can then submit the script:</p>
<div class="codewrapper sourceCode" id="cb38">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb38-1"><a href="#cb38-1" tabindex="-1"></a><span class="ex">sbatch</span> myjob-array.sh</span>
<span id="cb38-2"><a href="#cb38-2" tabindex="-1"></a><span class="co"># wait for the job tasks to finish...</span></span>
<span id="cb38-3"><a href="#cb38-3" tabindex="-1"></a><span class="fu">cat</span> slurm-<span class="pp">*</span>.out</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>$ cat slurm-11913780_*.out
hello world from task 0
I will run 100!
Result: 3.1600000000000 Error:  0.0184072589874 Time: 0.0003s
... skipped output

hello world from task 1
I will run 1000!
Result: 3.0480000000000 Error: -0.0935927410126 Time: 0.0004s
... skipped output

hello world from task 2
I will run 10000!
Result: 3.1344000000000 Error: -0.0071927410126 Time: 0.0056s
... skipped output

hello world from task 3
I will run 100000!
Result: 3.1431600000000 Error:  0.0015672589874 Time: 0.0013s
... skipped output

hello world from task 4
I will run 1000000!
Result: 3.1421880000000 Error:  0.0005952589874 Time: 0.0100s
... skipped output

hello world from task 5
I will run 10000000!
Result: 3.1419520000000 Error:  0.0003592589874 Time: 0.0936s
... skipped output

hello world from task 6
I will run 100000000!
Result: 3.1414855200000 Error: -0.0001072210126 Time: 0.9331s
... skipped output</code></pre>
</div>
<p>And now you can see the magnitude of the error, and the speed
decreasing as we increase the number of iterations.</p>
</div>
<div class="section level3">
<h3 id="multi-column-data">Multi-column data<a class="anchor" aria-label="anchor" href="#multi-column-data"></a></h3>
<p>So far you’ve only needed one column of data (the number of
iterations) to investigate accuracy with number of iterations. But, in
many cases you might be interested in varying multiple variables with
each array task.</p>
<p>We can do this by adding another column to our data. Create a new
file called iter-cpu.txt with the content:</p>
<pre><code>iters cpus
100 2
100 4
1000 2
1000 4
10000 2
10000 4</code></pre>
<p>The first row is now a header and rows 2-7 contains the data we’ll
use in our job arrays. Here, we’re going to vary the value passed to
<code>-p</code>.</p>
<p>We can still execute <code>readarray</code> on this file:</p>
<div class="codewrapper sourceCode" id="cb41">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb41-1"><a href="#cb41-1" tabindex="-1"></a><span class="ex">readarray</span> filedata <span class="op">&lt;</span> iter-cpu.txt</span>
<span id="cb41-2"><a href="#cb41-2" tabindex="-1"></a><span class="bu">echo</span> <span class="va">${filedata</span><span class="op">[</span><span class="dv">0</span><span class="op">]</span><span class="va">}</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>iters cpus</code></pre>
</div>
<p>But the columns don’t get split!</p>
<p>So how do we split the columns? <code>cut</code> is a tool you might
be aware of (for example from an <a href="https://monashdatafluency.github.io/shell-novice/" class="external-link">introductory
course</a>). But, this time, lets split the lines of text using the
<code>read</code> utility.</p>
<p>We can use the “heredoc” operator <code>&lt;&lt;&lt;</code> to pass
text to the <code>read</code> command:</p>
<div class="codewrapper sourceCode" id="cb43">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb43-1"><a href="#cb43-1" tabindex="-1"></a><span class="bu">read</span> <span class="op">&lt;&lt;&lt;</span> <span class="st">"hello world"</span></span>
<span id="cb43-2"><a href="#cb43-2" tabindex="-1"></a><span class="bu">echo</span> <span class="va">$REPLY</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>hello world</code></pre>
</div>
<p>By default, <code>read</code> saves what we send it to the variable
<code>REPLY</code>. Note that unlike <code>readarray</code>,
<code>REPLY</code> is not an array. We can choose the variable to save
our input to by giving <code>read</code> a variable name:</p>
<div class="codewrapper sourceCode" id="cb45">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb45-1"><a href="#cb45-1" tabindex="-1"></a><span class="bu">read</span> <span class="va">myvar</span> <span class="op">&lt;&lt;&lt;</span> <span class="st">"hello world"</span></span>
<span id="cb45-2"><a href="#cb45-2" tabindex="-1"></a><span class="bu">echo</span> <span class="va">$myvar</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>hello world</code></pre>
</div>
<p><code>read</code> is also useful because if we pass it more variable
names, it will split the words into each of thoses variables. So, if we
add another variable name to our previous <code>read</code> command:</p>
<div class="codewrapper sourceCode" id="cb47">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb47-1"><a href="#cb47-1" tabindex="-1"></a><span class="bu">read</span> <span class="va">myvar1</span> <span class="va">myvar2</span> <span class="op">&lt;&lt;&lt;</span> <span class="st">"hello world"</span></span>
<span id="cb47-2"><a href="#cb47-2" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"myvar1: </span><span class="va">$myvar1</span><span class="st">, myvar2: </span><span class="va">$myvar2</span><span class="st">"</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>myvar1: hello, myvar2: world</code></pre>
</div>
<div id="parsing-the-iter-cpu.txt-file" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div id="parsing-the-iter-cpu.txt-file" class="callout-inner">
<h3 class="callout-title">parsing the <code>iter-cpu.txt</code>
file</h3>
<div class="callout-content">
<p>We now know how to split lines of a file into an array using
<code>readarray</code>, as well as splitting strings with spaces into
individual words!</p>
<p>See if you can apply this to our current case: try and get
<strong>the first line</strong> from <code>iter-cpu.txt</code> and save
the first column into <code>niterations</code> and the second column
into <code>ncpus</code> bash variables</p>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2"> Show me the solution </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" data-bs-parent="#accordionSolution2" aria-labelledby="headingSolution2">
<div class="accordion-body">
<p>As shown already we can save <code>iter-cpu.txt</code> into an array
using</p>
<div class="codewrapper sourceCode" id="cb49">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb49-1"><a href="#cb49-1" tabindex="-1"></a><span class="ex">readarray</span> <span class="at">-t</span> rowdata <span class="op">&lt;</span> iter-cpu.txt</span></code></pre>
</div>
<p>This gives us an array, <code>rowdata</code>, where each element is a
line of text from <code>iter-cpu.txt</code>. To split the first line of
the file into variables <code>niterations</code> and
<code>ncpus</code>:</p>
<div class="codewrapper sourceCode" id="cb50">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb50-1"><a href="#cb50-1" tabindex="-1"></a><span class="bu">read</span> <span class="va">niterations</span> <span class="va">ncpus</span> <span class="op">&lt;&lt;&lt;</span> <span class="st">"</span><span class="va">${rowdata</span><span class="op">[</span><span class="dv">0</span><span class="op">]</span><span class="va">}</span><span class="st">"</span></span></code></pre>
</div>
<p><code>${rowdata[0]}</code> is referencing the first element of
<code>rowdata</code>, and therefore the first line of text in
<code>iter-cpu.txt</code>. <code>read</code> will take this the row
data, and split the two words into <code>niterations</code> and
<code>ncpus</code> variables.</p>
</div>
</div>
</div>
</div>
<div id="which-array-indices" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div id="which-array-indices" class="callout-inner">
<h3 class="callout-title">Which array indices?</h3>
<div class="callout-content">
<p>Our new text file not only has a new column, but we’ve also added
headers.</p>
<p>So, before we make use of <code>readarray</code> in our job array,
should we change the range passed to <code>--array</code> to make sure
our new Slurm array script works?</p>
</div>
</div>
</div>
<div id="accordionSolution3" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution3" aria-expanded="false" aria-controls="collapseSolution3">
  <h4 class="accordion-header" id="headingSolution3"> Show me the solution </h4>
</button>
<div id="collapseSolution3" class="accordion-collapse collapse" data-bs-parent="#accordionSolution3" aria-labelledby="headingSolution3">
<div class="accordion-body">
<p>Yes we do! While we have the same number of rows in
<code>iter-cpu.txt</code>, the first row is headers. If we passed those
headers to <code>pi-cpu</code> instead of integer values, the program
would fail. We need to ensure only array tasks 1-6 are being run
(remember: the 0th index is the first row in the file i.e., the
headers).</p>
<p>Be aware of this when you write your own files and job array
scripts!</p>
</div>
</div>
</div>
</div>
<div id="use-the-second-columns-iter-cpu.txt" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div id="use-the-second-columns-iter-cpu.txt" class="callout-inner">
<h3 class="callout-title">Use the second columns
<code>iter-cpu.txt</code>
</h3>
<div class="callout-content">
<p>Adapt your array job to use what we’ve learnt so far about
<code>readarray</code> and <code>read</code> to adapt your script to
make use of the 2 columns in <code>iter-cpu.txt</code>! The first column
should be passed to <code>-n</code> and the second should be passed to
<code>-p</code>.</p>
</div>
</div>
</div>
<div id="accordionSolution4" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution4" aria-expanded="false" aria-controls="collapseSolution4">
  <h4 class="accordion-header" id="headingSolution4"> Show me the solution </h4>
</button>
<div id="collapseSolution4" class="accordion-collapse collapse" data-bs-parent="#accordionSolution4" aria-labelledby="headingSolution4">
<div class="accordion-body">
<p>We first need to modify the <code>readarray</code> line to read the
correct file, and to use an appropriately named array variable:</p>
<div class="codewrapper sourceCode" id="cb51">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb51-1"><a href="#cb51-1" tabindex="-1"></a><span class="ex">readarray</span> <span class="at">-t</span> rowdata <span class="op">&lt;</span> iter-cpu.txt</span></code></pre>
</div>
<p>We then need to split <code>rowdata</code> further into
<code>niterations</code> and <code>ncpus</code>. To do this, we will
adapt what we wrote for “Parsing the <code>iter-cpu.txt</code> file”
challenge. Instead of reading the first “0th” element of
<code>rowdata</code>, we’ll use the <code>SLURM_ARRAY_TASK_ID</code>
environment variable:</p>
<div class="codewrapper sourceCode" id="cb52">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb52-1"><a href="#cb52-1" tabindex="-1"></a><span class="bu">read</span> <span class="va">niterations</span> <span class="va">ncpus</span> <span class="op">&lt;&lt;&lt;</span> <span class="va">${rowdata</span><span class="op">[</span><span class="va">$SLURM_CPUS_PER_TASK</span><span class="op">]</span><span class="va">}</span></span></code></pre>
</div>
<p>And finally, we can add <code>niterations</code> and
<code>ncpus</code> to our echo and <code>pi-cpu</code> execution
command!</p>
<div class="codewrapper sourceCode" id="cb53">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb53-1"><a href="#cb53-1" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"I will run </span><span class="va">$niterations</span><span class="st"> iterations and with </span><span class="va">$ncpus</span><span class="st"> CPUs!"</span></span>
<span id="cb53-2"><a href="#cb53-2" tabindex="-1"></a></span>
<span id="cb53-3"><a href="#cb53-3" tabindex="-1"></a><span class="ex">srun</span> pi-cpu <span class="at">-p</span> <span class="va">$ncpus</span> <span class="at">-n</span> <span class="va">$niterations</span></span></code></pre>
</div>
<p>Our final script should look something like:</p>
<div class="codewrapper sourceCode" id="cb54">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb54-1"><a href="#cb54-1" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb54-2"><a href="#cb54-2" tabindex="-1"></a></span>
<span id="cb54-3"><a href="#cb54-3" tabindex="-1"></a><span class="co">#SBATCH --job-name=myjob</span></span>
<span id="cb54-4"><a href="#cb54-4" tabindex="-1"></a><span class="co">#SBATCH --array=1-6</span></span>
<span id="cb54-5"><a href="#cb54-5" tabindex="-1"></a><span class="co">#SBATCH --cpus-per-task=4</span></span>
<span id="cb54-6"><a href="#cb54-6" tabindex="-1"></a></span>
<span id="cb54-7"><a href="#cb54-7" tabindex="-1"></a></span>
<span id="cb54-8"><a href="#cb54-8" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"hello world from task </span><span class="va">${SLURM_ARRAY_TASK_ID}</span><span class="st">"</span></span>
<span id="cb54-9"><a href="#cb54-9" tabindex="-1"></a></span>
<span id="cb54-10"><a href="#cb54-10" tabindex="-1"></a><span class="ex">readarray</span> <span class="at">-t</span> rowdata <span class="op">&lt;</span> iter-cpu.txt</span>
<span id="cb54-11"><a href="#cb54-11" tabindex="-1"></a><span class="bu">read</span> <span class="va">niterations</span> <span class="va">ncpus</span> <span class="op">&lt;&lt;&lt;</span> <span class="va">${rowdata</span><span class="op">[</span><span class="va">$SLURM_ARRAY_TASK_ID</span><span class="op">]</span><span class="va">}</span></span>
<span id="cb54-12"><a href="#cb54-12" tabindex="-1"></a></span>
<span id="cb54-13"><a href="#cb54-13" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"I will run </span><span class="va">$niterations</span><span class="st"> with </span><span class="va">$ncpus</span><span class="st"> CPUs!"</span></span>
<span id="cb54-14"><a href="#cb54-14" tabindex="-1"></a></span>
<span id="cb54-15"><a href="#cb54-15" tabindex="-1"></a><span class="ex">srun</span> pi-cpu <span class="at">-p</span> <span class="va">$ncpus</span> <span class="at">-n</span> <span class="va">$niterations</span></span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="section level3">
<h3 id="controlling-output">Controlling output<a class="anchor" aria-label="anchor" href="#controlling-output"></a></h3>
<p>When using <code>--output</code> and <code>--error</code> flags with
<code>sbatch</code>, you can make use of the <code>%A</code> variable
which refers to the parent job ID, and <code>%a</code>, which refers to
the job task. Using <code>%j</code> will use a different job ID for each
task.</p>
</div>
<div class="section level3">
<h3 id="exception-handling">Exception handling<a class="anchor" aria-label="anchor" href="#exception-handling"></a></h3>
<p>Sometimes, you might find that you want to execute your job script
from the command line, instead of submitting it to Slurm. In this case,
your job likely won’t have a <code>SLURM_ARRAY_TASK_ID</code>
environment variable set. In this case, you will want to make sure the
necessary check is present and for the script to exit appropriately OR
set a reasonable default.</p>
<div class="codewrapper sourceCode" id="cb55">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb55-1"><a href="#cb55-1" tabindex="-1"></a><span class="cf">if</span> <span class="bu">[</span> <span class="ot">-z</span> <span class="va">$SLURM_ARRAY_TASK_ID</span> <span class="bu">]</span></span>
<span id="cb55-2"><a href="#cb55-2" tabindex="-1"></a><span class="cf">then</span></span>
<span id="cb55-3"><a href="#cb55-3" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">"This script needs to be submitted as a Slurm script!"</span></span>
<span id="cb55-4"><a href="#cb55-4" tabindex="-1"></a>    <span class="bu">exit</span> 1</span>
<span id="cb55-5"><a href="#cb55-5" tabindex="-1"></a><span class="cf">fi</span></span></code></pre>
</div>
<p><code>[ -z $SLURM_ARRAY_TASK_ID ]</code> returns 0 if
<code>SLURM_ARRAY_TASK_ID</code> is NOT set. You can replace the
<code>echo</code> and <code>exit</code> statement with a reasonable
default instead e.g., <code>export SLURM_ARRAY_TASK_ID=1</code>.</p>
<div id="accordionInstructor2" class="accordion instructor-note accordion-flush">
<div class="accordion-item">
<button class="accordion-button instructor-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseInstructor2" aria-expanded="false" aria-controls="collapseInstructor2">
  <h3 class="accordion-header" id="headingInstructor2">  <div class="note-square"><i aria-hidden="true" class="callout-icon" data-feather="edit-2"></i></div> Instructor Note </h3>
</button>
<div id="collapseInstructor2" class="accordion-collapse collapse" data-bs-parent="#accordionInstructor2" aria-labelledby="headingInstructor2">
<div class="accordion-body">
<p>You may wish to highlight that you cannot change the resource request
between job array tasks. Everything controlled by an <code>sbatch</code>
option is fixed between all the array tasks!</p>
</div>
</div>
</div>
</div>
<div id="different-delimiters-optional" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div id="different-delimiters-optional" class="callout-inner">
<h3 class="callout-title">Different delimiters (optional)</h3>
<div class="callout-content">
<p>Here we showed how to split text that is seperated by spaces.
e.g.</p>
<div class="codewrapper sourceCode" id="cb56">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb56-1"><a href="#cb56-1" tabindex="-1"></a><span class="va">string</span><span class="op">=</span><span class="st">"hello world"</span></span>
<span id="cb56-2"><a href="#cb56-2" tabindex="-1"></a><span class="bu">read</span> <span class="va">word1</span> <span class="va">word1</span> <span class="op">&lt;&lt;&lt;</span> <span class="st">"</span><span class="va">$string</span><span class="st">"</span></span></code></pre>
</div>
<p>But different delimiters can be used using the following syntax:</p>
<div class="codewrapper sourceCode" id="cb57">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb57-1"><a href="#cb57-1" tabindex="-1"></a><span class="va">string</span><span class="op">=</span><span class="st">"hello world"</span></span>
<span id="cb57-2"><a href="#cb57-2" tabindex="-1"></a><span class="va">IFS</span><span class="op">=&lt;</span>delimiter<span class="op">&gt;</span> read <span class="ex">word1</span> word2 <span class="op">&lt;&lt;&lt;</span> <span class="st">"</span><span class="va">$string</span><span class="st">"</span></span></code></pre>
</div>
<p><code>IFS</code> is a special environment variable used by bash to
determine how to split strings. By setting it to a different
character(s), you can control how <code>read</code> splits your string.
What should you set <code>IFS</code> to to get the following output from
<code>echo "word1: $word1, word2: $word2"</code>?</p>
<ol style="list-style-type: decimal"><li><code>word1: hello , word2: orld</code></li>
<li><code>word1: , word2: ello world</code></li>
</ol></div>
</div>
</div>
<div id="accordionSolution5" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution5" aria-expanded="false" aria-controls="collapseSolution5">
  <h4 class="accordion-header" id="headingSolution5"> Show me the solution </h4>
</button>
<div id="collapseSolution5" class="accordion-collapse collapse" data-bs-parent="#accordionSolution5" aria-labelledby="headingSolution5">
<div class="accordion-body">
<ol style="list-style-type: decimal"><li>
<code>IFS=w</code>:</li>
</ol><div class="codewrapper sourceCode" id="cb58">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb58-1"><a href="#cb58-1" tabindex="-1"></a><span class="va">string</span><span class="op">=</span><span class="st">"hello world"</span></span>
<span id="cb58-2"><a href="#cb58-2" tabindex="-1"></a><span class="va">IFS</span><span class="op">=</span>w <span class="bu">read</span> <span class="va">word1</span> <span class="va">word2</span> <span class="op">&lt;&lt;&lt;</span> <span class="st">"</span><span class="va">$string</span><span class="st">"</span></span>
<span id="cb58-3"><a href="#cb58-3" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"word1: </span><span class="va">$word1</span><span class="st">, word2: </span><span class="va">$word2</span><span class="st">"</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>word1: hello , word2: orld</code></pre>
</div>
<ol start="2" style="list-style-type: decimal"><li><code>IFS=h</code></li>
</ol><div class="codewrapper sourceCode" id="cb60">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb60-1"><a href="#cb60-1" tabindex="-1"></a><span class="va">string</span><span class="op">=</span><span class="st">"hello world"</span></span>
<span id="cb60-2"><a href="#cb60-2" tabindex="-1"></a><span class="va">IFS</span><span class="op">=</span>h <span class="bu">read</span> <span class="va">word1</span> <span class="va">word2</span> <span class="op">&lt;&lt;&lt;</span> <span class="st">"</span><span class="va">$string</span><span class="st">"</span></span>
<span id="cb60-3"><a href="#cb60-3" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"word1: </span><span class="va">$word1</span><span class="st">, word2: </span><span class="va">$word2</span><span class="st">"</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>word1: , word2: ello world</code></pre>
</div>
</div>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points</h3>
<div class="callout-content">
<ul><li>Slurm job arrays are a great way to parallelise similar jobs!</li>
<li>The <code>SLURM_ARRAY_TASK_ID</code> environment variable is used to
control individual array tasks’ work</li>
<li>A file with all the parameters can be used to control array task
parameters</li>
<li>
<code>readarray</code> and <code>read</code> are useful tools to
help you parse files. But it can also be done many other ways!</li>
</ul></div>
</div>
</div>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
</div>
</section></div> <!-- / div.lesson-content -->
    </main><!-- / main#main-content.main-content --><nav class="bottom-pagination mx-md-4" aria-label="Previous and Next Chapter"><div class="d-block d-sm-block d-md-none">
        <a class="chapter-link" href="../instructor/02-cpumonitoring.html"><i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>Previous</a>
        <a class="chapter-link float-end" href="../instructor/04-jobdependencies.html">Next<i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i></a>
      </div>
      <!-- content for large screens -->
      <div class="d-none d-sm-none d-md-block">
        <a class="chapter-link" href="../instructor/02-cpumonitoring.html" rel="prev">
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>
          Previous: Monitoring a Job's
        </a>
        <a class="chapter-link float-end" href="../instructor/04-jobdependencies.html" rel="next">
          Next: Organising Dependent...
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i>
        </a>
      </div>
    </nav></div> <!-- / div.primary-content.col-xs-12 -->
<!-- END:   inst/pkgdown/templates/content-instructor.html-->

      </div><!--/div.row-->
      		<footer class="row footer mx-md-3"><hr><div class="col-md-6">
        <p>This lesson is subject to the <a href="CODE_OF_CONDUCT.html">Code of Conduct</a></p>
        <p>

        <a href="https://github.com/WEHI-Education/Workshop-intermediate-slurm/edit/main/episodes/03-jobarrays.Rmd" class="external-link">Edit on GitHub</a>

	
        | <a href="https://github.com/WEHI-Education/Workshop-intermediate-slurm/blob/main/CONTRIBUTING.md" class="external-link">Contributing</a>
        | <a href="https://github.com/WEHI-Education/Workshop-intermediate-slurm/" class="external-link">Source</a></p>
				<p><a href="https://github.com/WEHI-Education/Workshop-intermediate-slurm/blob/main/CITATION" class="external-link">Cite</a> | <a href="mailto:research.computing@wehi.edu.au">Contact</a> | <a href="https://carpentries.org/about/" class="external-link">About</a></p>
			</div>
			<div class="col-md-6">

        <p>Materials licensed under <a href="LICENSE.html">CC-BY 4.0</a> by the authors</p>

        <p>Template licensed under <a href="https://creativecommons.org/licenses/by-sa/4.0/" class="external-link">CC-BY 4.0</a> by <a href="https://carpentries.org/" class="external-link">The Carpentries</a></p>
        <p>Built with <a href="https://github.com/carpentries/sandpaper/tree/0.16.12" class="external-link">sandpaper (0.16.12)</a>, <a href="https://github.com/carpentries/pegboard/tree/0.7.9" class="external-link">pegboard (0.7.9)</a>, and <a href="https://github.com/melbournebioinformatics/uom-varnish/tree/main" class="external-link">varnish (1.0.7.9000)</a></p>
			</div>
		</footer></div> <!-- / div.container -->
	<div id="to-top">
		<a href="#top">
      <i class="search-icon" data-feather="arrow-up" role="img" aria-label="Back To Top"></i><br><!-- <span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top --><span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top
		</a>
	</div>
  <script type="application/ld+json">
    {
  "@context": "https://schema.org",
  "@type": "LearningResource",
  "@id": "https://WEHI-Education.github.io/Workshop-intermediate-slurm/instructor/03-jobarrays.html",
  "inLanguage": "en",
  "dct:conformsTo": "https://bioschemas.org/profiles/LearningResource/1.0-RELEASE",
  "description": "A Carpentries Lesson teaching foundational data and coding skills to researchers worldwide",
  "keywords": "Slurm, HPC",
  "name": "Job Arrays",
  "creativeWorkStatus": "active",
  "url": "https://WEHI-Education.github.io/Workshop-intermediate-slurm/instructor/03-jobarrays.html",
  "identifier": "https://WEHI-Education.github.io/Workshop-intermediate-slurm/instructor/03-jobarrays.html",
  "dateCreated": "2023-04-13",
  "dateModified": "2025-07-08",
  "datePublished": "2025-07-29"
}

  </script><script>
		feather.replace();
	</script></body></html><!-- END:   inst/pkgdown/templates/layout.html-->

