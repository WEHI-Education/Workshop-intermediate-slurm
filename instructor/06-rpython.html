<!DOCTYPE html>
<!-- START: inst/pkgdown/templates/layout.html --><!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><title>Intermediate Slurm: R and Python Slurm scripts</title><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="stylesheet" type="text/css" href="../assets/styles.css"><script src="../assets/scripts.js" type="text/javascript"></script><!-- mathjax --><script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      config: ["MMLorHTML.js"],
      jax: ["input/TeX","input/MathML","output/HTML-CSS","output/NativeMML", "output/PreviewHTML"],
      extensions: ["tex2jax.js","mml2jax.js","MathMenu.js","MathZoom.js", "fast-preview.js", "AssistiveMML.js", "a11y/accessibility-menu.js"],
      TeX: {
        extensions: ["AMSmath.js","AMSsymbols.js","noErrors.js","noUndefined.js"]
      },
      tex2jax: {
        inlineMath: [['\\(', '\\)']],
        displayMath: [ ['$$','$$'], ['\\[', '\\]'] ],
        processEscapes: true
      }
    });
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><!-- Responsive Favicon for The Carpentries --><link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png"><link rel="manifest" href="../site.webmanifest"><link rel="mask-icon" href="../safari-pinned-tab.svg" color="#5bbad5"><meta name="msapplication-TileColor" content="#da532c"><meta name="theme-color" content="#ffffff"></head><body>
    <header id="top" class="navbar navbar-expand-md navbar-light bg-white top-nav incubator"><a class="visually-hidden-focusable skip-link" href="#main-content">Skip to main content</a>
  <div class="container-fluid top-nav-container">
    <div class="col-md-6">
      <div class="large-logo">
        <img alt="Carpentries Incubator" src="../assets/images/incubator-logo.svg"><abbr class="badge badge-light" title="This lesson is in the pre-alpha phase, which means that it is in early development, but has not yet been taught." style="background-color: #FF4955; border-radius: 5px">
          <a href="https://cdh.carpentries.org/the-lesson-life-cycle.html#early-development-pre-alpha-through-alpha" class="external-link alert-link" style="color: #000">
            <i aria-hidden="true" class="icon" data-feather="alert-octagon" style="border-radius: 5px"></i>
            Pre-Alpha
          </a>
          <span class="visually-hidden">This lesson is in the pre-alpha phase, which means that it is in early development, but has not yet been taught.</span>
        </abbr>
        
      </div>
    </div>
    <div class="selector-container">
      
      
      <div class="dropdown">
        <button class="btn btn-secondary dropdown-toggle bordered-button" type="button" id="dropdownMenu1" data-bs-toggle="dropdown" aria-expanded="false">
          <i aria-hidden="true" class="icon" data-feather="eye"></i> Instructor View <i data-feather="chevron-down"></i>
        </button>
        <ul class="dropdown-menu" aria-labelledby="dropdownMenu1"><li><button class="dropdown-item" type="button" onclick="window.location.href='../06-rpython.html';">Learner View</button></li>
        </ul></div>
    </div>
  </div>
  <hr></header><nav class="navbar navbar-expand-xl navbar-light bg-white bottom-nav incubator" aria-label="Main Navigation"><div class="container-fluid nav-container">
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle Navigation">
      <span class="navbar-toggler-icon"></span>
      <span class="menu-title">Menu</span>
    </button>
    <div class="nav-logo">
      <img class="small-logo" alt="Carpentries Incubator" src="../assets/images/incubator-logo-sm.svg"></div>
    <div class="lesson-title-md">
      Intermediate Slurm
    </div>
    <div class="search-icon-sm">
      <!-- TODO: do not show until we have search
        <i role="img" aria-label="Search the All In One page" data-feather="search"></i>
      -->
    </div>
    <div class="desktop-nav">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0"><li class="nav-item">
          <span class="lesson-title">
            Intermediate Slurm
          </span>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../instructor/key-points.html">Key Points</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../instructor/instructor-notes.html">Instructor Notes</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../instructor/images.html">Extract All Images</a>
        </li>
        <li class="nav-item dropdown">
          <button class="nav-link dropdown-toggle" id="navbarDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            More <i data-feather="chevron-down"></i>
          </button>
          <ul class="dropdown-menu" aria-labelledby="navbarDropdown"><hr><li><a class="dropdown-item" href="reference.html">Reference</a></li>
          </ul></li>
      </ul></div>
    <!--
    <form class="d-flex col-md-2 search-form">
      <fieldset disabled>
      <input class="form-control me-2 searchbox" type="search" placeholder="" aria-label="">
        <button class="btn btn-outline-success tablet-search-button"  type="submit">
          <i class="search-icon" data-feather="search" role="img" aria-label="Search the All In One page"></i>
        </button>
      </fieldset>
    </form>
    -->
    <a class="btn btn-primary" href="../aio.html" role="button" aria-label="Search the All In One page">Search the All In One page</a>
  </div><!--/div.container-fluid -->
</nav><div class="col-md-12 mobile-title">
  Intermediate Slurm
</div>

<aside class="col-md-12 lesson-progress"><div style="width: 83%" class="percentage">
    83%
  </div>
  <div class="progress incubator">
    <div class="progress-bar incubator" role="progressbar" style="width: 83%" aria-valuenow="83" aria-label="Lesson Progress" aria-valuemin="0" aria-valuemax="100">
    </div>
  </div>
</aside><div class="container">
      <div class="row">
        <!-- START: inst/pkgdown/templates/navbar.html -->
<div id="sidebar-col" class="col-lg-4">
  <div id="sidebar" class="sidebar">
      <nav aria-labelledby="flush-headingEleven"><button role="button" aria-label="close menu" alt="close menu" aria-expanded="true" aria-controls="sidebar" class="collapse-toggle" data-collapse="Collapse " data-episodes="Episodes ">
          <i class="search-icon" data-feather="x" role="img"></i>
        </button>
        <div class="sidebar-inner">
          <div class="row mobile-row">
            <div class="col">
              <div class="sidenav-view-selector">
                <div class="accordion accordion-flush" id="accordionFlush9">
                  <div class="accordion-item">
                    <h2 class="accordion-header" id="flush-headingNine">
                      <button class="accordion-button collapsed" id="instructor" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseNine" aria-expanded="false" aria-controls="flush-collapseNine">
                        <i id="eye" aria-hidden="true" class="icon" data-feather="eye"></i> Instructor View
                      </button>
                    </h2>
                    <div id="flush-collapseNine" class="accordion-collapse collapse" aria-labelledby="flush-headingNine" data-bs-parent="#accordionFlush2">
                      <div class="accordion-body">
                        <a href="../06-rpython.html">Learner View</a>
                      </div>
                    </div>
                  </div><!--/div.accordion-item-->
                </div><!--/div.accordion-flush-->
              </div><!--div.sidenav-view-selector -->
            </div><!--/div.col -->
      
            <hr></div><!--/div.mobile-row -->

          <div class="accordion accordion-flush" id="accordionFlush11">
            <div class="accordion-item">

              <button id="chapters" class="accordion-button show" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseEleven" aria-expanded="false" aria-controls="flush-collapseEleven">
                <h2 class="accordion-header chapters" id="flush-headingEleven">
                  EPISODES
                </h2>
              </button>
              <div id="flush-collapseEleven" class="accordion-collapse show collapse" aria-labelledby="flush-headingEleven" data-bs-parent="#accordionFlush11">

                <div class="accordion-body">
                  <div class="accordion accordion-flush" id="accordionFlush1">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading1">
        <a href="index.html">Summary and Schedule</a>
    </div><!--/div.accordion-header-->
        
  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush2">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading2">
        <a href="01-introduction.html">1. Introduction</a>
    </div><!--/div.accordion-header-->
        
  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush3">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading3">
        <a href="02-cpumonitoring.html">2. Monitoring a Jobs performance</a>
    </div><!--/div.accordion-header-->
        
  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush4">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading4">
        <a href="03-moremonitoring.html">3. Memory and GPU utilization</a>
    </div><!--/div.accordion-header-->
        
  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush5">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading5">
        <a href="04-jobarrays.html">4. Job Arrays</a>
    </div><!--/div.accordion-header-->
        
  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush6">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading6">
        <a href="05-jobdependencies.html">5. Organising dependent Slurm jobs</a>
    </div><!--/div.accordion-header-->
        
  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlushcurrent">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-headingcurrent">
      <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapsecurrent" aria-expanded="true" aria-controls="flush-collapsecurrent">
        <span class="visually-hidden">Current Chapter</span>
        <span class="current-chapter">
        6. R and Python Slurm scripts
        </span>
      </button>
    </div><!--/div.accordion-header-->
        
    <div id="flush-collapsecurrent" class="accordion-collapse collapse show" aria-labelledby="flush-headingcurrent" data-bs-parent="#accordionFlushcurrent">
      <div class="accordion-body">
        <ul><li><a href="#motivation">Motivation</a></li>
<li><a href="#a-python-script">A Python script</a></li>
<li><a href="#which-interpreter">Which interpreter?</a></li>
<li><a href="#slurm-environment-variables">Slurm Environment Variables</a></li>
<li><a href="#setting-up-job-arrays">Setting Up Job Arrays</a></li>
        </ul></div><!--/div.accordion-body-->
    </div><!--/div.accordion-collapse-->
        
  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

                </div>
              </div>
            </div>

            <hr class="half-width"><div class="accordion accordion-flush resources" id="accordionFlush12">
              <div class="accordion-item">
                <h2 class="accordion-header" id="flush-headingTwelve">
                  <button class="accordion-button collapsed" id="resources" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseTwelve" aria-expanded="false" aria-controls="flush-collapseTwelve">
                    RESOURCES
                  </button>
                </h2>
                <div id="flush-collapseTwelve" class="accordion-collapse collapse" aria-labelledby="flush-headingTwelve" data-bs-parent="#accordionFlush12">
                  <div class="accordion-body">
                    <ul><li>
                        <a href="../instructor/key-points.html">Key Points</a>
                      </li>
                      <li>
                        <a href="../instructor/instructor-notes.html">Instructor Notes</a>
                      </li>
                      <li>
                        <a href="../instructor/images.html">Extract All Images</a>
                      </li>
                      <hr><li><a class="dropdown-item" href="reference.html">Reference</a></li>
                    </ul></div>
                </div>
              </div>
            </div>
            <hr class="half-width resources"><a href="../instructor/aio.html">See all in one page</a>
            

            <hr class="d-none d-sm-block d-md-none"><div class="d-grid gap-1">
            
            </div>
          </div><!-- /div.accordion -->
        </div><!-- /div.sidebar-inner -->
      </nav></div><!-- /div.sidebar -->
  </div><!-- /div.sidebar-col -->
<!-- END:   inst/pkgdown/templates/navbar.html-->

        <!-- START: inst/pkgdown/templates/content-instructor.html -->
  <div class="col-xl-8 col-lg-12 primary-content">
    <nav class="lesson-content mx-md-4" aria-label="Previous and Next Chapter"><!-- content for small screens --><div class="d-block d-sm-block d-md-none">
        <a class="chapter-link" href="../instructor/05-jobdependencies.html"><i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>Previous</a>
        <a class="chapter-link float-end" href="../instructor/index.html">Next<i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i></a>
      </div>
      <!-- content for large screens -->
      <div class="d-none d-sm-none d-md-block">
        <a class="chapter-link" href="../instructor/05-jobdependencies.html" rel="prev">
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>
          Previous: Organising dependent
        </a>
        <a class="chapter-link float-end" href="../instructor/index.html" rel="next">
          Home
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i>
        </a>
      </div>
      <hr></nav><main id="main-content" class="main-content"><div class="container lesson-content">
        <h1>R and Python Slurm scripts</h1>
        <p>Last updated on 2024-03-12 |
        
        <a href="https://github.com/WEHI-ResearchComputing/intermediate-slurm/edit/main/episodes/06-rpython.Rmd" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
        
        
        
        <p>Estimated time: <i aria-hidden="true" data-feather="clock"></i> 12 minutes</p>
        
        <div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>

        

<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul><li>How do I write Slurm scripts in languages other than Bash?</li>
<li>How can I combine Slurm with other languages?</li>
</ul></div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul><li>How to use different interpreters to write Slurm scripts</li>
<li>How to write job arrays using other languages</li>
</ul></div>
</div>
</div>
</div>
</div>
<section id="motivation"><h2 class="section-heading">Motivation<a class="anchor" aria-label="anchor" href="#motivation"></a>
</h2>
<hr class="half-width"><p>The chances are, when you first started using Slurm, you probably
wasn’t all that familiar with Bash. But you begrudgingly learnt it so
you can make use of the computational capabilities of HPC. If you’re a
Python or R user, you probably wrote a script which performed a part of
your analysis, and you might use this script on HPC with a wrapper
submission script that looks like:</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="co">#SBATCH --cpus-per-task=2</span></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="co">#SBATCH --mem=4G</span></span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a><span class="ex">Rscript</span> myRscript.R <span class="op">&lt;</span>arguments<span class="op">&gt;</span></span></code></pre>
</div>
<p>And that’s all it really does. But did you know you can bypass this
wrapper script by submitting the R/python script directly?</p>
</section><section id="a-python-script"><h2 class="section-heading">A Python script<a class="anchor" aria-label="anchor" href="#a-python-script"></a>
</h2>
<hr class="half-width"><p>Let’s consider a Python script <code>pi.py</code> that calculates
<span class="math inline">\(\pi\)</span>:</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="co"># pi.py</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="im">import</span> sys, random</span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a><span class="co"># function to calculate pi</span></span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a><span class="kw">def</span> calc_pi(numtrials):</span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a>    n <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(numtrials):</span>
<span id="cb2-9"><a href="#cb2-9" tabindex="-1"></a>        r1 <span class="op">=</span> random.random()</span>
<span id="cb2-10"><a href="#cb2-10" tabindex="-1"></a>        r2 <span class="op">=</span> random.random()</span>
<span id="cb2-11"><a href="#cb2-11" tabindex="-1"></a>        <span class="cf">if</span> (r1<span class="op">*</span>r1 <span class="op">+</span> r2<span class="op">*</span>r2 <span class="op">&lt;</span> <span class="fl">1.</span>):</span>
<span id="cb2-12"><a href="#cb2-12" tabindex="-1"></a>            n <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb2-13"><a href="#cb2-13" tabindex="-1"></a>        </span>
<span id="cb2-14"><a href="#cb2-14" tabindex="-1"></a>    <span class="cf">return</span> <span class="fl">4.</span><span class="op">*</span>n<span class="op">/</span>numtrials</span>
<span id="cb2-15"><a href="#cb2-15" tabindex="-1"></a></span>
<span id="cb2-16"><a href="#cb2-16" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb2-17"><a href="#cb2-17" tabindex="-1"></a></span>
<span id="cb2-18"><a href="#cb2-18" tabindex="-1"></a>    <span class="co"># get number of trials from first command line argument</span></span>
<span id="cb2-19"><a href="#cb2-19" tabindex="-1"></a>    <span class="co"># produce error if it doesn't work.</span></span>
<span id="cb2-20"><a href="#cb2-20" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb2-21"><a href="#cb2-21" tabindex="-1"></a>        numtrials <span class="op">=</span> <span class="bu">int</span>(sys.argv[<span class="dv">1</span>])</span>
<span id="cb2-22"><a href="#cb2-22" tabindex="-1"></a>    <span class="cf">except</span>:</span>
<span id="cb2-23"><a href="#cb2-23" tabindex="-1"></a>        sys.exit(<span class="st">"There was a problem parsing the command-line arguments</span><span class="ch">\n</span><span class="st">Did you remember to pass an integer?"</span>)</span>
<span id="cb2-24"><a href="#cb2-24" tabindex="-1"></a></span>
<span id="cb2-25"><a href="#cb2-25" tabindex="-1"></a>    <span class="co"># calculate pi and error</span></span>
<span id="cb2-26"><a href="#cb2-26" tabindex="-1"></a>    pi <span class="op">=</span> calc_pi(numtrials)</span>
<span id="cb2-27"><a href="#cb2-27" tabindex="-1"></a>    err <span class="op">=</span> <span class="fl">3.141592653589793</span> <span class="op">-</span> pi</span>
<span id="cb2-28"><a href="#cb2-28" tabindex="-1"></a></span>
<span id="cb2-29"><a href="#cb2-29" tabindex="-1"></a>    <span class="co"># print to terminal</span></span>
<span id="cb2-30"><a href="#cb2-30" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Result: </span><span class="sc">{</span>pi<span class="sc">}</span><span class="ss">, Error: </span><span class="sc">{</span>err<span class="sc">}</span><span class="ss">"</span>)</span></code></pre>
</div>
<p>Which you can run by</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="ex">python3</span> pi.py 123456789</span></code></pre>
</div>
<p>which calculates <span class="math inline">\(\pi\)</span> with
123,456,789 trials. The output should look similar to</p>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Result: 3.1416309393888415, Error: -3.8285799048409785e-05</code></pre>
</div>
<div id="submitting-this-script-to-slurm" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div id="submitting-this-script-to-slurm" class="callout-inner">
<h3 class="callout-title">Submitting this script to Slurm<a class="anchor" aria-label="anchor" href="#submitting-this-script-to-slurm"></a>
</h3>
<div class="callout-content">
<p>Instead of following the common pattern of writing a wrapper
submissions script, try submitting this Python script directly to
Slurm!</p>
<p>You will need to follow the Slurm error messages to convert this into
a working Slurm script.</p>
<p>Hint: you can use the system interpreter located in
<code>/usr/bin/python3</code>.</p>
<p>Once you have it working as a Slurm script, try adding
<code>#SBATCH</code> options like you would in a “normal” Slurm
script.</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1">Show me the solution</h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" aria-labelledby="headingSolution1" data-bs-parent="#accordionSolution1">
<div class="accordion-body">
<p>When submitting this script as-is with <code>sbatch pi.py</code>,
you’ll get the error:</p>
<div class="codewrapper">
<h3 class="code-label">ERROR<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="error" tabindex="0"><code>sbatch: error: This does not look like a batch script.  The first
sbatch: error: line must start with #! followed by the path to an interpreter.
sbatch: error: For instance: #!/bin/sh</code></pre>
</div>
<p>This is a reminder that your script needs to have a hash-bang
statement which specifies which the interpreter to use!</p>
<p>In this lesson, we’ve used <code>/bin/bash</code> all throughout,
although <code>/bin/sh</code> is also common to see “out in the wild”.
But in this case, we need to use a Python interpreter instead. We can
add to the top of the script: <code>#!/usr/bin/python3</code> which is
installed on Milton. Once we do that, our script should work!</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="ex">sbatch</span> pi.py 123456789</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Submitted batch job 12261934</code></pre>
</div>
<p>After about 40 seconds of the job running the corresponding
<code>slurm-12261934.out</code> file should be ready:</p>
<pre><code>Result: 3.1417136565895944, Error: -0.000121002999801334</code></pre>
<p>Which shows that it now works as a Slurm script!</p>
<p>This particular program doesn’t need much resources, but we can still
check that <code>#SBATCH</code> options still work with
<code>squeue</code>, <code>sacct</code>, or <code>seff</code>. If you
add <code>#SBATCH --cpus-per-task=4</code> below the hash-bang statement
and submit the script, you should see through your preferred query
command that the job is now requesting 4 CPUs.</p>
</div>
</div>
</div>
</div>
</section><section id="which-interpreter"><h2 class="section-heading">Which interpreter?<a class="anchor" aria-label="anchor" href="#which-interpreter"></a>
</h2>
<hr class="half-width"><p>In the above challenge, we used the system Python interpreter.
However, you often use Python from a virtual or conda environment; and R
from a module. Consequently, choosing the correct interpreter is
important so that your packages are picked up properly!</p>
<div class="section level3">
<h3 id="the-reproducible-way-but-less-portable">The reproducible way (but less portable)<a class="anchor" aria-label="anchor" href="#the-reproducible-way-but-less-portable"></a></h3>
<p>The <em>safest</em> way to ensure your preferred interpreter is used
is to hard-code the path into the hash-bang statement at the top of the
script.</p>
<p>For example, if you have an environment located at
<code>/vast/scratch/users/&lt;userid&gt;/mycondaenv</code>, the
corresponding interpreter is located in
<code>/vast/scratch/users/&lt;userid&gt;/mycondaenv/bin/python</code>,
which you can use in the hash-bang statement. Similarly, with
<code>Rscript</code>, you can find where your preferred
<code>Rscript</code> interepreter is by:</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="ex">module</span> show R/<span class="op">&lt;</span>preferred version<span class="op">&gt;</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>/stornext/System/data/apps/R/R-&lt;version&gt;/lib64/R/bin</code></pre>
</div>
<p>and you can add <code>Rscript</code> to the end of the path and place
it in the hash-bang statement e.g.,
<code>#!/stornext/System/data/apps/R/R-4.2.1/lib64/R/bin/Rscript</code>.
This way ensures the same interpreter are used every time</p>
</div>
<div class="section level3">
<h3 id="the-portable-way-but-less-reproducible">The portable way (but less reproducible)<a class="anchor" aria-label="anchor" href="#the-portable-way-but-less-reproducible"></a></h3>
<p>A common approach is to infer which interpreter to use based on your
environment. To do this, you can add the
<code>/usr/bin/env &lt;interpreter&gt;</code> command (note the space
between <code>/usr/bin/env</code> and <code>&lt;interpreter&gt;</code>).
For example, adding <code>#!/usr/bin/env python</code> as your hash-bang
statement will pickup whichever python interpreter is in your
environment.</p>
<p>This is more portable and often more convenient, but can be less
reproducible as you may forget which environment it was supposed to run
with, or which version of the interpreter was used.</p>
</div>
</section><section id="slurm-environment-variables"><h2 class="section-heading">Slurm Environment Variables<a class="anchor" aria-label="anchor" href="#slurm-environment-variables"></a>
</h2>
<hr class="half-width"><p>Both R and Python have their own ways of accessing environment
variables. For example, in Bash, saving the
<code>SLURM_CPUS_PER_TASK</code> environment variable is done by</p>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="va">cpus</span><span class="op">=</span><span class="va">${SLURM_CPUS_PER_TASK}</span></span></code></pre>
</div>
<p>Whereas, for Python and R, respectively:</p>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a>cpus <span class="op">=</span> os.getenv(<span class="st">"SLURM_CPUS_PER_TASK"</span>)</span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cpus</span> <span class="op">=</span> <span class="fu">Sys.getenv</span><span class="op">(</span><span class="st">"SLURM_CPUS_PER_TASK"</span><span class="op">)</span></span></code></pre>
</div>
</section><section id="setting-up-job-arrays"><h2 class="section-heading">Setting Up Job Arrays<a class="anchor" aria-label="anchor" href="#setting-up-job-arrays"></a>
</h2>
<hr class="half-width"><p>But a major advantage Python and R have over Bash is their ability to
parse text either natively or through installable packages</p>
<p>For example, let’s take our <code>iter-cpu.txt</code> file that we
created back in episode 4 (job arrays):</p>
<pre><code>iters cpus
100 2
100 4
1000 2
1000 4
10000 2
10000 4</code></pre>
<p>To read this file in Python, we can use the pandas module:</p>
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a>data <span class="op">=</span> pd.read_csv(<span class="st">'iter-cpu.txt'</span>, delimiter<span class="op">=</span><span class="st">' '</span>)</span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a><span class="bu">print</span>(data)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>   iters  cpus
0    100     2
1    100     4
2   1000     2
3   1000     4
4  10000     2
5  10000     4</code></pre>
</div>
<p>For R, it’s even easier:</p>
<div class="codewrapper sourceCode" id="cb17">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data</span> <span class="op">=</span> <span class="fu">read.csv</span><span class="op">(</span><span class="st">'iter-cpu.txt'</span>, sep<span class="op">=</span><span class="st">' '</span><span class="op">)</span></span>
<span><span class="fu">str</span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>'data.frame':   6 obs. of  2 variables:
 $ iters: int  100 100 1000 1000 10000 10000
 $ cpus : int  2 4 2 4 2 4</code></pre>
</div>
<div id="discussion2" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge<a class="anchor" aria-label="anchor" href="#discussion2"></a>
</h3>
<div class="callout-content">
<p>Now that you know how to turn a Python or R script into a Slurm
script. Try to create a Slurm array script in Python or R where:</p>
<ul><li>each array task reads the <code>iter-cpu.txt</code> file and</li>
<li>each array task prints a statement like:
<code>CPUs: &lt;n&gt;, Iterations: &lt;n&gt;</code>, where
<code>&lt;n&gt;</code> is the corresponding column and row of
<code>iter-cpu.txt</code>.</li>
</ul><p>For example, array task 0 should print out:</p>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>CPUs: 2, Iterations: 100</code></pre>
</div>
<p>HINT: you can make use of the
<code>#!/usr/bin/env python3 (or Rscript)</code> hash-bang statement for
convenience.</p>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2">Show me the solution</h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" aria-labelledby="headingSolution2" data-bs-parent="#accordionSolution2">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb20">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a><span class="co">#!/usr/bin/env python3</span></span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a><span class="co">#SBATCH --array=0-5</span></span>
<span id="cb20-3"><a href="#cb20-3" tabindex="-1"></a><span class="co">#SBATCH --mem=1G</span></span>
<span id="cb20-4"><a href="#cb20-4" tabindex="-1"></a></span>
<span id="cb20-5"><a href="#cb20-5" tabindex="-1"></a><span class="im">import</span> os, pandas <span class="im">as</span> pd</span>
<span id="cb20-6"><a href="#cb20-6" tabindex="-1"></a>data <span class="op">=</span> pd.read_csv(<span class="st">'iter-cpu.txt'</span>, delimiter<span class="op">=</span><span class="st">' '</span>)</span>
<span id="cb20-7"><a href="#cb20-7" tabindex="-1"></a></span>
<span id="cb20-8"><a href="#cb20-8" tabindex="-1"></a>taskid <span class="op">=</span> <span class="bu">int</span>(os.getenv(<span class="st">"SLURM_ARRAY_TASK_ID"</span>))</span>
<span id="cb20-9"><a href="#cb20-9" tabindex="-1"></a></span>
<span id="cb20-10"><a href="#cb20-10" tabindex="-1"></a>niter <span class="op">=</span> data[<span class="st">'iters'</span>].iloc[taskid]</span>
<span id="cb20-11"><a href="#cb20-11" tabindex="-1"></a>ncpus <span class="op">=</span> data[<span class="st">'cpus'</span>].iloc[taskid]</span>
<span id="cb20-12"><a href="#cb20-12" tabindex="-1"></a></span>
<span id="cb20-13"><a href="#cb20-13" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'CPUs: </span><span class="sc">{</span>ncpus<span class="sc">}</span><span class="ss">, Iterations: </span><span class="sc">{</span>niter<span class="sc">}</span><span class="ss">'</span>)</span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb21">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#!/usr/bin/env Rscript</span></span>
<span><span class="co">#SBATCH --array=1-6</span></span>
<span><span class="co">#SBATCH --mem=1G</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="fu">read.csv</span><span class="op">(</span><span class="st">'iter-cpu.txt'</span>, sep<span class="op">=</span><span class="st">' '</span><span class="op">)</span></span>
<span></span>
<span><span class="va">taskid</span> <span class="op">=</span> <span class="fu">as.integer</span><span class="op">(</span><span class="fu">Sys.getenv</span><span class="op">(</span><span class="st">"SLURM_ARRAY_TASK_ID"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ncpus</span> <span class="op">=</span> <span class="va">data</span><span class="op">[[</span><span class="st">"cpus"</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="va">taskid</span><span class="op">]</span></span>
<span><span class="va">niter</span> <span class="op">=</span> <span class="va">data</span><span class="op">[[</span><span class="st">"iters"</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="va">taskid</span><span class="op">]</span></span>
<span></span>
<span><span class="fu">paste0</span><span class="op">(</span><span class="st">"CPUs: "</span>, <span class="va">ncpus</span>,<span class="st">', Iterations: '</span>, <span class="va">niter</span><span class="op">)</span></span></code></pre>
</div>
<p>When using Slurm array jobs, remember to make use of appropriate
exception handling! With Python, you can make use of <code>try</code>,
<code>except</code>, and for R, you can check whether
<code>Sys.getenv("SLURM_ARRAY_TASK_ID")</code> returns
<code>NA</code>.</p>
</div>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul><li>Besides the code itself, the only <em>real</em> difference between a
bash Slurm script and a Python or R Slurm script, is the hash-bang
statement!</li>
<li>You can change the hash-bang statement to the <code>python</code> or
<code>Rscript</code> interpreter you wish to use, or you can make use of
<code>/usr/bin/env python</code> to determine which interpreter to use
from your environment.</li>
<li>When using Slurm environment variables in a Python or R script, the
same environment variables are available to you, but you must access
them in the Python/R way.</li>
<li>Using Python or R Slurm scripts means you can
<ol style="list-style-type: lower-alpha"><li>program in a language more familiar to you</li>
<li>make use of their broad functionality and packages</li>
<li>remove the need to have a wrapper Slurm script around your Python/R
scripts.</li>
</ol></li>
</ul></div>
</div>
</div>
<!-- 
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use. 
 -->
</section></div> <!-- / div.lesson-content -->
    </main><!-- / main#main-content.main-content --><nav class="bottom-pagination mx-md-4" aria-label="Previous and Next Chapter"><div class="d-block d-sm-block d-md-none">
        <a class="chapter-link" href="../instructor/05-jobdependencies.html"><i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>Previous</a>
        <a class="chapter-link float-end" href="../instructor/index.html">Next<i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i></a>
      </div>
      <!-- content for large screens -->
      <div class="d-none d-sm-none d-md-block">
        <a class="chapter-link" href="../instructor/05-jobdependencies.html" rel="prev">
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>
          Previous: Organising dependent
        </a>
        <a class="chapter-link float-end" href="../instructor/index.html" rel="next">
          Home
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i>
        </a>
      </div>
    </nav></div> <!-- / div.primary-content.col-xs-12 -->
<!-- END:   inst/pkgdown/templates/content-instructor.html-->

      </div><!--/div.row-->
      		<footer class="row footer mx-md-3"><hr><div class="col-md-6">
        <p>This lesson is subject to the <a href="CODE_OF_CONDUCT.html">Code of Conduct</a></p>
        <p>
        
        <a href="https://github.com/WEHI-ResearchComputing/intermediate-slurm/edit/main/episodes/06-rpython.Rmd" class="external-link">Edit on GitHub</a>
        
	
        | <a href="https://github.com/WEHI-ResearchComputing/intermediate-slurm/blob/main/CONTRIBUTING.md" class="external-link">Contributing</a>
        | <a href="https://github.com/WEHI-ResearchComputing/intermediate-slurm/" class="external-link">Source</a></p>
				<p><a href="https://github.com/WEHI-ResearchComputing/intermediate-slurm/blob/main/CITATION" class="external-link">Cite</a> | <a href="mailto:research.computing@wehi.edu.au">Contact</a> | <a href="https://carpentries.org/about/" class="external-link">About</a></p>
			</div>
			<div class="col-md-6">
        
        <p>Materials licensed under <a href="LICENSE.html">CC-BY 4.0</a> by the authors</p>
        
        <p>Template licensed under <a href="https://creativecommons.org/licenses/by-sa/4.0/" class="external-link">CC-BY 4.0</a> by <a href="https://carpentries.org/" class="external-link">The Carpentries</a></p>
        <p>Built with <a href="https://github.com/carpentries/sandpaper/tree/0.16.4" class="external-link">sandpaper (0.16.4)</a>, <a href="https://github.com/carpentries/pegboard/tree/0.7.5" class="external-link">pegboard (0.7.5)</a>, and <a href="https://github.com/carpentries/varnish/tree/1.0.2" class="external-link">varnish (1.0.2)</a></p>
			</div>
		</footer></div> <!-- / div.container -->
	<div id="to-top">
		<a href="#top">
      <i class="search-icon" data-feather="arrow-up" role="img" aria-label="Back To Top"></i><br><!-- <span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top --><span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top
		</a>
	</div>
  <script type="application/ld+json">
    {
  "@context": "https://schema.org",
  "@type": "TrainingMaterial",
  "@id": "https://WEHI-ResearchComputing.github.io/intermediate-slurm/instructor/06-rpython.html",
  "inLanguage": "en",
  "dct:conformsTo": "https://bioschemas.org/profiles/TrainingMaterial/1.0-RELEASE",
  "description": "A Carpentries Lesson teaching foundational data and coding skills to researchers worldwide",
  "keywords": "Slurm, HPC",
  "name": "R and Python Slurm scripts",
  "creativeWorkStatus": "active",
  "url": "https://WEHI-ResearchComputing.github.io/intermediate-slurm/instructor/06-rpython.html",
  "identifier": "https://WEHI-ResearchComputing.github.io/intermediate-slurm/instructor/06-rpython.html",
  "dateCreated": "2023-04-13",
  "dateModified": "2024-03-12",
  "datePublished": "2024-04-23"
}

  </script><script>
		feather.replace();
	</script><!-- Matomo
    2022-11-07: we have gotten a notification that we have an overage for our
    tracking and I'm pretty sure this has to do with Workbench usage.
    Considering that I am not _currently_ using this tracking because I do not
    yet know how to access the data, I am turning this off for now.
  <script>
    var _paq = window._paq = window._paq || [];
    /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
    _paq.push(["setDocumentTitle", document.domain + "/" + document.title]);
    _paq.push(["setDomains", ["*.preview.carpentries.org","*.datacarpentry.github.io","*.datacarpentry.org","*.librarycarpentry.github.io","*.librarycarpentry.org","*.swcarpentry.github.io", "*.carpentries.github.io"]]);
    _paq.push(["setDoNotTrack", true]);
    _paq.push(["disableCookies"]);
    _paq.push(['trackPageView']);
    _paq.push(['enableLinkTracking']);
    (function() {
          var u="https://carpentries.matomo.cloud/";
          _paq.push(['setTrackerUrl', u+'matomo.php']);
          _paq.push(['setSiteId', '1']);
          var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
          g.async=true; g.src='https://cdn.matomo.cloud/carpentries.matomo.cloud/matomo.js'; s.parentNode.insertBefore(g,s);
        })();
  </script>
  End Matomo Code --></body></html><!-- END:   inst/pkgdown/templates/layout.html-->

